<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>XRBC health</title>
<pre id="out">{"status":"initializing"}</pre>
<script>
(function(){
  const out = document.getElementById('out');
  const now = () => new Date().toISOString();
  const cfg = {
    proxy:"https://xrbitcoincash-github-io.onrender.com",
    ua:"/universal-ai.json",
    toml:"/.well-known/xrp-ledger.toml"
  };

  function write(obj){ try{ out.textContent = JSON.stringify(obj, null, 2); }catch(_){ out.textContent = String(obj); } }

  async function callXRPL(payload){
    const r = await fetch(cfg.proxy, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error("proxy HTTP "+r.status);
    const j = await r.json();
    if (j.error) throw new Error("xrpl "+JSON.stringify(j.error));
    return j;
  }
  async function getText(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(u+" HTTP "+r.status); return r.text(); }
  async function getJSON(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(u+" HTTP "+r.status); return r.json(); }

  // show that JS is running
  write({status:"running", updated_at: now()});

  window.addEventListener('DOMContentLoaded', async () => {
    try{
      const [stateP, uaP, tomlP] = await Promise.allSettled([
        callXRPL({method:"server_state",params:[]}),
        getJSON(cfg.ua),
        getText(cfg.toml)
      ]);

      const s = stateP.status==="fulfilled" ? (stateP.value.result?.state || {}) : null;
      const v = s?.validated_ledger || {};
      const peers = s?.peers ?? null;
      const server_state = s?.server_state ?? null;
      const hasValidated = typeof v?.seq === "number" || typeof v?.base_fee_xrp === "number";
      const ok = (server_state==="full" && (peers||0) >= 20) || hasValidated;

      write({
        project:"XRBitcoinCash",
        ok,
        server_state,
        peers,
        validated_seq: v?.seq ?? null,
        manifest_ok: uaP.status==="fulfilled",
        toml_ok: tomlP.status==="fulfilled",
        updated_at: now()
      });
    }catch(e){
      write({ ok:false, error:String(e.message||e), updated_at: now() });
      console.error(e);
    }
  });
})();
</script>
</html>
