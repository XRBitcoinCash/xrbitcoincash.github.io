<!DOCTYPE html>
<html lang="no" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XRBitcoinCash · Wallet Connect</title>
  <meta name="description" content="Connect Xaman/Xumm wallet to XRBitcoinCash for XRPL trading and liquidity." />
  <meta name="robots" content="index, follow" />
  <meta property="og:title" content="XRBitcoinCash · Wallet Connect" />
  <meta property="og:description" content="Connect your wallet to trade XRBC on XRPL." />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#0b1118" />
  <style>
    :root {
      --bg: #0b1118;
      --panel: #0f1722;
      --text: #e7eef8;
      --brand: #a7ff83;
    }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial;
      color: var(--text);
      background: var(--bg);
    }
    header.appbar {
      padding: 14px 18px;
      background: linear-gradient(180deg, rgba(11,17,24,0.92), rgba(11,17,24,0.6));
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(167,255,131,0.15);
    }
    .btn {
      border: 1px solid rgba(167,255,131,0.25);
      background: linear-gradient(180deg, var(--panel), #121c2a);
      color: var(--text);
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
    }
    .btn:hover {
      border-color: var(--brand);
    }
    #walletAddress {
      margin-left: 1rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }
    @keyframes glowPulse {
      from { box-shadow: 0 0 4px var(--accent); }
      to { box-shadow: 0 0 14px var(--accent); }
    }
    /* DEX styles */
    :root {
      --xrbc-bg: #0f1722;
      --xrbc-panel: #121827;
      --xrbc-text: #e7eef8;
      --xrbc-accent: #7ef09a;
      --xrbc-danger: #ff6b6b;
      --xrbc-muted: #98a2b3;
    }
    #xrbc-dex-container {
      max-width:900px;
      margin:28px auto;
      padding:18px;
      background: linear-gradient(180deg,var(--xrbc-panel), #0b1320);
      border-radius:14px;
      color:var(--xrbc-text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      box-shadow: 0 8px 30px rgba(3,8,14,0.6);
      border: 1px solid rgba(126,240,154,0.06);
    }
    #xrbc-dex-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    #xrbc-dex-header h2 { margin:0; color:var(--xrbc-accent); font-size:1.05rem; }
    #xrbc-dex-grid { display:grid; grid-template-columns: 1fr 320px; gap:18px; margin-top:14px; }
    #xrbc-orderbook-card, #xrbc-metrics-card { background: linear-gradient(180deg,#0b1220, #0f1726); border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.03); }
    #xrbc-orderbook { height:320px; overflow:auto; font-size:0.92rem; color:var(--xrbc-text); }
    .xrbc-row { display:flex; justify-content:space-between; padding:6px 8px; align-items:center; border-bottom:1px dashed rgba(255,255,255,0.01); }
    .xrbc-bid { color:#2ecc71; }
    .xrbc-ask { color:#ff6b6b; }
    #xrbc-order-form { background:transparent; display:flex; flex-direction:column; gap:10px; }
    #xrbc-order-form input, #xrbc-order-form select { padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--xrbc-text); }
    .xrbc-btn { padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
    .xrbc-btn-primary { background:linear-gradient(180deg,#2b7fff,#1f4fd6); color:white; }
    .xrbc-btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--xrbc-text); }
    #xrbc-status { font-size:0.92rem; color:var(--xrbc-muted); }
    .xrbc-small { font-size:0.86rem; color:var(--xrbc-muted); }
    @media (max-width:880px) { #xrbc-dex-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">
      <strong>XRBitcoinCash</strong> · Wallet Connect
    </div>
    <div class="actions">
      <button id="connectWalletButton" type="button" class="btn" disabled>Connect Wallet</button>
      <span id="walletAddress">Status: Ikke koblet</span>
    </div>
  </header>

  <header style="display: flex; align-items: center; padding: 12px 18px;">
    <a href="/index.html" style="display: flex; align-items: center; text-decoration: none;">
      <img src="/xrbc-nft.png" alt="XRBC Home" style="width: 44px; height: 44px; border-radius: 8px; animation: glowPulse 2.5s infinite alternate;" />
      <span style="margin-left: 12px; font-weight: 600; color: var(--ink);">Home</span>
    </a>
  </header>

  <main style="padding:20px;">
    <div id="xrbc-dex-root">
      <div id="xrbc-dex-container" aria-live="polite" role="region" aria-label="XRBC DEX module">
        <div id="xrbc-dex-header">
          <h2>XRBC DEX — Live orderbook & markets</h2>
          <div id="xrbc-header-actions" class="xrbc-small">
            <span id="xrbc-wallet-view">Wallet: <em id="xrbc-wallet-addr">Ikke koblet</em></span>
            <button id="xrbc-refresh-btn" class="xrbc-btn xrbc-btn-ghost" title="Oppdater markedsdata">Refresh</button>
          </div>
        </div>

        <div id="xrbc-dex-grid">
          <!-- LEFT: Orderbook + metrics -->
          <div>
            <div id="xrbc-orderbook-card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div>
                  <label for="xrbc-pair-select" class="xrbc-small">Pair</label>
                  <select id="xrbc-pair-select" style="margin-left:8px;padding:6px;border-radius:8px;">
                    <option value="XRBC/XRP">XRbitcoincash / XRP</option>
                  </select>
                </div>
                <div class="xrbc-small">Top 20 levels</div>
              </div>

              <div id="xrbc-orderbook" aria-live="polite">
                <div class="xrbc-row"><strong>Type</strong><strong>Pris</strong><strong>Amount</strong></div>
                <div class="xrbc-row"><em class="xrbc-small">Laster orderbook…</em></div>
              </div>
            </div>

            <div id="xrbc-metrics-card" style="margin-top:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong>Quick metrics</strong>
                <span class="xrbc-small">Snapshot</span>
              </div>

              <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap;">
                <div><div class="xrbc-small">Spread</div><div id="xrbc-metric-spread">—</div></div>
                <div><div class="xrbc-small">Best Bid</div><div id="xrbc-metric-bestbid">—</div></div>
                <div><div class="xrbc-small">Best Ask</div><div id="xrbc-metric-bestask">—</div></div>
                <div><div class="xrbc-small">Top Depth (bid/ask)</div><div id="xrbc-metric-depth">—</div></div>
              </div>
            </div>
          </div>

          <!-- RIGHT: Order form (Limit + Market) -->
          <aside>
            <div id="xrbc-order-form-card">
              <div id="xrbc-order-form" >
                <div>
                  <label class="xrbc-small" for="xrbc-order-mode">Order type</label>
                  <select id="xrbc-order-mode">
                    <option value="limit">Limit</option>
                    <option value="market">Market</option>
                  </select>
                </div>
                <div>
                  <label class="xrbc-small" for="xrbc-order-side">Side</label>
                  <select id="xrbc-order-side">
                    <option value="buy">Buy XRBC (spend XRP)</option>
                    <option value="sell">Sell XRBC (receive XRP)</option>
                  </select>
                </div>
                <div>
                  <label class="xrbc-small" for="xrbc-order-amount">Amount (XRBC)</label>
                  <input id="xrbc-order-amount" type="number" step="0.000001" min="0" placeholder="f.eks. 10">
                </div>
                <div id="xrbc-price-row">
                  <label class="xrbc-small" for="xrbc-order-price">Price (XRP per XRBC) — kun for Limit</label>
                  <input id="xrbc-order-price" type="number" step="0.000001" min="0" placeholder="pris per XRBC">
                </div>
                <div style="display:flex;gap:8px;">
                  <button id="xrbc-submit-order" class="xrbc-btn xrbc-btn-primary">Plasser ordre (Xumm)</button>
                  <button id="xrbc-calc-btn" class="xrbc-btn xrbc-btn-ghost" title="Beregn estimerte kostnader">Estimate</button>
                </div>
                <div id="xrbc-order-feedback" class="xrbc-small" style="margin-top:8px;color:var(--xrbc-muted);">Status: idle</div>
                <div id="xrbc-status" class="xrbc-small" style="margin-top:10px;">Node: <span id="xrbc-node-status">disconnecting…</span></div>
                <div class="xrbc-small" style="margin-top:6px;color:var(--xrbc-muted);">Rule: orders must be within ±0.25 XRP from mid-price (when mid-price is available).</div>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </main>

  <!-- === CONFIG PLACEHOLDER === -->
  <script type="application/json" id="app-config">
  {
    "xummApiKey": "2abde023-0df1-49a2-a4dc-86d776f6318d",
    "rpcEndpoint": "wss://s1.ripple.com/"
  }
  </script>

  <!-- External libs: Xumm + xrpl -->
  <script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
  <!-- Legg til xrpl.js CDN for node-tilgang -->
  <script src="https://unpkg.com/xrpl/dist/xrpl.min.js"></script>

<script>
(function(){
  'use strict';

  // --- Constants ---
  const XRBC_ISSUER = "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw";
  const XRBC_CODE = "XRbitcoincash";
  const DEFAULT_WSS = "wss://s1.ripple.com/";
  const MAX_LEVELS = 20;
  const MAX_SPREAD_ALLOWED = 0.25;

  // --- DOM References ---
  const pairSelect = document.getElementById('xrbc-pair-select');
  const orderbookEl = document.getElementById('xrbc-orderbook');
  const walletAddrEl = document.getElementById('xrbc-wallet-addr');
  const nodeStatusEl = document.getElementById('xrbc-node-status');
  const spreadEl = document.getElementById('xrbc-metric-spread');
  const bestBidEl = document.getElementById('xrbc-metric-bestbid');
  const bestAskEl = document.getElementById('xrbc-metric-bestask');
  const depthEl = document.getElementById('xrbc-metric-depth');
  const refreshBtn = document.getElementById('xrbc-refresh-btn');
  const submitBtn = document.getElementById('xrbc-submit-order');
  const calcBtn = document.getElementById('xrbc-calc-btn');
  const orderModeEl = document.getElementById('xrbc-order-mode');
  const orderSideEl = document.getElementById('xrbc-order-side');
  const orderAmountEl = document.getElementById('xrbc-order-amount');
  const orderPriceEl = document.getElementById('xrbc-order-price');
  const orderFeedbackEl = document.getElementById('xrbc-order-feedback');
  const connectWalletBtn = document.getElementById('connectWalletButton');
  const walletStatusSpan = document.getElementById('walletAddress');

  // --- Config ---
  let siteCfg = {};
  try {
    const c = document.getElementById('app-config');
    if (c) siteCfg = JSON.parse(c.textContent || '{}');
  } catch(e){ console.warn('app-config parse error', e); }

  // --- Runtime State ---
  let xrplClient = null;
  let xumm = null;
  let userAccount = null;
  let lastOrderbook = [];
  let bestBid = null, bestAsk = null;

  // --- Utilities ---
  function toDrops(xrp) {
    if (window.xrpl && typeof xrpl.xrpToDrops === 'function') return xrpl.xrpToDrops(String(xrp));
    return String(Math.round(Number(xrp) * 1_000_000));
  }
  function fromDrops(drops) {
    if (!drops) return 0;
    return Number(drops)/1_000_000;
  }

  // --- XRPL Client Manager ---
  const xrplManager = (() => {
    let client = null;

    async function connect(endpoint) {
      if (client && client.isConnected && client.isConnected()) return client;
      const wss = endpoint || siteCfg.rpcEndpoint || DEFAULT_WSS;
      try {
        client = new xrpl.Client(wss);
        await client.connect();
        nodeStatusEl.textContent = 'connected';
        console.log('XRPL connected at', wss);
        return client;
      } catch(err) {
        console.error('XRPL connection failed', err);
        nodeStatusEl.textContent = 'connection failed';
        client = null;
        return null;
      }
    }

    function getClient() { return client; }
    async function disconnect() {
      if (client && client.isConnected && client.isConnected()) {
        await client.disconnect();
        nodeStatusEl.textContent = 'disconnected';
        client = null;
      }
    }

    return { connect, disconnect, getClient };
  })();

  // --- Load orderbook ---
  async function loadOrderbook() {
    orderbookEl.innerHTML = "<div class='xrbc-row'><em>Loading orderbook…</em></div>";
    xrplClient = xrplManager.getClient();
    if (!xrplClient) {
      orderbookEl.innerHTML = "<div class='xrbc-row' style='color:var(--xrbc-danger)'>XRPL node not connected.</div>";
      return;
    }

    const req = {
      command: "book_offers",
      taker_gets: { currency: XRBC_CODE, issuer: XRBC_ISSUER },
      taker_pays: { currency: "XRP" },
      limit: MAX_LEVELS
    };

    try {
      const res = await xrplClient.request(req);
      const offers = (res && res.result && res.result.offers) ? res.result.offers : [];
      lastOrderbook = offers;
      renderOrderbook(offers);
      computeMetrics(offers);
    } catch (err) {
      console.error('book_offers error', err);
      orderbookEl.innerHTML = `<div class='xrbc-row' style='color:var(--xrbc-danger)'>Orderbook error: ${err.message || err}</div>`;
    }
  }

  function renderOrderbook(offers){
    if (!offers || !offers.length) {
      orderbookEl.innerHTML = "<div class='xrbc-row'><em>Ingen offers funnet</em></div>";
      bestBid = bestAsk = null;
      return;
    }

    const container = document.createElement('div');
    const head = document.createElement('div');
    head.className = 'xrbc-row';
    head.innerHTML = "<strong>Side</strong><strong>Pris</strong><strong>Amount</strong>";
    container.appendChild(head);

    offers.forEach(o => {
      const quality = o.quality ? parseFloat(o.quality) : null;
      let amount = '—';
      if (o.TakerGets && typeof o.TakerGets === 'object' && o.TakerGets.value) amount = parseFloat(o.TakerGets.value);
      else if (o.TakerGets) amount = fromDrops(o.TakerGets);

      let type = 'Buy';
      if (o.TakerGets && typeof o.TakerGets === 'object' && o.TakerGets.currency === XRBC_CODE) type = 'Sell';
      else if (o.Flags && (o.Flags & 0x00080000)) type = 'Sell';

      const row = document.createElement('div');
      row.className = 'xrbc-row';
      row.innerHTML = `<div class="${type==='Buy'?'xrbc-bid':'xrbc-ask'}">${type}</div><div>${quality ? Number(quality).toFixed(6) : '—'}</div><div>${amount}</div>`;
      container.appendChild(row);
    });

    orderbookEl.innerHTML = '';
    orderbookEl.appendChild(container);
  }

  function computeMetrics(offers){
    if (!offers || !offers.length) {
      spreadEl.textContent = '—';
      bestBidEl.textContent = '—';
      bestAskEl.textContent = '—';
      depthEl.textContent = '—';
      bestBid = bestAsk = null;
      return;
    }

    const asks = [], bids = [];
    offers.forEach(o => {
      const price = o.quality ? Number(o.quality) : null;
      let amount = 0;
      if (o.TakerGets && typeof o.TakerGets === 'object' && o.TakerGets.value) amount = Number(o.TakerGets.value);
      else if (o.TakerGets) amount = fromDrops(o.TakerGets);
      if (o.TakerGets && typeof o.TakerGets === 'object' && o.TakerGets.currency === XRBC_CODE) asks.push({price, amount});
      else bids.push({price, amount});
    });

    asks.sort((a,b)=>a.price - b.price);
    bids.sort((a,b)=>b.price - a.price);

    bestAsk = asks.length>0 ? asks[0].price : null;
    bestBid = bids.length>0 ? bids[0].price : null;

    bestAskEl.textContent = bestAsk ? bestAsk.toFixed(6) : '—';
    bestBidEl.textContent = bestBid ? bestBid.toFixed(6) : '—';
    spreadEl.textContent = (bestAsk && bestBid) ? (bestAsk - bestBid).toFixed(6) : '—';
    const topBids = bids.slice(0,5).reduce((s,x)=>s + (x.amount || 0),0);
    const topAsks = asks.slice(0,5).reduce((s,x)=>s + (x.amount || 0),0);
    depthEl.textContent = `${topBids.toFixed(6)} / ${topAsks.toFixed(6)}`;
  }

  // --- Xumm wallet ---
  async function initXumm() {
    const apiKey = siteCfg.xummApiKey || null;
    if (window.Xumm) xumm = new Xumm(apiKey);
    if (!xumm) {
      console.warn('Xumm SDK not loaded');
      connectWalletBtn.disabled = true;
      return;
    }
    connectWalletBtn.disabled = false;
  }

  connectWalletBtn.addEventListener('click', async ()=>{
    if (!xumm) return;
    if (connectWalletBtn.textContent.trim() === 'Disconnect') {
      await xumm.logout?.();
      userAccount = null;
      walletAddrEl.textContent = 'Ikke koblet';
      walletStatusSpan.textContent = '✅ Lommebok frakoblet';
      connectWalletBtn.textContent = 'Connect Wallet';
      return;
    }

    try {
      connectWalletBtn.disabled = true;
      walletStatusSpan.textContent = 'Connecting…';
      const auth = await xumm.authorize?.();
      if (auth?.account) {
        userAccount = auth.account;
        walletAddrEl.textContent = userAccount;
        walletStatusSpan.textContent = 'Connected: ' + userAccount;
        connectWalletBtn.textContent = 'Disconnect';
      }
    } catch(err) {
      console.error(err);
      walletStatusSpan.textContent = '⚠ Feil ved tilkobling';
    } finally {
      connectWalletBtn.disabled = false;
    }
  });

  // --- Event bindings ---
  refreshBtn.addEventListener('click', loadOrderbook);
  submitBtn.addEventListener('click', async ()=>{ /* Your order submission logic */ });
  calcBtn.addEventListener('click', ()=>{ /* Estimate logic */ });

  orderModeEl.addEventListener('change', ()=>{
    document.getElementById('xrbc-price-row').style.display = orderModeEl.value === 'limit' ? 'block' : 'none';
  });
  if (orderModeEl.value !== 'limit') document.getElementById('xrbc-price-row').style.display = 'none';

  // --- Kickoff ---
  (async ()=>{
    await initXumm();
    xrplClient = await xrplManager.connect();
    if (xrplClient) await loadOrderbook();
  })();

  // --- Debug API ---
  window.__xrbcDex = { loadOrderbook, lastOrderbook: ()=>lastOrderbook, bestBid: ()=>bestBid, bestAsk: ()=>bestAsk };

})();
</script>

</body>
</html>
