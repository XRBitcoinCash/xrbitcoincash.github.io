<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced XRPL DEX</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/xrpl@2.11.0/build/xrpl-latest-min.js"></script>
<script src="https://unpkg.com/xumm-sdk/dist/xumm.min.js"></script>

<style>
body { font-family: Arial,sans-serif; margin:0; background:#111; color:#fff; }
header { padding:1rem; background:#222; display:flex; justify-content:space-between; align-items:center; }
header h1 { margin:0; font-size:1.5rem; }
.container { display:grid; grid-template-columns:2fr 1fr; gap:1rem; padding:1rem; }
.orderbook, .order-form, .charts { background:#222; border-radius:10px; padding:1rem; }
.orderbook table { width:100%; border-collapse:collapse; }
.orderbook th, .orderbook td { padding:0.25rem 0.5rem; text-align:right; }
.bid { color:#0f0; font-weight:bold; }
.ask { color:#f00; font-weight:bold; }
button { padding:0.5rem 1rem; margin:0.25rem; border-radius:5px; border:none; cursor:pointer; }
button.connect { background:#09f; color:#fff; }
button.disconnect { background:#f09; color:#fff; }
.metrics { margin-top:1rem; }
.notification { position:fixed; bottom:1rem; right:1rem; padding:1rem; border-radius:10px; background:#333; display:none; }
@media(max-width:768px){ .container{grid-template-columns:1fr;} }
</style>
</head>
<body>

<header>
<h1>XRPL DEX</h1>
<div>
<button class="connect" id="connectWallet">Connect Wallet</button>
<button class="disconnect" id="disconnectWallet">Disconnect</button>
<span id="walletAddress"></span>
</div>
</header>

<div class="container">
<div class="orderbook">
<h2>Orderbook</h2>
<table id="orderbookTable">
<thead><tr><th>Price</th><th>Amount</th><th>Total</th></tr></thead>
<tbody></tbody>
</table>
<div class="metrics">
<p>Best Bid: <span id="bestBid">0</span></p>
<p>Best Ask: <span id="bestAsk">0</span></p>
<p>Spread: <span id="spread">0</span></p>
<p>Top Depth: <span id="topDepth">0</span></p>
</div>
</div>

<div class="order-form">
<h2>Place Order</h2>
<select id="pairSelect">
<option value="XRBC/XRP">XRBC/XRP</option>
<option value="USD/XRP">USD/XRP</option>
</select>
<div>
<label>Type:</label>
<select id="orderType">
<option value="limit">Limit</option>
<option value="market">Market</option>
</select>
</div>
<div>
<label>Amount:</label>
<input type="number" id="orderAmount" placeholder="Amount">
</div>
<div>
<label>Price:</label>
<input type="number" id="orderPrice" placeholder="Price">
</div>
<button id="submitOrder">Submit Order</button>
<p id="slippageInfo"></p>
</div>

<div class="charts">
<h2>Charts</h2>
<canvas id="candlestickChart"></canvas>
<canvas id="depthChart"></canvas>
</div>
</div>

<div class="notification" id="notification"></div>

<script>
const client = new xrpl.Client('wss://s.altnet.rippletest.net:51233');
client.connect().then(()=>console.log('XRPL connected'));

const xumm = new XummSdk({apiKey:"YOUR_XUMM_API_KEY",apiSecret:"YOUR_XUMM_API_SECRET"});
let wallet = null;

const orderbookTable = document.querySelector('#orderbookTable tbody');
const bestBidElem = document.getElementById('bestBid');
const bestAskElem = document.getElementById('bestAsk');
const spreadElem = document.getElementById('spread');
const topDepthElem = document.getElementById('topDepth');
const walletAddressElem = document.getElementById('walletAddress');
const notificationElem = document.getElementById('notification');

const candlestickCtx = document.getElementById('candlestickChart').getContext('2d');
const depthCtx = document.getElementById('depthChart').getContext('2d');
let candlestickChart, depthChart;

function notify(msg){ notificationElem.textContent=msg; notificationElem.style.display='block'; setTimeout(()=>notificationElem.style.display='none',3000); }

document.getElementById('connectWallet').onclick=async()=>{
try{
const payload=await xumm.payload.create({txjson:{TransactionType:"AccountSet",Account:"rXXXXXXXXXXXXXXXXXXXX"}});
window.open(payload.next.always,'_blank');
wallet={account:"rXXXXXXXXXXXXXXXXXXXX"};
walletAddressElem.textContent=wallet.account;
notify("Wallet connected");
}catch(e){console.error(e);notify("Wallet connection failed");}
};

document.getElementById('disconnectWallet').onclick=()=>{
wallet=null; walletAddressElem.textContent=''; notify("Wallet disconnected");
};

let currentPair='XRBC/XRP';
let ws=null;

async function updateOrderbook(){
if(ws) ws.close();
const [base,quote]=currentPair.split('/');
ws=new WebSocket('wss://s.altnet.rippletest.net:51233');
ws.onopen=()=>{ ws.send(JSON.stringify({command:"subscribe",id:"1",streams:["book"],books:[{taker_gets:{currency:quote},taker_pays:{currency:base},snapshot:true}]})) };
ws.onmessage=(event)=>{
const data=JSON.parse(event.data);
if(!data||!data.result||!data.result.offers) return;
renderOrderbook(data.result.offers);
};
}

function renderOrderbook(offers){
orderbookTable.innerHTML='';
let bestBid=0,bestAsk=0,topDepth=0;
offers.forEach(offer=>{
const tr=document.createElement('tr');
const price=parseFloat(offer.quality);
const amount=parseFloat(offer.taker_gets.value);
const total=price*amount;
tr.innerHTML=`<td class="${price>0?'bid':'ask'}">${price}</td><td>${amount}</td><td>${total}</td>`;
orderbookTable.appendChild(tr);
if(price>bestBid) bestBid=price;
if(!bestAsk||price<bestAsk) bestAsk=price;
topDepth+=amount;
});
bestBidElem.textContent=bestBid;
bestAskElem.textContent=bestAsk;
spreadElem.textContent=(bestAsk-bestBid).toFixed(6);
topDepthElem.textContent=topDepth;
updateCharts(offers);
}

function updateCharts(offers){
const labels=offers.map((o,i)=>i+1);
const bids=offers.map(o=>parseFloat(o.quality));
const asks=offers.map(o=>parseFloat(o.quality));
if(!candlestickChart) candlestickChart=new Chart(candlestickCtx,{type:'line',data:{labels,datasets:[{label:'Price',data:bids}]},options:{}});
else{ candlestickChart.data.datasets[0].data=bids; candlestickChart.update(); }
if(!depthChart) depthChart=new Chart(depthCtx,{type:'bar',data:{labels,datasets:[{label:'Depth',data:asks}]}});
else{ depthChart.data.datasets[0].data=asks; depthChart.update(); }
}

document.getElementById('pairSelect').onchange=(e)=>{ currentPair=e.target.value; updateOrderbook(); };

document.getElementById('submitOrder').onclick=async()=>{
if(!wallet) return notify("Connect wallet first");
const type=document.getElementById('orderType').value;
const amount=parseFloat(document.getElementById('orderAmount').value);
let price=parseFloat(document.getElementById('orderPrice').value);
const slippage=0.005; // simulate
document.getElementById('slippageInfo').textContent=`Estimated Slippage: ${(slippage*100).toFixed(2)}%`;

if(type==='market'){
const offers=Array.from(orderbookTable.rows).map(r=>({price:parseFloat(r.cells[0].textContent),amount:parseFloat(r.cells[1].textContent)}));
let remaining=amount; let totalPrice=0;
for(let o of offers){ if(remaining<=0) break; let tradeAmt=Math.min(o.amount,remaining); totalPrice+=tradeAmt*o.price; remaining-=tradeAmt; }
price=totalPrice/amount;
}

try{
const payload=await xumm.payload.create({txjson:{
TransactionType:"OfferCreate",
Account:wallet.account,
TakerGets:{currency:currentPair.split('/')[1],value:amount.toString()},
TakerPays:{currency:currentPair.split('/')[0],value:(price*amount).toFixed(6)}
}});
window.open(payload.next.always,'_blank');
notify(`Order submitted: ${amount} ${currentPair} @ ${price}`);
}catch(e){ console.error(e); notify("Order failed"); }
};

updateOrderbook();
</script>
</body>
</html>
