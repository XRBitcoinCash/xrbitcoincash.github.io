<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>XRBitcoinCash · Xaman Connectivity Diagnostics</title>
<link rel="icon" href="/xrbc-nft.png">
<style>
  :root { --bg:#0b1220; --fg:#e8eefc; --muted:#9fb0d8; --ok:#26c281; --bad:#ff6b6b; --warn:#ffb020; }
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
         background: var(--bg); color: var(--fg); margin:0; padding:24px; }
  .card { background: #0f1a33; border:1px solid #223259; border-radius:16px; padding:16px; margin-bottom:16px; box-shadow: 0 6px 20px rgba(0,0,0,.25);}
  h1 { margin: 0 0 12px; font-size: 20px; }
  .row { display:flex; gap:12px; flex-wrap: wrap; align-items: center; }
  input, button { padding:10px 12px; border-radius:10px; border:1px solid #2b3f6b; background:#0c1730; color:var(--fg); }
  button { cursor:pointer; }
  .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0a1429; border-radius:12px; padding:12px; 
         max-height:220px; overflow:auto; border:1px dashed #2b3f6b; }
  .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; }
  .ok { background: color-mix(in srgb, var(--ok) 20%, transparent); border:1px solid var(--ok);}
  .bad{ background: color-mix(in srgb, var(--bad)20%, transparent); border:1px solid var(--bad);}
  .warn{background: color-mix(in srgb, var(--warn)20%, transparent); border:1px solid var(--warn);}
  a { color:#a7c4ff; text-decoration: none; }
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="card">
    <h1>XRBitcoinCash · Xaman Connectivity Diagnostics</h1>
    <div class="row"><span class="pill warn">No keys required</span><span class="pill warn">Safe to host</span></div>
    <p class="muted">Paste a known-good Xaman payload UUID from the official widget and open it. If this works here, deep links are fine and the issue is payload creation (needs server-side).</p>
  </div>

  <div class="card">
    <h1>Step 1 — Browser/Environment</h1>
    <div class="log" id="env"></div>
  </div>

  <div class="card">
    <h1>Step 2 — Try a Deep Link (no API)</h1>
    <div class="row">
      <input id="uuid" placeholder="Paste a Xaman payload UUID" style="min-width:320px;" />
      <button id="open">Open https://xumm.app/sign/{uuid}</button>
      <button id="clear">Clear local pending</button>
    </div>
    <p class="muted">Tip: Use the same UUID the official Xaman widget produced (the one that worked).</p>
    <div class="log" id="out1"></div>
  </div>

  <div class="card">
    <h1>Step 3 — Popup / CSP quick checks</h1>
    <div class="row">
      <button id="pop">Test window.open()</button>
      <button id="img">Test loading xumm favicon</button>
      <button id="stor">Test localStorage</button>
    </div>
    <div class="log" id="out2"></div>
  </div>

<script>
(function(){
  const env = document.getElementById('env');
  const out1 = document.getElementById('out1');
  const out2 = document.getElementById('out2');
  const log = (el, msg) => { el.textContent += (msg + "\n"); el.scrollTop = el.scrollHeight; };

  // Step 1: environment dump
  try {
    log(env, "UserAgent: " + navigator.userAgent);
    log(env, "Platform: " + (navigator.platform || "(unknown)"));
    log(env, "Cookies enabled: " + navigator.cookieEnabled);
    log(env, "Referrer: " + (document.referrer || "(none)"));
  } catch(e) { log(env, "Env error: " + e.message); }

  // Step 2: deep-link open
  document.getElementById('open').onclick = () => {
    const uuid = document.getElementById('uuid').value.trim();
    if(!uuid){ log(out1, "✗ Enter a UUID first."); return; }
    const url = `https://xumm.app/sign/${uuid}`;
    try {
      window.open(url, "_blank", "noopener,noreferrer");
      log(out1, "↗ Opened: " + url);
    } catch(e){ log(out1, "✗ window.open failed: " + e.message); }
  };

  // Step 2b: clear any pending lock we may have created elsewhere
  document.getElementById('clear').onclick = () => {
    try { localStorage.removeItem("xumm:pendingPayload"); log(out1, "✓ Cleared local pending lock."); }
    catch(e){ log(out1, "✗ Clear error: " + e.message); }
  };

  // Step 3: popup/CSP tests
  document.getElementById('pop').onclick = () => {
    try {
      const w = window.open("about:blank", "_blank", "noopener,noreferrer");
      if (w && !w.closed){ w.close(); log(out2, "✓ Popup allowed."); }
      else { log(out2, "⚠ Popup likely blocked (enable popups for this site)."); }
    } catch(e){ log(out2, "✗ Popup test error: " + e.message); }
  };

  document.getElementById('img').onclick = () => {
    const img = new Image();
    img.onload = () => log(out2, "✓ Loaded https://xumm.app/favicon.ico (CSP not blocking <img>).");
    img.onerror = () => log(out2, "⚠ Could not load xumm favicon — check network/CSP.");
    img.src = "https://xumm.app/favicon.ico?ts=" + Date.now();
  };

  document.getElementById('stor').onclick = () => {
    try {
      const k = "diag:test:" + Date.now();
      localStorage.setItem(k, "1"); localStorage.removeItem(k);
      log(out2, "✓ localStorage OK.");
    } catch(e){ log(out2, "✗ localStorage error: " + e.message); }
  };
})();
</script>
</body>
</html>
