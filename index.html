
<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="utf-8" />
<title>Safely trade XRBC · XRBitcoinCash</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Canonical -->
<link rel="canonical" href="https://xrbitcoincash.com/trade.html" />
<link rel="alternate" hreflang="en" href="https://xrbitcoincash.com/trade.html" />

<!-- SEO -->
<meta name="description" content="Safely trade XRBC on the XRP Ledger. Connect Xaman (Xumm), place XRBC/XRP orders, read the order book, and view AMM pool info." />
<meta name="keywords" content="XRBitcoinCash, XRBC, XRP Ledger, XRPL, Xaman, Xumm, DEX, AMM, crypto trading, trustline" />
<meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />
<meta name="googlebot" content="index,follow" />
<meta name="theme-color" content="#0b0f14" />

<!-- Performance hints -->
<link rel="preconnect" href="https://xaman.app" crossorigin>
<link rel="preconnect" href="https://xumm.app" crossorigin>
<link rel="dns-prefetch" href="//s1.ripple.com">
<link rel="dns-prefetch" href="//s2.ripple.com">

<!-- Security (prefer real HTTP headers; these are fallbacks) -->
<meta http-equiv="Content-Security-Policy" content="
default-src 'self';
connect-src 'self' https://xaman.app https://xumm.app https://xrbitcoincash-github-io.onrender.com https://s1.ripple.com https://s2.ripple.com;
img-src 'self' data: https://api.qrserver.com https://xrbitcoincash.github.io https://xrbitcoincash.com;
script-src 'self' https://xaman.app 'unsafe-inline';
style-src 'self' 'unsafe-inline';
frame-ancestors 'none';
base-uri 'self';
form-action 'self';
upgrade-insecure-requests">
<meta name="referrer" content="strict-origin-when-cross-origin">
<meta http-equiv="X-Content-Type-Options" content="nosniff">

<!-- Favicons (Firefavicon) -->
<link rel="icon" href="/assets/favicons/firefavicon.ico?v=1" sizes="any">
<link rel="icon" type="image/png" href="/assets/favicons/firefavicon-32.png?v=1" sizes="32x32">
<link rel="icon" type="image/png" href="/assets/favicons/firefavicon-16.png?v=1" sizes="16x16">
<link rel="apple-touch-icon" href="/assets/favicons/firefavicon-180.png?v=1" sizes="180x180">
<link rel="icon" type="image/png" href="/assets/favicons/firefavicon-512.png?v=1" sizes="512x512" purpose="any">
<link rel="icon" type="image/png" href="/assets/favicons/firefavicon-512-maskable.png?v=1" sizes="512x512" purpose="maskable">
<link rel="manifest" href="/site.webmanifest?v=1">
<meta name="msapplication-TileColor" content="#0b0f14">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="XRBitcoinCash">
<meta property="og:title" content="Safely trade XRBC · XRBitcoinCash">
<meta property="og:description" content="Decentralized XRBC/XRP trading on the XRP Ledger with live order book and AMM helper.">
<meta property="og:url" content="https://xrbitcoincash.com/trade.html">
<meta property="og:image" content="https://xrbitcoincash.com/assets/social/firefavicon_1200.png">
<meta property="og:image:secure_url" content="https://xrbitcoincash.com/assets/social/firefavicon_1200.png">
<meta property="og:image:alt" content="XRBitcoinCash blue-flame logo">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="1200">
<meta property="og:locale" content="en_US">

<!-- Twitter / X -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Safely trade XRBC · XRBitcoinCash">
<meta name="twitter:description" content="Trade XRBC on XRPL. Connect your wallet, place orders, and view AMM pool info.">
<meta name="twitter:image" content="https://xrbitcoincash.com/assets/social/firefavicon_1200.png">
<meta name="twitter:image:alt" content="XRBitcoinCash blue-flame logo">

<!-- Sharing profile links (fill in if available) -->
<link rel="me" href="https://twitter.com/your_handle">
<link rel="me" href="https://t.me/your_channel">
<link rel="me" href="https://discord.gg/your_invite">
<link rel="me" href="https://github.com/xrbitcoincash">
<link rel="me" href="https://reddit.com/r/your_subreddit">

<!-- JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Safely trade XRBC · XRBitcoinCash",
  "url": "https://xrbitcoincash.com/trade.html",
  "description": "Safely trade XRBC on the XRP Ledger. Connect Xaman (Xumm), place XRBC/XRP orders, read the order book, and view AMM pool info.",
  "primaryImageOfPage": {
    "@type": "ImageObject",
    "url": "https://xrbitcoincash.com/assets/social/firefavicon_1200.png",
    "width": 1200,
    "height": 1200
  },
  "isPartOf": {
    "@type": "WebSite",
    "name": "XRBitcoinCash",
    "url": "https://xrbitcoincash.com/"
  },
  "about": {
    "@type": "Product",
    "name": "XRBitcoinCash (XRBC)",
    "category": "Cryptocurrency",
    "additionalProperty": [
      { "@type": "PropertyValue", "name": "issuer", "value": "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw" },
      { "@type": "PropertyValue", "name": "currency_hex", "value": "5852626974636F696E6361736800000000000000" },
      { "@type": "PropertyValue", "name": "network", "value": "XRP Ledger (XRPL)" }
    ]
  },
  "potentialAction": [{
    "@type": "BuyAction",
    "target": "https://xrbitcoincash.com/trade.html"
  }]
}
</script>

  <style>
/* =========================================
   XRBC — Uniform Site CSS (v2, exchange-style DEX)
   ========================================= */
:root{
  --wrap:980px; --wrap-wide:1080px;
  --bg:#0b0f14; --panel:#0e1520; --panel-2:#0c131c;
  --ink:#e7edf5; --muted:#9fb0c5;
  --accent:#60a5fa; --accent-2:#22d3ee; --ok:#22c55e; --err:#ef4444;
  --line:#2b3a4b; --shadow:0 10px 30px rgba(0,0,0,.35);
  --gap:14px; --gap-lg:24px;
  --hdr-blue-a: rgba(0,182,255,.22); --hdr-blue-b: rgba(0,182,255,.16);
}
*,*::before,*::after{ box-sizing:border-box; min-width:0; }
html{ scroll-behavior:smooth; }
html,body{ height:100%; max-width:100%; overflow-x:hidden; }
body{ background:var(--bg); color:var(--ink); font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; position:relative; }
img,svg{ max-width:100%; height:auto; display:block; }
.mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; overflow-wrap:anywhere; word-break:break-word; hyphens:auto; }
.nowrap{ white-space:nowrap; }

/* Header */
.site-header{
  position:sticky; top:0; z-index:20; width:100%;
  background:linear-gradient(180deg,#0b0f14,#0b1017);
  border-bottom:1px solid rgba(255,255,255,.06);
  backdrop-filter:saturate(140%) blur(6px);
  transition:transform .2s ease-out, background-color .2s ease-out;
  will-change:transform;
}
.header-wrap{ position:relative; max-width:var(--wrap); margin:0 auto;
  padding:12px max(16px, env(safe-area-inset-left)) 12px max(16px, env(safe-area-inset-right));
  display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px;
}
.header-wrap::after{
  content:""; position:absolute; inset:-8px -6px; pointer-events:none; z-index:0;
  background:
    radial-gradient(42% 100% at 10% 50%, var(--hdr-blue-a), transparent 60%),
    radial-gradient(28% 70% at 95% 25%, var(--hdr-blue-b), transparent 70%);
  filter:blur(8px); opacity:.9;
}
.brand{ display:flex; align-items:center; gap:10px; min-width:0; position:relative; z-index:1; }
.brand img{ width:40px; height:40px; border-radius:10px; object-fit:contain; background:#0e1520; border:1px solid var(--line); box-shadow:0 0 24px rgba(16,185,129,.24), 0 0 48px rgba(56,189,248,.18); }
.brand h1{ margin:0; font-size:clamp(.95rem, 2.5vw, 1.05rem); line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-shadow:0 0 10px rgba(0,182,255,.45), 0 0 18px rgba(0,182,255,.35); }
.header-center{ justify-self:center; position:relative; z-index:1; min-width:0; }
.header-right{ justify-self:end; display:flex; gap:8px; align-items:center; position:relative; z-index:1; min-width:0; }
.header-nav{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:center; }

/* Header nav pills */
.nav-pill{ position:relative; display:inline-flex; align-items:center; justify-content:center; gap:8px;
  min-height:48px; padding:10px 14px; border-radius:12px; font-weight:800; text-decoration:none; cursor:pointer;
  background:linear-gradient(180deg,#0e1520,#0c131c); color:var(--ink); border:1px solid var(--line); box-shadow:var(--shadow);
  transition:transform .08s ease, filter .2s ease, border-color .2s ease, box-shadow .2s ease;
  text-align:center; white-space:normal; overflow-wrap:anywhere;
}
.nav-pill:hover{ transform:translateY(-1px); filter:brightness(1.05); border-color:#324355; }
.nav-pill:focus-visible{ outline:2px solid var(--line); outline-offset:2px; }
.nav-pill::after{ content:""; position:absolute; inset:-10px; border-radius:16px; z-index:-1; filter:blur(12px); opacity:.65; transition:opacity .2s ease; }
.pill-ecosys::after{ background:radial-gradient(closest-side, rgba(255,255,255,.55), transparent 70%); }
.pill-whitepaper::after{ background:radial-gradient(closest-side, rgba(0,0,0,.65), transparent 70%); }

/* Theme toggle */
#themeToggle{
  appearance:none; border:1px solid var(--line); border-radius:10px;
  background:linear-gradient(180deg,#0e1520,#0c131c);
  color:#ffffff !important;
  text-shadow:0 0 8px rgba(255,255,255,.65), 0 0 16px rgba(96,165,250,.35);
  font-weight:800; line-height:1; padding:8px 12px;
  box-shadow:0 0 18px rgba(0,182,255,.35), var(--shadow);
  cursor:pointer; transition:filter .2s ease, border-color .2s ease, box-shadow .2s ease, transform .06s ease;
  white-space:nowrap;
}
#themeToggle:hover{ transform:translateY(-1px); filter:brightness(1.05); border-color:#324355; }

/* Containers */
.container{ max-width:var(--wrap); margin:12px auto 14px;
  padding-left:max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); position:relative; z-index:1; }

/* Cards / Buttons */
.card{ background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:var(--shadow); position:relative; z-index:1; }
.btn{
  appearance:none; border:1px solid var(--line); border-radius:12px;
  background:linear-gradient(180deg,#0e1520,#0c131c); color:var(--ink);
  padding:12px 16px; font-weight:700; line-height:1.2; text-decoration:none;
  display:inline-flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap;
  box-shadow:var(--shadow); transition:transform .06s ease, filter .2s ease, border-color .2s ease, box-shadow .2s ease;
  min-height:46px; font-size:clamp(.95rem, 3.2vw, 1.05rem); letter-spacing:.2px; text-align:center; overflow-wrap:anywhere;
}
.btn:hover{ transform:translateY(-1px); filter:brightness(1.05); border-color:#324355; }
.btn small{ display:block; font-size:.88em; opacity:.9; line-height:1.1; }
.btn::before{ content:none !important; }

/* DEX / Trade UI */
.trade-card{
  display:grid; gap:12px; text-align:left; padding:14px; border-radius:14px;
  background:linear-gradient(180deg,#0d141e,#0b1119);
  border:1px solid rgba(96,165,250,.25); position:relative;
}
.trade-card::before{
  content:""; position:absolute; inset:-1px; border-radius:14px;
  background:conic-gradient(from 180deg at 50% 50%, rgba(96,165,250,.35), rgba(34,211,238,.30), rgba(16,185,129,.25), rgba(96,165,250,.35));
  filter:blur(18px); opacity:.18; z-index:-1;
}

/* Tiny pair badge */
.trade-logo{ display:flex; align-items:center; justify-content:center; gap:8px; margin:2px 0 6px; text-align:center; flex-wrap:wrap; }
.trade-logo img{ width:20px; height:20px; border-radius:4px; object-fit:cover; border:1px solid var(--line); }
.trade-logo .pair{ font-weight:800; letter-spacing:.2px; font-size:14px; color:var(--ink); opacity:.95; }

/* Buy/Sell tabs */
.tabset{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px}
.tab{
  padding:10px 12px;border:1px solid var(--line);
  background:linear-gradient(180deg,#0e1520,#0c131c);border-radius:10px;
  font-weight:800;cursor:pointer;text-align:center;letter-spacing:.2px;font-size:1rem;
}
.tab.buy{color:#22c55e} .tab.sell{color:#ef4444}
.tab.buy.active{border-color:rgba(34,197,94,.55);box-shadow:0 0 0 2px rgba(34,197,94,.18) inset}
.tab.sell.active{border-color:rgba(239,68,68,.55);box-shadow:0 0 0 2px rgba(239,68,68,.18) inset}

/* Best Price */
.best-price-strip{ display:grid; grid-template-columns:1fr; gap:8px; margin-top:2px; padding:8px 10px; border:1px dashed var(--line); border-radius:10px; background:linear-gradient(180deg,#0b1119,#0a0f15); }
.best-price-btn{ width:100%; min-height:46px; font-weight:800; border:1px solid var(--line); border-radius:10px; background:linear-gradient(180deg,#0e1520,#0c131c); }
.best-price-strip .hint{ font-size:.9rem; color:var(--muted); overflow-wrap:anywhere; }

/* Fields */
.field{display:grid;gap:6px;margin-top:8px}
.field label{font-size:13px;color:var(--muted)}
.field input{
  width:100%;height:42px;padding:0 12px;border-radius:10px;border:1px solid var(--line);
  background:#0c131c;color:var(--ink); outline:none; font-size:14px;
}
.field input:focus{ border-color:rgba(96,165,250,.6); box-shadow:0 0 0 3px rgba(96,165,250,.20); }
.inline-hint{font-size:12px;color:var(--muted); overflow-wrap:anywhere;}
.amount-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.amount-row img{max-height:18px}

/* % chips */
.quick-amounts{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:6px; }
.qa{ height:34px; border:1px dashed var(--line); border-radius:8px; background:#0b1119; color:var(--ink); font-weight:700; font-size:12px; cursor:pointer; }

/* Total + submit row */
.total-line{ display:flex;align-items:center;justify-content:space-between;padding:10px 12px; border:1px dashed var(--line);border-radius:10px; background:linear-gradient(180deg,#0b1119,#0a0f15) }
.button-row{display:grid;grid-template-columns:1fr auto;gap:10px}
@media (max-width:600px){.button-row{grid-template-columns:1fr}}

/* Submit color mirrors side */
.btn-primary{ min-height:44px; font-weight:800; border:1px solid var(--line); border-radius:10px; background:linear-gradient(180deg,#0e1520,#0c131c); }
#tradeCard.buy .btn-primary{ border-color:rgba(34,197,94,.55); box-shadow:0 0 0 2px rgba(34,197,94,.18) inset; }
#tradeCard.sell .btn-primary{ border-color:rgba(239,68,68,.55); box-shadow:0 0 0 2px rgba(239,68,68,.18) inset; }

/* Auto-refresh indicator */
.refresh-indicator{display:flex;align-items:center;gap:8px;font-size:12px;color:#60a5fa;flex-wrap:wrap}
.clock{width:20px;height:20px;border:2px solid #60a5fa;border-radius:50%;position:relative;animation:spinHand 10s linear infinite}
.clock::after{content:"";position:absolute;top:2px;left:9px;width:2px;height:8px;background:#60a5fa;transform-origin:bottom center}
@keyframes spinHand{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* Status text & table */
.status-text{font-size:13px;color:var(--muted); overflow-wrap:anywhere;}
.status-text.ok{color:#22c55e} .status-text.err{color:#ef4444}
@keyframes flashText{from{opacity:1}to{opacity:.3}}
.status-text.connecting{animation:flashText 1.6s infinite alternate;color:#00e5ff !important;font-weight:700}
.table{width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed}
.table th,.table td{padding:8px 10px;border-bottom:1px solid #1a2433;word-break:break-word}
.table thead th{background:#0f1722;color:#cfe2ff;position:sticky;top:0;z-index:1}
@media (max-width:600px){ .table thead th{position:static} }

/* Footer */
.site-footer{ margin-top:24px; background:#0b0f14; color:#9fb0c5; border-top:1px solid rgba(255,255,255,.06); position:relative; z-index:1; }
.site-footer .wrap{ max-width:var(--wrap-wide); margin:0 auto; padding:16px max(16px, env(safe-area-inset-left)) 18px max(16px, env(safe-area-inset-right)); display:grid; gap:12px; }
.eco-link{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px; min-height:44px; width:auto; max-width:100%; border:1px solid var(--line); border-radius:12px; text-decoration:none; color:var(--ink); background:linear-gradient(180deg,#0e1520,#0c131c); box-shadow:var(--shadow); transition:transform .08s ease, filter .2s ease, border-color .2s ease; white-space:normal; overflow-wrap:anywhere; }
.eco-link:hover{ transform:translateY(-1px); filter:brightness(1.05); border-color:#324355; }
.eco-link img{ width:22px; height:22px; border-radius:6px; object-fit:cover; }

/* Light Mode */
body.light-mode{
  --bg:#ffffff; --panel:#ffffff; --panel-2:#ffffff; --ink:#0b0f14; --muted:#4b5565; --line:#000000;
  background:#ffffff; color:var(--ink);
}
body.light-mode .site-header{ background:rgba(255,255,255,.92); border-bottom:1px solid rgba(0,0,0,.08); backdrop-filter:saturate(120%) blur(6px); }
body.light-mode .header-wrap::after{ opacity:1; filter:blur(10px) brightness(1.18); }
body.light-mode .brand h1{ color:#0b0f14; text-shadow:0 0 12px rgba(0,122,255,.55), 0 0 24px rgba(0,122,255,.42); }
body.light-mode .card, body.light-mode .trade-card, body.light-mode .btn, body.light-mode .eco-link, body.light-mode .nav-pill{
  background:#ffffff !important; color:var(--ink) !important; border-color:var(--line) !important; box-shadow:none !important;
}
body.light-mode .pill-whitepaper::after{ opacity:.75; }

/* Chips */
.asset-chip{ display:inline-flex; align-items:center; gap:6px; font-weight:800; line-height:1; font-size:1em; padding:3px 8px; border-radius:9999px; border:1px solid var(--line); background:linear-gradient(180deg,#0b1119,#0a0f15); vertical-align:baseline; white-space:nowrap; }
.asset-chip img{ width:1em; height:1em; border-radius:3px; object-fit:cover; display:inline-block; border:1px solid var(--line); }
.asset-xrp{ color:#22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.18) inset, 0 0 22px rgba(34,197,94,.25); border-color:rgba(34,197,94,.55); }
.asset-xrbc{ color:#60a5fa; box-shadow:0 0 0 2px rgba(96,165,250,.18) inset, 0 0 22px rgba(96,165,250,.25); border-color:rgba(96,165,250,.55); }
body.light-mode .asset-chip{ background:#fff; border-color:#000; box-shadow:none; }
body.light-mode .asset-xrp{ color:#15803d; border-color:#000; box-shadow:0 0 20px rgba(34,197,94,.25); }
body.light-mode .asset-xrbc{ color:#0b6bdc; border-color:#000; box-shadow:0 0 20px rgba(96,165,250,.25); }
.asset-xrp img { background:#fff; }

/* Buy/Sell explainer */
.side-explain { margin-top:6px; }
.side-explain .note{ display:block; padding:10px 12px; margin-top:6px; border:1px dashed var(--line); border-radius:10px; background:linear-gradient(180deg,#0b1119,#0a0f15); color:var(--muted); transition:box-shadow .2s ease, border-color .2s ease, color .2s ease; }
.side-explain .note .copy strong{ color:var(--ink); }
.side-explain .note.buy.active{ border-color:rgba(34,197,94,.65); box-shadow:0 0 0 2px rgba(34,197,94,.25) inset, 0 0 18px rgba(34,197,94,.18); color:#b7f7cc; }
.side-explain .note.sell.active{ border-color:rgba(239,68,68,.65); box-shadow:0 0 0 2px rgba(239,68,68,.25) inset, 0 0 18px rgba(239,68,68,.18); color:#fecaca; }
body.light-mode .side-explain .note{ background:#fff; color:#2c3644; border-color:#000; }

/* Wallet card + glows */
.wallet-card { position:relative; overflow:hidden; }
.wallet-card::before{
  content:""; position:absolute; inset:-1px; border-radius:14px;
  background:
    radial-gradient(44% 60% at 20% 20%, rgba(96,165,250,.20), transparent 60%),
    radial-gradient(44% 60% at 80% 80%, rgba(34,211,238,.16), transparent 60%);
  filter:blur(18px); opacity:.25; z-index:0;
}
.btn.glow { position:relative; z-index:1; }
.btn.glow::after{ content:""; position:absolute; inset:-8px; border-radius:14px; filter:blur(12px); z-index:-1; opacity:.7; animation:btnFlicker 2.2s infinite ease-in-out; }
.btn.glow-white::after{  background: radial-gradient(closest-side, rgba(255,255,255,.85),  transparent 70%); animation-duration:1.8s; }
.btn.glow-yellow::after{ background: radial-gradient(closest-side, rgba(234,179,8,.70),  transparent 70%); animation-duration:2.1s; }
.btn.glow-red::after{    background: radial-gradient(closest-side, rgba(239,68,68,.70),  transparent 70%); animation-duration:2.6s; }
.btn.glow-green::after{  background: radial-gradient(closest-side, rgba(34,197,94,.75),  transparent 70%); animation-duration:1.9s; }
@keyframes btnFlicker{ 0%{opacity:.55;transform:translateY(0)}45%{opacity:.20;transform:translateY(.5px)}55%{opacity:.35}100%{opacity:.60} }

/* Download popover (inline) */
.dl-wrap{ display:flex; flex-direction:column; align-items:center; }
.qr-popover{ position:static !important; display:block; width:100%; max-width:260px; border-radius:12px; background:#ffffff; color:#0b0f14; border:1px solid #000; box-shadow:0 10px 30px rgba(0,0,0,.22); padding:10px; margin-top:10px; }
.qr-popover .label{ font-weight:800; font-size:12px; text-align:center; margin-top:8px; }
.qr-popover.collapse{ overflow:hidden; max-height:0; opacity:0; margin-top:0; transition:max-height .28s ease, opacity .28s ease, margin-top .28s ease; }
.qr-popover.collapse.open{ max-height:360px; opacity:1; margin-top:10px; }
body:not(.light-mode) .qr-popover{ background:#0e1520; color:#e7edf5; border:1px solid #2b3a4b; box-shadow:0 10px 30px rgba(0,0,0,.35); }
.qr-popover[hidden]{ display:none !important; }

/* Mobile */
@media (max-width:560px){
  html{ font-size:13px; }
  .header-wrap{ grid-template-columns:minmax(0,1fr) minmax(0,1fr); grid-auto-rows:minmax(0,auto); padding:8px max(16px, env(safe-area-inset-left)) 8px max(16px, env(safe-area-inset-right)); column-gap:8px; }
  .brand{ grid-column:1 / -1; grid-row:1; justify-self:center; text-align:center; }
  .header-center{ grid-column:1 / -1; grid-row:2; justify-self:center; }
  .header-right{ grid-column:1 / -1; grid-row:3; justify-self:center; }
  .header-nav .nav-pill{ width:100%; min-height:42px; padding:8px 10px; font-size:.95rem; }
  .container{ padding-left:max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); }
  .button-row{ grid-template-columns:1fr; }
  .asset-chip{ font-size:.95em; }
}

/* Reduced Motion */
@media (prefers-reduced-motion:reduce){ *{ transition:none !important; animation:none !important; } }

/* Light-mode fixes scoped to trade card */
body.light-mode #tradeCard{ background: transparent !important; color: var(--ink) !important; border-color: var(--line) !important; box-shadow: none !important; }
body.light-mode #tradeCard .field input,
body.light-mode #tradeCard .tab,
body.light-mode #tradeCard .qa,
body.light-mode #tradeCard .best-price-btn,
body.light-mode #tradeCard .best-price-strip,
body.light-mode #tradeCard .total-line,
body.light-mode #tradeCard .btn-primary { background: transparent !important; color: var(--ink) !important; border-color: var(--line) !important; box-shadow: none !important; }
body.light-mode #tradeCard .field input::placeholder { color: var(--muted) !important; }
body.light-mode #tradeCard .field label { color: var(--muted) !important; }
body.light-mode #tradeCard .inline-hint,
body.light-mode #tradeCard .best-price-strip .hint,
body.light-mode #tradeCard .status-text { color: var(--muted) !important; }
body.light-mode #tradeCard .status-text.ok  { color: #16a34a !important; }
body.light-mode #tradeCard .status-text.err { color: #dc2626 !important; }
body.light-mode #tradeCard .status-text.connecting { color: #0ea5e9 !important; }
body.light-mode #tradeCard .table thead th{ background: #f3f4f6 !important; color: #111827 !important; border-bottom-color: var(--line) !important; }
body.light-mode #tradeCard .table td{ color: var(--ink) !important; border-bottom-color: #e5e7eb !important; }
body.light-mode #tradeCard .side-explain .note { color: #2c3644 !important; }
body.light-mode #tradeCard .tab.buy.active, body.light-mode #tradeCard .tab.sell.active { background: transparent !important; box-shadow: none !important; }
body.light-mode #tradeCard .asset-chip { background: #fff !important; color: var(--ink) !important; }

/* Make long JSON and code mobile-friendly */
#ledgerOutput, pre, code{ white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; }

/* CSS-only header auto-hide via scroll-driven animation (progressive) */
@keyframes headerHide { to { transform:translateY(-100%); } }
@supports (animation-timeline: scroll()) {
  .site-header{
    animation: headerHide linear both;
    animation-timeline: scroll(root);
    animation-range: 0 160px;
  }
}
  </style>
</head>
<body>

 <!-- ===== Header ===== -->
<header class="site-header">
  <div class="header-wrap">
    <div class="brand">
      <img src="/xrbc-nft.png" alt="XRBitcoinCash (XRBC) logo" decoding="async" loading="eager" fetchpriority="high">
      <h1>XRBitcoinCash</h1>
    </div>

    <nav class="header-center" role="navigation" aria-label="Primary">
      <div class="header-nav">
        <a class="nav-pill pill-ecosys" href="/xrbc-ecosystem.html" title="XRBC Ecosystem · DEX/AMM">XRBC Ecosystem · DEX/AMM</a>
        <a class="nav-pill pill-extract" href="https://xrbitcoincash.com/limit-order-extraction.html" title="Instant Limit Order Extraction" rel="noopener">Limit Order Extraction</a>
        <a class="nav-pill pill-whitepaper" href="/whitepaper.html" title="XRBC White Paper">White Paper</a>
      </div>
    </nav>

    <div class="header-right">
      <button id="themeToggle" type="button" aria-pressed="false" aria-label="Toggle light/dark">Light/Dark</button>
    </div>
  </div>
</header>

  <!-- ===== Main ===== -->
  <main class="container" style="max-width:800px;text-align:center;">

    <h1 style="margin:12px 0 8px; line-height:1.1; letter-spacing:.2px;">
      XRBC · Decentralized Trading (XRPL via Xaman)
    </h1>

    <!-- DEX / xApp quick entries -->
    <div style="margin-top:12px">
      <div style="display:flex;align-items:center;gap:8px;
                  padding:8px 12px;border:1px solid #064e3b;border-left:4px solid #10b981;
                  border-radius:10px;background:linear-gradient(180deg,#052b1f,#073425);
                  color:#d1fae5;font-size:14px;font-weight:700;letter-spacing:.2px;margin-bottom:10px;justify-content:center">
        <span>Open in Xaman — DEX & Swaps (mobile opens app • desktop shows QR)</span>
      </div>

      <a href="https://xumm.app/detect/xapp:xumm.dex" rel="noopener noreferrer"
         class="btn" style="width:100%;max-width:520px;margin:0 auto 10px;border-left:4px solid #10b981;">
        <img src="/xrbc-nft.png" alt="XRBC" width="20" height="20" style="display:inline-block;border-radius:4px" decoding="async" loading="lazy" />
        <span>Open in Xaman — Trade XRBC ↔ XRP (DEX)</span>
        <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" width="20" height="20" style="display:inline-block" decoding="async" loading="lazy" />
      </a>

      <a href="https://xumm.app/detect/xapp:anodos.swap" rel="noopener noreferrer"
         class="btn" style="width:100%;max-width:520px;margin:0 auto 10px;border-left:4px solid #38bdf8;">
        <img src="/xrbc-nft.png" alt="XRBC" width="20" height="20" style="display:inline-block;border-radius:4px" decoding="async" loading="lazy" />
        <span>Open in Xaman — ANODOS Swap (XRBC ↔ XRP)</span>
        <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" width="20" height="20" style="display:inline-block" decoding="async" loading="lazy" />
      </a>

      <a href="https://xumm.app/detect/xapp:magnetic.dex" rel="noopener noreferrer"
         class="btn" style="width:100%;max-width:520px;margin:0 auto 10px;border-left:4px solid #1e3a8a;">
        <img src="/xrbc-nft.png" alt="XRBC" width="20" height="20" style="display:inline-block;border-radius:4px" decoding="async" loading="lazy" />
        <span>Open in Xaman — Magnetic (XRBC ↔ XRP)</span>
        <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" width="20" height="20" style="display:inline-block" decoding="async" loading="lazy" />
      </a>

      <div class="fine" style="margin-top:8px;color:#93a3af;font-size:12px;line-height:1.4;">
        Notes: Anodos and Magnetic open as xApps in Xaman. Pair deep-linking to XRBC/XRP isn’t publicly documented by providers; you may need to select the pair in-app.
        “XRP” and the XRP logo are trademarks of Ripple Labs, Inc. “Xaman (Xumm)” is a product of XRPL Labs. No affiliation or endorsement implied.
      </div>
    </div>

    <!-- Wallet card -->
    <div class="card wallet-card" style="margin:16px 0 20px;">
      <h2 class="wallet-title">
        <img src="/xrbc-nft.png" alt="XRBC logo" width="22" height="22" decoding="async" loading="lazy">
        <span>Connect wallet to the XRBC decentralized exchange</span>
      </h2>

      <div class="wallet-actions" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:10px 0 12px;">
        <div class="dl-wrap">
          <button id="btnDownloadXaman" class="btn glow glow-white" aria-expanded="false" type="button">
            Download Xaman
          </button>
          <div id="downloadPopover" class="qr-popover collapse" role="region"
               aria-label="Download Xaman QR" aria-hidden="true" hidden>
            <div class="qr">
              <img id="downloadQr" alt="Scan to download Xaman" width="180" height="180" decoding="async" loading="eager">
            </div>
            <div class="label">Scan to download Xaman Wallet</div>
          </div>
       </div>

        <button id="connectWalletBtn" class="btn glow glow-green" type="button">Connect Wallet</button>
        <button id="setTrustlineBtn" class="btn glow glow-yellow" type="button">Set XRBC Trustline</button>
        <button id="disconnectWalletBtn" class="btn glow glow-red" type="button" disabled>Disconnect</button>
      </div>

      <p id="walletStatus" class="status-text">Status: Not connected</p>
      <div id="trustlineMsg" class="status-text" style="margin-top:8px;"></div>
    </div>

    <!-- ===== Trading UI (exchange style) ===== -->
    <section class="trade-card" id="tradeCard" aria-label="XRBC Trading">

      <!-- Tiny pair badge -->
      <div class="trade-logo" style="gap:10px;">
        <span class="asset-chip asset-xrbc">
          <img src="/xrbc-nft.png" alt="XRBC"> XRBC
        </span>
        <span class="nowrap">/</span>
        <span class="asset-chip asset-xrp">
          <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP"> XRP
        </span>
      </div>

      <!-- BUY/SELL -->
      <div class="tabset" role="tablist" aria-label="Choose buy or sell">
        <button id="buyTab" class="tab buy active" type="button" role="tab" aria-selected="true">Buy XRBC</button>
        <button id="sellTab" class="tab sell" type="button" role="tab" aria-selected="false">Sell XRBC</button>
      </div>

      <!-- Side explanation -->
      <div class="side-explain" id="sideExplain" aria-live="polite">
        <div class="note buy active" data-side="buy">
          <span class="copy">
            <strong>Buying XRBC:</strong>
            You’re trading
            <span class="asset-chip asset-xrp">
              <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP
            </span>
            to receive
            <span class="asset-chip asset-xrbc">
              <img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC
            </span>.
          </span>
        </div>

        <div class="note sell" data-side="sell" hidden>
          <span class="copy">
            <strong>Selling XRBC:</strong>
            You’re trading
            <span class="asset-chip asset-xrbc">
              <img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC
            </span>
            to receive
            <span class="asset-chip asset-xrp">
              <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP
            </span>.
          </span>
        </div>
      </div>

      <!-- AMOUNT -->
      <div class="field">
        <label for="amount" id="amountLabel">Amount (XRBC)</label>
        <div class="amount-row">
          <img src="/xrbc-nft.png" alt="XRBC logo" decoding="async" loading="lazy">
          <input id="amount" type="number" step="0.000001" inputmode="decimal" placeholder="0.000000">
        </div>

        <div class="quick-amounts" role="group" aria-label="Quick amount">
          <button class="qa" data-q="25" type="button">25%</button>
          <button class="qa" data-q="50" type="button">50%</button>
          <button class="qa" data-q="75" type="button">75%</button>
          <button class="qa" data-q="100" type="button">100%</button>
        </div>

        <div class="inline-hint" id="amountHint" style="margin-top:6px">
          How many XRBC you want to <span id="actionWord">buy</span>.
          <span class="nowrap">You’re trading
            <span class="asset-chip asset-xrp">
              <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP
            </span>
            to receive
            <span class="asset-chip asset-xrbc">
              <img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC
            </span>.
          </span>
        </div>
      </div>

      <!-- Best Price -->
      <div class="best-price-strip" style="margin-top:10px">
        <button class="btn best-price-btn" id="suggestPriceBtn" type="button">Best Price (AMM)</button>
        <div class="hint">Auto-updates every 10s after you enter an <strong>Amount</strong>.</div>
      </div>

      <!-- PRICE (Limit) -->
      <div class="field" id="priceField">
        <label for="price">Price (XRP per XRBC)</label>
        <input id="price" type="number" step="0.000001" inputmode="decimal" placeholder="e.g., 0.500000">
        <div class="inline-hint">Limit price. (Use Best Price to estimate from AMM.)</div>
      </div>

      <!-- TOTAL -->
      <div class="total-line" aria-live="polite">
        <span>Total</span>
        <strong id="totalXrp">0.000000 XRP</strong>
      </div>

      <!-- Submit -->
      <div class="button-row">
        <button id="placeOfferBtn" class="btn btn-primary" type="button">Place Limit Order</button>

        <div class="refresh-indicator" aria-hidden="true">
          <div class="clock"></div>
          <span class="refresh-text">Auto-refresh every 10s</span>
        </div>

        <!-- New market trade button (IOC) -->
        <button id="marketTradeBtn" class="btn btn-primary" type="button">Market Swap (AMM)</button>
      </div>

      <p id="tradeMsg" class="status-text">—</p>

      <select id="side" hidden>
        <option value="buy" selected>Buy</option>
        <option value="sell">Sell</option>
      </select>
      <input id="orderType" type="hidden" value="limit">
    </section>

    <!-- ===== XRBC DEX — Live Metrics (compact) ===== -->
    <section class="card compact-metrics" id="xrbcDexHero" aria-label="XRBC DEX — Live Metrics">
      <div class="metrics-header">
        <h2>
          <img src="/xrbc-nft.png" alt="XRBC" width="24" height="24" style="border-radius:6px;border:1px solid var(--line)" decoding="async" loading="lazy">
          XRBC DEX — Live Metrics
        </h2>
      </div>

      <div class="metrics-grid">
        <div class="metrics-block">
          <h3>XRBC/XRP Order Book</h3>
          <div id="priceOutput" class="book-compact">—</div>
        </div>
        <div class="metrics-block">
          <h3>Ledger</h3>
          <pre id="ledgerOutput" class="ledger-compact">—</pre>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Config ===== -->
  <script type="application/json" id="app-config">
  {
    "xummApiKey": "2abde023-0df1-49a2-a4dc-86d776f6318d",
    "proxyUrl": "https://xrbitcoincash-github-io.onrender.com"
  }
  </script>

  <!-- Xaman SDK -->
  <script src="https://xaman.app/assets/cdn/xumm.min.js" crossorigin="anonymous"></script>

  <!-- ===== Page Script ===== -->
  <script>
(function(){
  /* ===== Utilities / Config ===== */
  const cfgNode = document.getElementById("app-config");
  const cfg = cfgNode ? JSON.parse(cfgNode.textContent || "{}") : {};
  const PROXY_URL = cfg.proxyUrl || "";
  const XRP_TO_DROPS = 1_000_000;

  const XRBC = {
    currency: "5852626974636F696E6361736800000000000000",
    issuer:   "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw"
  };

  // Safe string HTML escaper for UI injection points
  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Integer-safe XRP->drops converters
  function toDropsExact(xrpStr){
    const s = String(xrpStr ?? "").trim();
    const m = s.match(/^(\d+)(?:\.(\d{1,6}))?$/);
    if(!m) throw new Error("Invalid XRP amount");
    const whole = BigInt(m[1]);
    const frac  = BigInt((m[2]||"").padEnd(6,"0"));
    return (whole*1000000n + frac).toString();
  }
  function floorDropsFromXrp(xrpStr){
    const s = String(xrpStr ?? "").trim();
    const m = s.match(/^(\d+)(?:\.(\d+))?$/);
    if(!m) throw new Error("Invalid XRP amount");
    const head = (m[2]||"").slice(0,6).padEnd(6,"0");
    return (BigInt(m[1])*1000000n + BigInt(head)).toString();
  }
  function ceilDropsFromXrp(xrpStr){
    const s = String(xrpStr ?? "").trim();
    const m = s.match(/^(\d+)(?:\.(\d+))?$/);
    if(!m) throw new Error("Invalid XRP amount");
    const head = (m[2]||"");
    if(head.length <= 6) return toDropsExact(s);
    const keep = head.slice(0,6);
    const rest = head.slice(6);
    let drops = BigInt(m[1])*1000000n + BigInt(keep);
    if(/[1-9]/.test(rest)) drops += 1n;
    return drops.toString();
  }
  // Clamp number-like to 6dp string
  const clamp6 = v => {
    const n = Math.max(0, Number(v||0));
    if(!isFinite(n)) return "0.000000";
    return (Math.floor(n*1e6)/1e6).toFixed(6);
  };

  async function xrplRequest(payload){
    if (!PROXY_URL) throw new Error("Proxy URL missing");
    const res = await fetch(PROXY_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("Proxy HTTP " + res.status);
    const data = await res.json();
    if (data && data.error) throw new Error("XRPL: " + JSON.stringify(data.error));
    return data;
  }

  /* ===== Theme toggle ===== */
  (function themeInit(){
    const btn = document.getElementById('themeToggle');
    const saved = localStorage.getItem('xrbc-theme');
    if (saved === 'light') document.body.classList.add('light-mode');
    const sync = () => btn && btn.setAttribute('aria-pressed', document.body.classList.contains('light-mode') ? 'true' : 'false');
    sync();
    if (btn){
      btn.addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('xrbc-theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        sync();
      });
    }
  })();

  /* ===== Download Xaman popover ===== */
  (function initDownloadPopover(){
    const wrap = document.querySelector(".dl-wrap");
    if (!wrap) return;

    const DOWNLOAD_URL = "https://xaman.app/download";
    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

    const downloadBtn = document.getElementById("btnDownloadXaman");
    const pop = document.getElementById("downloadPopover");
    const qrImg = document.getElementById("downloadQr");

    if (!downloadBtn || !pop) return;

    if (qrImg && !qrImg.src){
      qrImg.src = "https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=" + encodeURIComponent(DOWNLOAD_URL);
    }

    function openPopover(){
      pop.hidden = false;
      pop.classList.add("open");
      pop.setAttribute("aria-hidden","false");
      downloadBtn.setAttribute("aria-expanded","true");
    }
    function closePopover(){
      pop.classList.remove("open");
      pop.setAttribute("aria-hidden","true");
      downloadBtn.setAttribute("aria-expanded","false");
      setTimeout(() => { if (!pop.classList.contains("open")) pop.hidden = true; }, 300);
    }

    downloadBtn.addEventListener("click", (e) => {
      if (isMobile) { window.location.href = DOWNLOAD_URL; return; }
      e.preventDefault();
      (pop.classList.contains("open") ? closePopover : openPopover)();
    });

    document.addEventListener("click", (e) => {
      if (pop.hidden) return;
      if (!wrap.contains(e.target)) closePopover();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !pop.hidden) closePopover();
    });
  })();

  /* ===== Xumm SDK: connect / disconnect / trustline ===== */
  let xumm = null;
  const walletStatus  = document.getElementById("walletStatus");
  const trustlineMsg  = document.getElementById("trustlineMsg");
  const connectBtn    = document.getElementById("connectWalletBtn");
  const disconnectBtn = document.getElementById("disconnectWalletBtn");
  const setTrustBtn   = document.getElementById("setTrustlineBtn");

  function setConnectedUI(acct){
    if (walletStatus) walletStatus.textContent = "Connected: " + acct;
    window.__xrbcWallet = acct;
    localStorage.setItem("xrbcWallet", acct);
    if (disconnectBtn) disconnectBtn.disabled = false;
    if (connectBtn) connectBtn.disabled = true;
  }
  function setDisconnectedUI(){
    if (walletStatus) walletStatus.textContent = "Status: Not connected";
    window.__xrbcWallet = null;
    localStorage.removeItem("xrbcWallet");
    if (disconnectBtn) disconnectBtn.disabled = true;
    if (connectBtn) connectBtn.disabled = false;
  }

  if (typeof Xumm !== 'undefined'){
    xumm = new Xumm(cfg.xummApiKey);

    const savedAcct = localStorage.getItem("xrbcWallet");
    if (savedAcct) setConnectedUI(savedAcct);

    xumm.on("ready", async () => {
      try{
        const acct = await xumm.user.account;
        if (acct) setConnectedUI(acct);
      } catch {}
    });

    window.addEventListener("visibilitychange", () => { if (!document.hidden) { xumm.user.account.then(a => a && setConnectedUI(a)).catch(()=>{}); } });
    window.addEventListener("focus", () => { xumm.user.account.then(a => a && setConnectedUI(a)).catch(()=>{}); });

    if (connectBtn) connectBtn.addEventListener("click", async () => {
      try {
        if (walletStatus) walletStatus.textContent = "Waiting for Xaman… (scan QR if shown)";
        await xumm.authorize();
        const acct = await xumm.user.account;
        if (acct) setConnectedUI(acct);
        else if (walletStatus) walletStatus.textContent = "Still waiting for Xaman…";
      } catch {
        if (walletStatus) walletStatus.textContent = "Failed to connect wallet";
      }
    });

    if (disconnectBtn) disconnectBtn.addEventListener("click", () => {
      setDisconnectedUI();
      try { xumm.logout(); } catch {}
    });

    if (setTrustBtn) setTrustBtn.addEventListener("click", async () => {
      try {
        const acct = window.__xrbcWallet || (xumm && await xumm.user.account);
        if (!acct) {
          if (trustlineMsg) trustlineMsg.textContent = "Please connect your wallet first, then try again.";
          if (connectBtn) connectBtn.focus();
          return;
        }
        if (trustlineMsg) trustlineMsg.textContent = "Preparing trustline request…";
        setTrustBtn.disabled = true;

        const txjson = {
          TransactionType: "TrustSet",
          Account: acct,
          LimitAmount: { currency: XRBC.currency, issuer: XRBC.issuer, value: "21000000" }
        };

        const { resolved } = await xumm.payload.createAndSubscribe({ txjson }, (ev) => {
          if (ev?.opened && trustlineMsg) trustlineMsg.textContent = "Open Xaman (or scan QR) to review…";
          if (ev?.signed === false && trustlineMsg) trustlineMsg.textContent = "Trustline rejected. You can try again.";
        });

        const result = await resolved;
        if (!result?.signed) { if (trustlineMsg) trustlineMsg.textContent = "Trustline not signed."; return; }
        if (trustlineMsg) trustlineMsg.textContent = "✅ Trustline set successfully!";
      } catch (err) {
        if (trustlineMsg) trustlineMsg.textContent = "Error: " + (err?.message || err);
      } finally {
        setTrustBtn.disabled = false;
      }
    });
  } else {
    console.warn("Xumm SDK not loaded — wallet actions disabled.");
    if (connectBtn) connectBtn.disabled = true;
    if (setTrustBtn) setTrustBtn.disabled = true;
    if (trustlineMsg) trustlineMsg.textContent = "Wallet features unavailable: Xaman SDK not loaded.";
  }

  /* ===== Trading UI ===== */
  const sideEl        = document.getElementById("side");
  const tradeCard     = document.getElementById("tradeCard");
  const buyTab        = document.getElementById("buyTab");
  const sellTab       = document.getElementById("sellTab");
  const amountEl      = document.getElementById("amount");
  const priceEl       = document.getElementById("price");
  const priceField    = document.getElementById("priceField");
  const totalXrpEl    = document.getElementById("totalXrp");
  const suggestBtn    = document.getElementById("suggestPriceBtn");
  const placeOfferBtn = document.getElementById("placeOfferBtn");
  const marketBtn     = document.getElementById("marketTradeBtn");
  const tradeMsg      = document.getElementById("tradeMsg");

  function updateExplainer(side){
    const wrap = document.getElementById("sideExplain");
    if (!wrap) return;
    const buyNote  = wrap.querySelector('.note.buy');
    const sellNote = wrap.querySelector('.note.sell');
    const showBuy = (side === 'buy');
    if (buyNote){
      buyNote.hidden = !showBuy;
      buyNote.classList.toggle('active', showBuy);
      buyNote.setAttribute('aria-hidden', (!showBuy).toString());
    }
    if (sellNote){
      sellNote.hidden = showBuy;
      sellNote.classList.toggle('active', !showBuy);
      sellNote.setAttribute('aria-hidden', (showBuy).toString());
    }
    const hint = document.getElementById('amountHint');
    const label = document.getElementById('amountLabel');
    if (label) label.textContent = 'Amount (XRBC)';
    if (hint){
      hint.innerHTML = (side === 'buy')
        ? `How many XRBC you want to <span id="actionWord">buy</span>. <span class="nowrap">You’re trading <span class="asset-chip asset-xrp"><img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP</span> to receive <span class="asset-chip asset-xrbc"><img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC</span>.</span>`
        : `How many XRBC you want to <span id="actionWord">sell</span>. <span class="nowrap">You’re trading <span class="asset-chip asset-xrbc"><img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC</span> to receive <span class="asset-chip asset-xrp"><img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP</span>.</span>`;
    }
  }

  function setSide(side){
    if (sideEl) sideEl.value = side;
    if (buyTab)  { buyTab.classList.toggle("active", side==='buy');  buyTab.setAttribute('aria-selected', side==='buy' ? 'true':'false'); }
    if (sellTab) { sellTab.classList.toggle("active", side==='sell'); sellTab.setAttribute('aria-selected', side==='sell' ? 'true':'false'); }
    if (tradeCard){
      tradeCard.classList.toggle('buy', side==='buy');
      tradeCard.classList.toggle('sell', side==='sell');
    }
    updateExplainer(side);
    recalcTotals();
  }

  if (buyTab)  buyTab.addEventListener('click', () => setSide('buy'));
  if (sellTab) sellTab.addEventListener('click', () => setSide('sell'));
  setSide(sideEl?.value || 'buy');

  function recalcTotals(){
    if (!totalXrpEl) return;
    const amt = Number(amountEl?.value) || 0;
    const px  = Number(priceEl?.value)  || 0;
    const total = (px || 0) * amt;
    totalXrpEl.textContent = (isFinite(total) ? total : 0).toFixed(6) + " XRP";
  }
  if (amountEl) amountEl.addEventListener("input", recalcTotals);
  if (priceEl)  priceEl.addEventListener("input", recalcTotals);
  amountEl && amountEl.addEventListener("blur", ()=>{ amountEl.value = clamp6(amountEl.value); recalcTotals(); });
  priceEl  && priceEl.addEventListener("blur",  ()=>{ priceEl.value  = clamp6(priceEl.value);  recalcTotals(); });

  /* Wallet-aware balances for % chips */
  const BAL = { xrp: 0, xrbc: 0 };
  const RESERVE_BUFFER_XRP = 1.0;
  const normalizeHexCurrency = (s) => (s || '').toUpperCase().replace(/0+$/,'');
  const XRBC_HEX_NORM = normalizeHexCurrency(XRBC.currency);

  async function fetchBalances(){
    const acct = window.__xrbcWallet;
    if (!acct) { BAL.xrp = 0; BAL.xrbc = 0; return BAL; }

    try {
      const info = await xrplRequest({
        method: "account_info",
        params: [{ account: acct, ledger_index: "validated" }]
      });
      BAL.xrp = Number(info?.result?.account_data?.Balance || 0) / XRP_TO_DROPS;
    } catch { BAL.xrp = 0; }

    try {
      const lines = await xrplRequest({
        method: "account_lines",
        params: [{ account: acct, peer: XRBC.issuer, ledger_index: "validated" }]
      });
      const tl = (lines?.result?.lines || []).find(l =>
        normalizeHexCurrency(l.currency) === XRBC_HEX_NORM
      );
      BAL.xrbc = tl ? Math.max(0, Number(tl.balance || 0)) : 0;
    } catch { BAL.xrbc = 0; }

    return BAL;
  }

  (function initPercentChips(){
    const chips = document.querySelectorAll('.quick-amounts .qa');
    if (!chips.length) return;

    async function applyPercent(pct){
      const side = sideEl?.value || 'buy';
      await fetchBalances();

      if (side === 'sell'){
        const amt = Math.max(0, BAL.xrbc * (pct/100));
        if (amountEl){
          amountEl.value = amt.toFixed(6);
          amountEl.dispatchEvent(new Event('input'));
        }
        return;
      }

      let price = Number(priceEl?.value) || 0;
      if (!price) { await fillBestPrice(); price = Number(priceEl?.value) || 0; }
      if (!price || price <= 0) return;

      const spendable = Math.max(0, (BAL.xrp - RESERVE_BUFFER_XRP)) * (pct/100);
      const amt = spendable > 0 ? (spendable / price) : 0;

      if (amountEl){
        amountEl.value = amt.toFixed(6);
        amountEl.dispatchEvent(new Event('input'));
      }
    }

    chips.forEach(btn => btn.addEventListener('click', async () => {
      const pct = Number(btn.dataset.q || 0);
      if (!pct) return;
      btn.disabled = true;
      try { await applyPercent(pct); }
      finally { btn.disabled = false; }
    }));
  })();

  /* Pricing helpers */
  async function getTopOfBook(){
    const [askRes, bidRes] = await Promise.all([
      xrplRequest({ method:"book_offers", params:[{ taker_gets: XRBC,             taker_pays: { currency:"XRP" }, limit:1 }] }),
      xrplRequest({ method:"book_offers", params:[{ taker_gets: { currency:"XRP"}, taker_pays: XRBC,             limit:1 }] })
    ]);
    const priceFrom = (of) => {
      if (!of) return null;
      const gets = of.TakerGets?.value ? parseFloat(of.TakerGets.value) : parseFloat(of.TakerGets) / XRP_TO_DROPS;
      const pays = of.TakerPays?.value ? parseFloat(of.TakerPays.value) : parseFloat(of.TakerPays) / XRP_TO_DROPS;
      if (!isFinite(gets) || gets <= 0 || !isFinite(pays)) return null;
      return pays / gets; // XRP per XRBC
    };
    return {
      bestAsk: priceFrom(askRes?.result?.offers?.[0]) || null, // price you pay to buy XRBC
      bestBid: priceFrom(bidRes?.result?.offers?.[0]) || null  // price you receive when selling XRBC
    };
  }

  async function getMarketPrice(side){
    // Try AMM first
    try {
      const data = await xrplRequest({
        method: "amm_info",
        params: [{ asset:{currency:"XRP"}, asset2:{currency:XRBC.currency, issuer:XRBC.issuer} }]
      });
      const amm = data?.result?.amm;
      if (amm && amountEl){
        const amt = Number(amountEl.value);
        if (amt > 0){
          const reserveXrp  = parseFloat(amm.amount) / XRP_TO_DROPS;
          const reserveXrbc = parseFloat(amm.amount2.value);
          const feeRate     = amm.trading_fee / 1_000_000;
          const k = reserveXrp * reserveXrbc;
          if (side === "buy"){
            const newY = reserveXrbc - amt;
            if (newY > 0){
              const newX = k / newY;
              let xrpIn = newX - reserveXrp;
              xrpIn += xrpIn * feeRate;
              return xrpIn / amt;
            }
          } else {
            const newY = reserveXrbc + amt;
            const newX = k / newY;
            let xrpOut = reserveXrp - newX;
            xrpOut -= xrpOut * feeRate;
            return xrpOut / amt;
          }
        }
      }
    } catch {}

    // Fallback: top of book
    const { bestAsk, bestBid } = await getTopOfBook();
    return side === "buy" ? bestAsk : bestBid;
  }

  // Prevent overlapping best-price calls
  let pricingInFlight = false;

  /* AMM-based price helper for the visible Price field */
  async function fillBestPrice() {
    if (pricingInFlight) return;
    if (!sideEl || !amountEl || !priceEl) return;
    const side = sideEl.value;
    const amount = Number(amountEl.value);
    if (!amount || amount <= 0) {
      if (tradeMsg){ tradeMsg.textContent = "Enter a valid XRBC amount."; tradeMsg.classList.remove("ok","err","connecting"); }
      return;
    }
    if (tradeMsg){ tradeMsg.textContent = "🔐 Connecting to XRPL for secure best price…"; tradeMsg.classList.remove("ok","err"); tradeMsg.classList.add("connecting"); }

    pricingInFlight = true;
    try {
      const px = await getMarketPrice(side);
      if (!px || px <= 0) throw new Error("No price available");
      priceEl.value = Number(px).toFixed(6);
      recalcTotals();
      if (tradeMsg){ tradeMsg.textContent = `Best price calculated from AMM/top-of-book (${side}).`; tradeMsg.classList.remove("connecting"); tradeMsg.classList.add("ok"); }
    } catch (err) {
      if (tradeMsg){ tradeMsg.textContent = "Price helper error: " + (err?.message || err); tradeMsg.classList.remove("connecting"); tradeMsg.classList.add("err"); }
    } finally {
      pricingInFlight = false;
    }
  }
  if (suggestBtn) suggestBtn.addEventListener("click", fillBestPrice);
  setInterval(() => {
    const amt = Number(amountEl?.value);
    if (!pricingInFlight && amt > 0) fillBestPrice().catch(()=>{});
  }, 10000);

  /* Place Limit Order (existing) */
  if (placeOfferBtn) placeOfferBtn.addEventListener("click", async () => {
    try {
      if (!xumm) throw new Error("Wallet SDK not available.");
      const account = window.__xrbcWallet;
      if (!account) throw new Error("Connect your wallet first.");

      const side   = sideEl?.value;
      const amtStr = clamp6(amountEl?.value);
      const priceV = Number(priceEl?.value);

      const amt = Number(amtStr);
      if (!amt || !priceV || amt <= 0 || priceV <= 0) throw new Error("Enter valid Amount & Price.");

      const xrpTotal = priceV * amt; // XRP
      const xrpTotalDrops = toDropsExact((Math.floor(xrpTotal*1e6)/1e6).toFixed(6)); // exact to 6dp

      const TF_SELL = 0x00080000;

      let txjson;
      if (side === "sell") {
        txjson = {
          TransactionType: "OfferCreate",
          Account: account,
          TakerGets: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amtStr) },
          TakerPays: xrpTotalDrops,
          Flags: TF_SELL
        };
      } else {
        txjson = {
          TransactionType: "OfferCreate",
          Account: account,
          TakerGets: xrpTotalDrops,
          TakerPays: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amtStr) },
          Flags: 0
        };
      }

      if (tradeMsg) { tradeMsg.textContent = "Open Xaman to review & sign…"; tradeMsg.classList.remove("err"); }
      const { resolved } = await xumm.payload.createAndSubscribe({ txjson }, (ev) => {
        if (ev?.opened && tradeMsg) tradeMsg.textContent = "Payload opened in Xaman…";
        if (ev?.signed === false && tradeMsg) tradeMsg.textContent = "Order rejected.";
      });

      const result = await resolved;
      if (!result.signed) { if (tradeMsg) tradeMsg.textContent = "Order not signed."; return; }

      if (tradeMsg) tradeMsg.textContent = "Order submitted. Refreshing order book…";
      await refreshOrderBook();
    } catch (err) {
      if (tradeMsg) tradeMsg.textContent = "Error: " + (err?.message || err);
    }
  });

  /* ===== Market Swap (AMM path Payment) ===== */
  if (marketBtn) marketBtn.addEventListener("click", async () => {
    const SLIPPAGE_PCT = 2; // protective cap
    try {
      if (!xumm) throw new Error("Wallet SDK not available.");
      const account = window.__xrbcWallet;
      if (!account) throw new Error("Connect your wallet first.");

      const side = sideEl?.value || "buy";
      const amtStr = clamp6(amountEl?.value);
      const amt  = Number(amtStr);
      if (!amt || amt <= 0) throw new Error("Enter valid Amount.");

      // Get a reference price to compute slippage bounds
      const basePx = await getMarketPrice(side);
      if (!basePx || basePx <= 0) throw new Error("No market price available.");
      const slip = SLIPPAGE_PCT / 100;

      // Helpers
      const TF_PARTIAL = 0x00020000; // tfPartialPayment

      // === Path-find ===
      async function ripplePathFind(params){
        const r = await xrplRequest({ method: "ripple_path_find", params: [params] });
        const alts = r?.result?.alternatives || [];
        if (!alts.length) throw new Error("No AMM/paths available for this amount.");
        return alts;
      }
      function pickCheapestXrp(alts){
        // Choose alternative with lowest XRP cost
        let best = null, bestCostDrops = Infinity;
        for (const alt of alts){
          const sa = alt.source_amount;
          let costDrops = Infinity;
          if (typeof sa === "string"){
            costDrops = Number(sa); // XRP drops
          } else if (sa && sa.currency === "XRP"){
            costDrops = Number(ceilDropsFromXrp(sa.value));
          }
          if (Number.isFinite(costDrops) && costDrops < bestCostDrops){
            best = alt; bestCostDrops = costDrops;
          }
        }
        if (!best) throw new Error("Could not price a path with XRP.");
        return { best, costDrops: String(bestCostDrops) };
      }
      function pickCheapestIou(alts, iouCurrencyHex, iouIssuer){
        // Choose alternative with lowest IOU cost (for selling XRBC)
        let best = null, bestCost = Infinity;
        for (const alt of alts){
          const sa = alt.source_amount;
          if (sa && typeof sa === "object" && sa.currency && sa.issuer){
            const isXRBC = (sa.issuer === iouIssuer) &&
              (String(sa.currency).toUpperCase() === String(iouCurrencyHex).toUpperCase());
            if (isXRBC){
              const v = Number(sa.value);
              if (Number.isFinite(v) && v < bestCost){ best = alt; bestCost = v; }
            }
          }
        }
        if (!best) throw new Error("Could not price a path with XRBC as source.");
        return { best, cost: bestCost };
      }

      let txjson;

      if (side === "buy"){
        // Buy XRBC using XRP → set Amount in XRBC, cap SendMax in XRP, allow partial with DeliverMin
        const destAmt = { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amtStr) };
        const alts = await ripplePathFind({
          source_account: account,
          destination_account: account,
          destination_amount: destAmt,
          source_currencies: [{ currency: "XRP" }]
        });
        const { best, costDrops } = pickCheapestXrp(alts);
        const maxSpendDrops = (BigInt(costDrops) + (BigInt(costDrops) * BigInt(Math.round(slip*1e6)) / 1000000n)).toString();

        txjson = {
          TransactionType: "Payment",
          Account: account,
          Destination: account,
          Amount: destAmt,
          SendMax: maxSpendDrops, // XRP in drops
          Flags: TF_PARTIAL,
          DeliverMin: { currency: XRBC.currency, issuer: XRBC.issuer, value: (amt * (1 - slip)).toFixed(6) },
          Paths: best.paths_computed || best.paths_canonical || []
        };
      } else {
        // Sell XRBC to receive XRP → set Amount in XRP, cap SendMax in XRBC, require DeliverMin
        const estXrp = amt * basePx;
        const minXrpDrops = floorDropsFromXrp((Math.floor(estXrp*(1-slip)*1e6)/1e6).toFixed(6));

        // Guard against 0-drop rounding
        if (BigInt(minXrpDrops) < 1n) throw new Error("Amount too small after slippage. Increase amount.");

        const alts = await ripplePathFind({
          source_account: account,
          destination_account: account,
          destination_amount: minXrpDrops, // XRP drops as target
          source_currencies: [{ currency: XRBC.currency, issuer: XRBC.issuer }]
        });
        const { best, cost } = pickCheapestIou(alts, XRBC.currency, XRBC.issuer);
        if (cost > amt) throw new Error("Amount too small for slippage cap. Increase amount or relax slippage.");

        txjson = {
          TransactionType: "Payment",
          Account: account,
          Destination: account,
          Amount: minXrpDrops, // XRP in drops
          SendMax: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amtStr) },
          Flags: TF_PARTIAL,
          DeliverMin: minXrpDrops,
          Paths: best.paths_computed || best.paths_canonical || []
        };
      }

      if (tradeMsg){ tradeMsg.textContent = "Open Xaman to review & sign AMM swap…"; tradeMsg.classList.remove("err"); }
      const { resolved } = await xumm.payload.createAndSubscribe({ txjson }, (ev) => {
        if (ev?.opened && tradeMsg) tradeMsg.textContent = "Payload opened in Xaman…";
        if (ev?.signed === false && tradeMsg) tradeMsg.textContent = "Swap rejected.";
      });

      const result = await resolved;
      if (!result.signed) { if (tradeMsg) tradeMsg.textContent = "Swap not signed."; return; }

      if (tradeMsg) tradeMsg.textContent = "Swap submitted. Refreshing…";
      await refreshOrderBook();
    } catch (err) {
      if (tradeMsg) tradeMsg.textContent = "Error: " + (err?.message || err);
    }
  });

  /* ===== Live Metrics: Ledger + Order Book ===== */
  const ledgerOut = document.getElementById("ledgerOutput");
  const bookOut   = document.getElementById("priceOutput");

  async function getLedgerSummary(){
    const res = await xrplRequest({ method: "ledger", params: [{ ledger_index: "validated" }] });
    const r = res?.result || {};
    const idx   = r.ledger_index || r.validated_ledger_index || r.ledger?.ledger_index;
    const hash  = r.ledger_hash  || r.ledger?.ledger_hash;
    const close = r.ledger?.close_time_human || r.closed?.close_time_human;
    return {
      ledger_index: idx ?? "(unknown)",
      ledger_hash : hash ?? "(unknown)",
      close_time  : close || "(not expanded)",
      validated   : r.validated === undefined ? true : !!r.validated
    };
  }

  async function getOrderBookHtml(){
    async function side(taker_gets, taker_pays, label){
      const rows = [];
      try{
        const r = await xrplRequest({ method:"book_offers", params:[{ taker_gets, taker_pays, limit:5 }] });
        const offers = r?.result?.offers || [];
        if (!offers.length){
          rows.push(`<tr><td>${label}</td><td>No offers</td><td>-</td></tr>`);
        } else {
          for (const ofr of offers){
            const gets = ofr.TakerGets?.value ? parseFloat(ofr.TakerGets.value)
                                              : parseFloat(ofr.TakerGets) / XRP_TO_DROPS;
            const pays = ofr.TakerPays?.value ? parseFloat(ofr.TakerPays.value)
                                              : parseFloat(ofr.TakerPays) / XRP_TO_DROPS;
            const price = (isFinite(gets) && gets > 0) ? (pays / gets) : NaN;
            rows.push(`<tr><td>${label}</td><td>${isFinite(price)?price.toFixed(6):"—"}</td><td>${isFinite(gets)?gets.toFixed(2):"—"}</td></tr>`);
          }
        }
      } catch (e){
        rows.push(`<tr><td>${label}</td><td>Error</td><td>${esc((e && e.message) || e)}</td></tr>`);
      }
      return rows.join("");
    }
    const asks = await side(XRBC, { currency: "XRP" }, "Ask");
    const bids = await side({ currency: "XRP" }, XRBC, "Bid");
    return `
      <div style="overflow:auto">
        <table class="table">
          <thead><tr><th>Side</th><th>Price (XRP/XRBC)</th><th>Amount</th></tr></thead>
          <tbody>${asks}${bids}</tbody>
        </table>
      </div>
    `;
  }

  async function refreshLedger(){
    try {
      const sum = await getLedgerSummary();
      if (ledgerOut) ledgerOut.textContent = JSON.stringify(sum, null, 2);
    } catch (e) {
      if (ledgerOut) ledgerOut.textContent = "Error fetching ledger: " + (e?.message || e);
    }
  }
  async function refreshOrderBook(){
    try {
      const html = await getOrderBookHtml();
      if (bookOut) bookOut.innerHTML = html;
    } catch (e) {
      if (bookOut) bookOut.textContent = "Order book error: " + (e?.message || e);
    }
  }
  async function refreshAll(){
    await Promise.allSettled([ refreshOrderBook(), refreshLedger() ]);
  }

  // First paint + gentle auto-refresh
  refreshAll().catch(()=>{});
  document.addEventListener("visibilitychange", () => { if (!document.hidden) refreshAll().catch(()=>{}); });
  window.addEventListener("focus", () => refreshAll().catch(()=>{}));
  setInterval(() => { refreshAll().catch(()=>{}); }, 15000);
})();
  </script>

  <!-- ===== XRBC Footer ===== -->
  <footer class="site-footer" role="contentinfo" aria-label="XRBitcoinCash footer">
    <div class="wrap">
      <div class="cols" style="display:grid;gap:18px;grid-template-columns:1fr;max-width:var(--wrap-wide);margin:0 auto;">
        <section>
          <h3>About this page</h3>
          <p class="small">
            A minimal, security-first trading &amp; ledger portal for
            <strong>XRBitcoinCash (XRBC)</strong> on the <span class="nowrap">XRP Ledger</span>.
            Signing is handled in <strong>Xaman</strong> on mobile for safer review and execution.
          </p>
          <dl class="factlist" aria-label="XRBC details" style="display:grid;gap:6px;margin:0">
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Symbol</strong><span class="mono">XRBC</span></div>
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Issuer</strong><span class="mono">rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw</span></div>
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Currency Code</strong><span class="mono">5852626974636F696E6361736800000000000000</span></div>
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Total Supply</strong><span class="mono">21,000,000</span></div>
          </dl>
        </section>

        <section>
          <h3>Security measures</h3>
          <ul class="small" style="list-style:disc;margin-left:18px;display:grid;gap:6px">
            <li><strong>Mobile & desktop signing</strong> via Xaman; desktop shows a QR automatically in the Xaman flow.</li>
            <li>No keys ever requested or stored; only the public account address may be cached (localStorage).</li>
            <li>XRPL calls validated; errors handled; no <span class="mono">eval</span> or dynamic script injection.</li>
            <li>XRBC issuer &amp; currency code are constants; XRP↔drops conversion is precise.</li>
            <li>AMM helper estimates effective price incl. fee.</li>
          </ul>
        </section>

        <section style="display:grid;gap:10px;justify-items:center;">
          <h3>Whitepaper &amp; credits</h3>
          <a class="eco-link" href="/whitepaper.html" aria-label="Open the XRBitcoinCash Whitepaper" style="min-width:200px;">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"></path>
              <path fill="#ffffff" d="M13 2v5h5"></path>
            </svg>
            Whitepaper
          </a>
          <a class="eco-link" href="https://chat.openai.com/" target="_blank" rel="noopener noreferrer" aria-label="Talk to ChatGPT" style="min-width:200px;">
            <img src="/assets/chatgpt-mark.svg" alt="" onerror="this.remove()" decoding="async" loading="lazy">
            <span>Built with ChatGPT</span>
          </a>
          <p class="small" style="margin-top:4px;opacity:.9">
            Verify the URL starts with <span class="mono">https://xrbitcoincash.com</span>.
          </p>
        </section>
      </div>

      <div class="legal small" style="border-top:1px dashed #1f2a37;padding-top:10px;display:flex;flex-wrap:wrap;gap:6px;justify-content:space-between;align-items:center">
        <span>XRBC · XRBC/XRP Trading &amp; Ledger Portal</span>
        <span class="mono">Issuer: rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw</span>
      </div>
    </div>
  </footer>
</body>
</html>on" content="Safely trade XRBC on the XRP Ledger. Connect your Xaman (Xumm) wallet to place XRBC/XRP limit or market orders, read the order book, and view AMM pool info." />
  <meta name="keywords" content="XRBitcoinCash, XRBC, XRP Ledger, XRPL, Xaman, Xumm, DEX, AMM, crypto trading, trustline" />
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="theme-color" content="#0b0f14" />

  <!-- Favicons -->
  <link rel="icon" href="/xrbc-nft.png" type="image/png">
  <link rel="shortcut icon" href="/xrbc-nft.png" type="image/png">
  <link rel="apple-touch-icon" href="/xrbc-nft.png">
  <meta name="msapplication-TileImage" content="/xrbc-nft.png">
  <link rel="icon" href="/favicon.ico?v=1" sizes="any">
  <link rel="icon" type="image/png" href="/favicons/favicon-32.png?v=1" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicons/favicon-16.png?v=1" sizes="16x16">
  <link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png?v=1" sizes="180x180">
  <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg?v=1" color="#0b0f14">
  <meta name="msapplication-TileColor" content="#0b0f14">
  <link rel="manifest" href="/site.webmanifest?v=1">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="XRBitcoinCash">
  <meta property="og:title" content="Safely trade XRBC · XRBitcoinCash">
  <meta property="og:description" content="Decentralized XRBC/XRP trading on the XRP Ledger with live order book and AMM price helper.">
  <meta property="og:url" content="https://xrbitcoincash.com/trade.html">
  <meta property="og:image" content="https://xrbitcoincash.com/xrbc-nft.png">
  <meta property="og:image:secure_url" content="https://xrbitcoincash.com/xrbc-nft.png">
  <meta property="og:image:alt" content="XRBitcoinCash — XRBC/XRP trading page">

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Safely trade XRBC · XRBitcoinCash">
  <meta name="twitter:description" content="Trade XRBC on XRPL. Connect your wallet, place orders, and view AMM pool info.">
  <meta name="twitter:image" content="https://xrbitcoincash.com/xrbc-nft.png">
  <meta name="twitter:image:alt" content="XRBitcoinCash — XRBC/XRP trading page">

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Safely trade XRBC · XRBitcoinCash",
    "url": "https://xrbitcoincash.com/trade.html",
    "description": "Safely trade XRBC on the XRP Ledger. Connect your Xaman (Xumm) wallet to place XRBC/XRP limit or market orders, read the order book, and view AMM pool info.",
    "isPartOf": {
      "@type": "WebSite",
      "name": "XRBitcoinCash",
      "url": "https://xrbitcoincash.com/"
    },
    "primaryImageOfPage": {
      "@type": "ImageObject",
      "url": "https://xrbitcoincash.com/xrbc-nft.png"
    },
    "about": {
      "@type": "Cryptocurrency",
      "name": "XRBitcoinCash (XRBC)",
      "alternateName": "XRBC",
      "additionalProperty": [
        { "@type": "PropertyValue", "name": "issuer", "value": "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw" },
        { "@type": "PropertyValue", "name": "currency_hex", "value": "5852626974636F696E6361736800000000000000" },
        { "@type": "PropertyValue", "name": "network", "value": "XRP Ledger (XRPL)" }
      ]
    },
    "potentialAction": [{ "@type": "BuyAction", "target": "https://xrbitcoincash.com/trade.html" }]
  }
  </script>

  <meta name="ai-readable" content="This page exposes structured data (JSON-LD) describing the XRBC trading interface on XRPL, including issuer and currency hex.">

  <style>
/* =========================================
   XRBC — Uniform Site CSS (v2, exchange-style DEX)
   ========================================= */
:root{
  --wrap:980px; --wrap-wide:1080px;
  --bg:#0b0f14; --panel:#0e1520; --panel-2:#0c131c;
  --ink:#e7edf5; --muted:#9fb0c5;
  --accent:#60a5fa; --accent-2:#22d3ee; --ok:#22c55e; --err:#ef4444;
  --line:#2b3a4b; --shadow:0 10px 30px rgba(0,0,0,.35);
  --gap:14px; --gap-lg:24px;
  --hdr-blue-a: rgba(0,182,255,.22); --hdr-blue-b: rgba(0,182,255,.16);
}
*,*::before,*::after{ box-sizing:border-box; min-width:0; }
html{ scroll-behavior:smooth; }
html,body{ height:100%; max-width:100%; overflow-x:hidden; }
body{ background:var(--bg); color:var(--ink); font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; position:relative; }
img,svg{ max-width:100%; height:auto; display:block; }
.mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; overflow-wrap:anywhere; word-break:break-word; hyphens:auto; }
.nowrap{ white-space:nowrap; }

/* Header */
.site-header{
  position:sticky; top:0; z-index:20; width:100%;
  background:linear-gradient(180deg,#0b0f14,#0b1017);
  border-bottom:1px solid rgba(255,255,255,.06);
  backdrop-filter:saturate(140%) blur(6px);
  transition:transform .2s ease-out, background-color .2s ease-out;
  will-change:transform;
}
.header-wrap{ position:relative; max-width:var(--wrap); margin:0 auto;
  padding:12px max(16px, env(safe-area-inset-left)) 12px max(16px, env(safe-area-inset-right));
  display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px;
}
.header-wrap::after{
  content:""; position:absolute; inset:-8px -6px; pointer-events:none; z-index:0;
  background:
    radial-gradient(42% 100% at 10% 50%, var(--hdr-blue-a), transparent 60%),
    radial-gradient(28% 70% at 95% 25%, var(--hdr-blue-b), transparent 70%);
  filter:blur(8px); opacity:.9;
}
.brand{ display:flex; align-items:center; gap:10px; min-width:0; position:relative; z-index:1; }
.brand img{ width:40px; height:40px; border-radius:10px; object-fit:contain; background:#0e1520; border:1px solid var(--line); box-shadow:0 0 24px rgba(16,185,129,.24), 0 0 48px rgba(56,189,248,.18); }
.brand h1{ margin:0; font-size:clamp(.95rem, 2.5vw, 1.05rem); line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-shadow:0 0 10px rgba(0,182,255,.45), 0 0 18px rgba(0,182,255,.35); }
.header-center{ justify-self:center; position:relative; z-index:1; min-width:0; }
.header-right{ justify-self:end; display:flex; gap:8px; align-items:center; position:relative; z-index:1; min-width:0; }
.header-nav{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:center; }

/* Header nav pills */
.nav-pill{ position:relative; display:inline-flex; align-items:center; justify-content:center; gap:8px;
  min-height:48px; padding:10px 14px; border-radius:12px; font-weight:800; text-decoration:none; cursor:pointer;
  background:linear-gradient(180deg,#0e1520,#0c131c); color:var(--ink); border:1px solid var(--line); box-shadow:var(--shadow);
  transition:transform .08s ease, filter .2s ease, border-color .2s ease, box-shadow .2s ease;
  text-align:center; white-space:normal; overflow-wrap:anywhere;
}
.nav-pill:hover{ transform:translateY(-1px); filter:brightness(1.05); border-color:#324355; }
.nav-pill:focus-visible{ outline:2px solid var(--line); outline-offset:2px; }
.nav-pill::after{ content:""; position:absolute; inset:-10px; border-radius:16px; z-index:-1; filter:blur(12px); opacity:.65; transition:opacity .2s ease; }
.pill-ecosys::after{ background:radial-gradient(closest-side, rgba(255,255,255,.55), transparent 70%); }
.pill-whitepaper::after{ background:radial-gradient(closest-side, rgba(0,0,0,.65), transparent 70%); }

/* Theme toggle */
#themeToggle{
  appearance:none; border:1px solid var(--line); border-radius:10px;
  background:linear-gradient(180deg,#0e1520,#0c131c);
  color:#ffffff !important;
  text-shadow:0 0 8px rgba(255,255,255,.65), 0 0 16px rgba(96,165,250,.35);
  font-weight:800; line-height:1; padding:8px 12px;
  box-shadow:0 0 18px rgba(0,182,255,.35), var(--shadow);
  cursor:pointer; transition:filter .2s ease, border-color .2s ease, box-shadow .2s ease, transform .06s ease;
  white-space:nowrap;
}
#themeToggle:hover{ transform:translateY(-1px); filter:brightness(1.05); border-color:#324355; }

/* Containers */
.container{ max-width:var(--wrap); margin:12px auto 14px;
  padding-left:max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); position:relative; z-index:1; }

/* Cards / Buttons */
.card{ background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:var(--shadow); position:relative; z-index:1; }
.btn{
  appearance:none; border:1px solid var(--line); border-radius:12px;
  background:linear-gradient(180deg,#0e1520,#0c131c); color:var(--ink);
  padding:12px 16px; font-weight:700; line-height:1.2; text-decoration:none;
  display:inline-flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap;
  box-shadow:var(--shadow); transition:transform .06s ease, filter .2s ease, border-color .2s ease, box-shadow .2s ease;
  min-height:46px; font-size:clamp(.95rem, 3.2vw, 1.05rem); letter-spacing:.2px; text-align:center; overflow-wrap:anywhere;
}
.btn:hover{ transform:translateY(-1px); filter:brightness(1.05); border-color:#324355; }
.btn small{ display:block; font-size:.88em; opacity:.9; line-height:1.1; }
.btn::before{ content:none !important; }

/* DEX / Trade UI */
.trade-card{
  display:grid; gap:12px; text-align:left; padding:14px; border-radius:14px;
  background:linear-gradient(180deg,#0d141e,#0b1119);
  border:1px solid rgba(96,165,250,.25); position:relative;
}
.trade-card::before{
  content:""; position:absolute; inset:-1px; border-radius:14px;
  background:conic-gradient(from 180deg at 50% 50%, rgba(96,165,250,.35), rgba(34,211,238,.30), rgba(16,185,129,.25), rgba(96,165,250,.35));
  filter:blur(18px); opacity:.18; z-index:-1;
}

/* Tiny pair badge */
.trade-logo{ display:flex; align-items:center; justify-content:center; gap:8px; margin:2px 0 6px; text-align:center; flex-wrap:wrap; }
.trade-logo img{ width:20px; height:20px; border-radius:4px; object-fit:cover; border:1px solid var(--line); }
.trade-logo .pair{ font-weight:800; letter-spacing:.2px; font-size:14px; color:var(--ink); opacity:.95; }

/* Buy/Sell tabs */
.tabset{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px}
.tab{
  padding:10px 12px;border:1px solid var(--line);
  background:linear-gradient(180deg,#0e1520,#0c131c);border-radius:10px;
  font-weight:800;cursor:pointer;text-align:center;letter-spacing:.2px;font-size:1rem;
}
.tab.buy{color:#22c55e} .tab.sell{color:#ef4444}
.tab.buy.active{border-color:rgba(34,197,94,.55);box-shadow:0 0 0 2px rgba(34,197,94,.18) inset}
.tab.sell.active{border-color:rgba(239,68,68,.55);box-shadow:0 0 0 2px rgba(239,68,68,.18) inset}

/* Best Price */
.best-price-strip{ display:grid; grid-template-columns:1fr; gap:8px; margin-top:2px; padding:8px 10px; border:1px dashed var(--line); border-radius:10px; background:linear-gradient(180deg,#0b1119,#0a0f15); }
.best-price-btn{ width:100%; min-height:46px; font-weight:800; border:1px solid var(--line); border-radius:10px; background:linear-gradient(180deg,#0e1520,#0c131c); }
.best-price-strip .hint{ font-size:.9rem; color:var(--muted); overflow-wrap:anywhere; }

/* Fields */
.field{display:grid;gap:6px;margin-top:8px}
.field label{font-size:13px;color:var(--muted)}
.field input{
  width:100%;height:42px;padding:0 12px;border-radius:10px;border:1px solid var(--line);
  background:#0c131c;color:var(--ink); outline:none; font-size:14px;
}
.field input:focus{ border-color:rgba(96,165,250,.6); box-shadow:0 0 0 3px rgba(96,165,250,.20); }
.inline-hint{font-size:12px;color:var(--muted); overflow-wrap:anywhere;}
.amount-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.amount-row img{max-height:18px}

/* % chips */
.quick-amounts{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:6px; }
.qa{ height:34px; border:1px dashed var(--line); border-radius:8px; background:#0b1119; color:var(--ink); font-weight:700; font-size:12px; cursor:pointer; }

/* Total + submit row */
.total-line{ display:flex;align-items:center;justify-content:space-between;padding:10px 12px; border:1px dashed var(--line);border-radius:10px; background:linear-gradient(180deg,#0b1119,#0a0f15) }
.button-row{display:grid;grid-template-columns:1fr auto;gap:10px}
@media (max-width:600px){.button-row{grid-template-columns:1fr}}

/* Submit color mirrors side */
.btn-primary{ min-height:44px; font-weight:800; border:1px solid var(--line); border-radius:10px; background:linear-gradient(180deg,#0e1520,#0c131c); }
#tradeCard.buy .btn-primary{ border-color:rgba(34,197,94,.55); box-shadow:0 0 0 2px rgba(34,197,94,.18) inset; }
#tradeCard.sell .btn-primary{ border-color:rgba(239,68,68,.55); box-shadow:0 0 0 2px rgba(239,68,68,.18) inset; }

/* Auto-refresh indicator */
.refresh-indicator{display:flex;align-items:center;gap:8px;font-size:12px;color:#60a5fa;flex-wrap:wrap}
.clock{width:20px;height:20px;border:2px solid #60a5fa;border-radius:50%;position:relative;animation:spinHand 10s linear infinite}
.clock::after{content:"";position:absolute;top:2px;left:9px;width:2px;height:8px;background:#60a5fa;transform-origin:bottom center}
@keyframes spinHand{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* Status text & table */
.status-text{font-size:13px;color:var(--muted); overflow-wrap:anywhere;}
.status-text.ok{color:#22c55e} .status-text.err{color:#ef4444}
@keyframes flashText{from{opacity:1}to{opacity:.3}}
.status-text.connecting{animation:flashText 1.6s infinite alternate;color:#00e5ff !important;font-weight:700}
.table{width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed}
.table th,.table td{padding:8px 10px;border-bottom:1px solid #1a2433;word-break:break-word}
.table thead th{background:#0f1722;color:#cfe2ff;position:sticky;top:0;z-index:1}
@media (max-width:600px){ .table thead th{position:static} }

/* Footer */
.site-footer{ margin-top:24px; background:#0b0f14; color:#9fb0c5; border-top:1px solid rgba(255,255,255,.06); position:relative; z-index:1; }
.site-footer .wrap{ max-width:var(--wrap-wide); margin:0 auto; padding:16px max(16px, env(safe-area-inset-left)) 18px max(16px, env(safe-area-inset-right)); display:grid; gap:12px; }
.eco-link{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px; min-height:44px; width:auto; max-width:100%; border:1px solid var(--line); border-radius:12px; text-decoration:none; color:var(--ink); background:linear-gradient(180deg,#0e1520,#0c131c); box-shadow:var(--shadow); transition:transform .08s ease, filter .2s ease, border-color .2s ease; white-space:normal; overflow-wrap:anywhere; }
.eco-link:hover{ transform:translateY(-1px); filter:brightness(1.05); border-color:#324355; }
.eco-link img{ width:22px; height:22px; border-radius:6px; object-fit:cover; }

/* Light Mode */
body.light-mode{
  --bg:#ffffff; --panel:#ffffff; --panel-2:#ffffff; --ink:#0b0f14; --muted:#4b5565; --line:#000000;
  background:#ffffff; color:var(--ink);
}
body.light-mode .site-header{ background:rgba(255,255,255,.92); border-bottom:1px solid rgba(0,0,0,.08); backdrop-filter:saturate(120%) blur(6px); }
body.light-mode .header-wrap::after{ opacity:1; filter:blur(10px) brightness(1.18); }
body.light-mode .brand h1{ color:#0b0f14; text-shadow:0 0 12px rgba(0,122,255,.55), 0 0 24px rgba(0,122,255,.42); }
body.light-mode .card, body.light-mode .trade-card, body.light-mode .btn, body.light-mode .eco-link, body.light-mode .nav-pill{
  background:#ffffff !important; color:var(--ink) !important; border-color:var(--line) !important; box-shadow:none !important;
}
body.light-mode .pill-whitepaper::after{ opacity:.75; }

/* Chips */
.asset-chip{ display:inline-flex; align-items:center; gap:6px; font-weight:800; line-height:1; font-size:1em; padding:3px 8px; border-radius:9999px; border:1px solid var(--line); background:linear-gradient(180deg,#0b1119,#0a0f15); vertical-align:baseline; white-space:nowrap; }
.asset-chip img{ width:1em; height:1em; border-radius:3px; object-fit:cover; display:inline-block; border:1px solid var(--line); }
.asset-xrp{ color:#22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.18) inset, 0 0 22px rgba(34,197,94,.25); border-color:rgba(34,197,94,.55); }
.asset-xrbc{ color:#60a5fa; box-shadow:0 0 0 2px rgba(96,165,250,.18) inset, 0 0 22px rgba(96,165,250,.25); border-color:rgba(96,165,250,.55); }
body.light-mode .asset-chip{ background:#fff; border-color:#000; box-shadow:none; }
body.light-mode .asset-xrp{ color:#15803d; border-color:#000; box-shadow:0 0 20px rgba(34,197,94,.25); }
body.light-mode .asset-xrbc{ color:#0b6bdc; border-color:#000; box-shadow:0 0 20px rgba(96,165,250,.25); }
.asset-xrp img { background:#fff; }

/* Buy/Sell explainer */
.side-explain { margin-top:6px; }
.side-explain .note{ display:block; padding:10px 12px; margin-top:6px; border:1px dashed var(--line); border-radius:10px; background:linear-gradient(180deg,#0b1119,#0a0f15); color:var(--muted); transition:box-shadow .2s ease, border-color .2s ease, color .2s ease; }
.side-explain .note .copy strong{ color:var(--ink); }
.side-explain .note.buy.active{ border-color:rgba(34,197,94,.65); box-shadow:0 0 0 2px rgba(34,197,94,.25) inset, 0 0 18px rgba(34,197,94,.18); color:#b7f7cc; }
.side-explain .note.sell.active{ border-color:rgba(239,68,68,.65); box-shadow:0 0 0 2px rgba(239,68,68,.25) inset, 0 0 18px rgba(239,68,68,.18); color:#fecaca; }
body.light-mode .side-explain .note{ background:#fff; color:#2c3644; border-color:#000; }

/* Wallet card + glows */
.wallet-card { position:relative; overflow:hidden; }
.wallet-card::before{
  content:""; position:absolute; inset:-1px; border-radius:14px;
  background:
    radial-gradient(44% 60% at 20% 20%, rgba(96,165,250,.20), transparent 60%),
    radial-gradient(44% 60% at 80% 80%, rgba(34,211,238,.16), transparent 60%);
  filter:blur(18px); opacity:.25; z-index:0;
}
.btn.glow { position:relative; z-index:1; }
.btn.glow::after{ content:""; position:absolute; inset:-8px; border-radius:14px; filter:blur(12px); z-index:-1; opacity:.7; animation:btnFlicker 2.2s infinite ease-in-out; }
.btn.glow-white::after{  background: radial-gradient(closest-side, rgba(255,255,255,.85),  transparent 70%); animation-duration:1.8s; }
.btn.glow-yellow::after{ background: radial-gradient(closest-side, rgba(234,179,8,.70),  transparent 70%); animation-duration:2.1s; }
.btn.glow-red::after{    background: radial-gradient(closest-side, rgba(239,68,68,.70),  transparent 70%); animation-duration:2.6s; }
.btn.glow-green::after{  background: radial-gradient(closest-side, rgba(34,197,94,.75),  transparent 70%); animation-duration:1.9s; }
@keyframes btnFlicker{ 0%{opacity:.55;transform:translateY(0)}45%{opacity:.20;transform:translateY(.5px)}55%{opacity:.35}100%{opacity:.60} }

/* Download popover (inline) */
.dl-wrap{ display:flex; flex-direction:column; align-items:center; }
.qr-popover{ position:static !important; display:block; width:100%; max-width:260px; border-radius:12px; background:#ffffff; color:#0b0f14; border:1px solid #000; box-shadow:0 10px 30px rgba(0,0,0,.22); padding:10px; margin-top:10px; }
.qr-popover .label{ font-weight:800; font-size:12px; text-align:center; margin-top:8px; }
.qr-popover.collapse{ overflow:hidden; max-height:0; opacity:0; margin-top:0; transition:max-height .28s ease, opacity .28s ease, margin-top .28s ease; }
.qr-popover.collapse.open{ max-height:360px; opacity:1; margin-top:10px; }
body:not(.light-mode) .qr-popover{ background:#0e1520; color:#e7edf5; border:1px solid #2b3a4b; box-shadow:0 10px 30px rgba(0,0,0,.35); }
.qr-popover[hidden]{ display:none !important; }

/* Mobile */
@media (max-width:560px){
  html{ font-size:13px; }
  .header-wrap{ grid-template-columns:minmax(0,1fr) minmax(0,1fr); grid-auto-rows:minmax(0,auto); padding:8px max(16px, env(safe-area-inset-left)) 8px max(16px, env(safe-area-inset-right)); column-gap:8px; }
  .brand{ grid-column:1 / -1; grid-row:1; justify-self:center; text-align:center; }
  .header-center{ grid-column:1 / -1; grid-row:2; justify-self:center; }
  .header-right{ grid-column:1 / -1; grid-row:3; justify-self:center; }
  .header-nav .nav-pill{ width:100%; min-height:42px; padding:8px 10px; font-size:.95rem; }
  .container{ padding-left:max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); }
  .button-row{ grid-template-columns:1fr; }
  .asset-chip{ font-size:.95em; }
}

/* Reduced Motion */
@media (prefers-reduced-motion:reduce){ *{ transition:none !important; animation:none !important; } }

/* Light-mode fixes scoped to trade card */
body.light-mode #tradeCard{ background: transparent !important; color: var(--ink) !important; border-color: var(--line) !important; box-shadow: none !important; }
body.light-mode #tradeCard .field input,
body.light-mode #tradeCard .tab,
body.light-mode #tradeCard .qa,
body.light-mode #tradeCard .best-price-btn,
body.light-mode #tradeCard .best-price-strip,
body.light-mode #tradeCard .total-line,
body.light-mode #tradeCard .btn-primary { background: transparent !important; color: var(--ink) !important; border-color: var(--line) !important; box-shadow: none !important; }
body.light-mode #tradeCard .field input::placeholder { color: var(--muted) !important; }
body.light-mode #tradeCard .field label { color: var(--muted) !important; }
body.light-mode #tradeCard .inline-hint,
body.light-mode #tradeCard .best-price-strip .hint,
body.light-mode #tradeCard .status-text { color: var(--muted) !important; }
body.light-mode #tradeCard .status-text.ok  { color: #16a34a !important; }
body.light-mode #tradeCard .status-text.err { color: #dc2626 !important; }
body.light-mode #tradeCard .status-text.connecting { color: #0ea5e9 !important; }
body.light-mode #tradeCard .table thead th{ background: #f3f4f6 !important; color: #111827 !important; border-bottom-color: var(--line) !important; }
body.light-mode #tradeCard .table td{ color: var(--ink) !important; border-bottom-color: #e5e7eb !important; }
body.light-mode #tradeCard .side-explain .note { color: #2c3644 !important; }
body.light-mode #tradeCard .tab.buy.active, body.light-mode #tradeCard .tab.sell.active { background: transparent !important; box-shadow: none !important; }
body.light-mode #tradeCard .asset-chip { background: #fff !important; color: var(--ink) !important; }

/* Make long JSON and code mobile-friendly */
#ledgerOutput, pre, code{ white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; }

/* CSS-only header auto-hide via scroll-driven animation (progressive) */
@keyframes headerHide { to { transform:translateY(-100%); } }
@supports (animation-timeline: scroll()) {
  .site-header{
    animation: headerHide linear both;
    animation-timeline: scroll(root);
    animation-range: 0 160px;
  }
}

  </style>
</head>
<body>

 <!-- ===== Header ===== -->
<header class="site-header">
  <div class="header-wrap">
    <div class="brand">
      <img src="/xrbc-nft.png" alt="XRBitcoinCash (XRBC) logo">
      <h1>XRBitcoinCash</h1>
    </div>

    <nav class="header-center" role="navigation" aria-label="Primary">
      <div class="header-nav">
        <a class="nav-pill pill-ecosys" href="/xrbc-ecosystem.html" title="XRBC Ecosystem · DEX/AMM">XRBC Ecosystem · DEX/AMM</a>
        <a class="nav-pill pill-extract" href="https://xrbitcoincash.com/limit-order-extraction.html" title="Instant Limit Order Extraction">Limit Order Extraction</a>
        <a class="nav-pill pill-whitepaper" href="/whitepaper.html" title="XRBC White Paper">White Paper</a>
      </div>
    </nav>

    <div class="header-right">
      <button id="themeToggle" type="button" aria-pressed="false" aria-label="Toggle light/dark">Light/Dark</button>
    </div>
  </div>
</header>

  <!-- ===== Main ===== -->
  <main class="container" style="max-width:800px;text-align:center;">

    <h1 style="margin:12px 0 8px; line-height:1.1; letter-spacing:.2px;">
      XRBC · Decentralized Trading (XRPL via Xaman)
    </h1>

    <!-- DEX / xApp quick entries -->
    <div style="margin-top:12px">
      <div style="display:flex;align-items:center;gap:8px;
                  padding:8px 12px;border:1px solid #064e3b;border-left:4px solid #10b981;
                  border-radius:10px;background:linear-gradient(180deg,#052b1f,#073425);
                  color:#d1fae5;font-size:14px;font-weight:700;letter-spacing:.2px;margin-bottom:10px;justify-content:center">
        <span>Open in Xaman — DEX & Swaps (mobile opens app • desktop shows QR)</span>
      </div>

      <a href="https://xumm.app/detect/xapp:xumm.dex" rel="noopener noreferrer"
         class="btn" style="width:100%;max-width:520px;margin:0 auto 10px;border-left:4px solid #10b981;">
        <img src="/xrbc-nft.png" alt="XRBC" width="20" height="20" style="display:inline-block;border-radius:4px" />
        <span>Open in Xaman — Trade XRBC ↔ XRP (DEX)</span>
        <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" width="20" height="20" style="display:inline-block" />
      </a>

      <a href="https://xumm.app/detect/xapp:anodos.swap" rel="noopener noreferrer"
         class="btn" style="width:100%;max-width:520px;margin:0 auto 10px;border-left:4px solid #38bdf8;">
        <img src="/xrbc-nft.png" alt="XRBC" width="20" height="20" style="display:inline-block;border-radius:4px" />
        <span>Open in Xaman — ANODOS Swap (XRBC ↔ XRP)</span>
        <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" width="20" height="20" style="display:inline-block" />
      </a>

      <a href="https://xumm.app/detect/xapp:magnetic.dex" rel="noopener noreferrer"
         class="btn" style="width:100%;max-width:520px;margin:0 auto 10px;border-left:4px solid #1e3a8a;">
        <img src="/xrbc-nft.png" alt="XRBC" width="20" height="20" style="display:inline-block;border-radius:4px" />
        <span>Open in Xaman — Magnetic (XRBC ↔ XRP)</span>
        <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" width="20" height="20" style="display:inline-block" />
      </a>

      <div class="fine" style="margin-top:8px;color:#93a3af;font-size:12px;line-height:1.4;">
        Notes: Anodos and Magnetic open as xApps in Xaman. Pair deep-linking to XRBC/XRP isn’t publicly documented by providers; you may need to select the pair in-app.
        “XRP” and the XRP logo are trademarks of Ripple Labs, Inc. “Xaman (Xumm)” is a product of XRPL Labs. No affiliation or endorsement implied.
      </div>
    </div>

    <!-- Wallet card -->
    <div class="card wallet-card" style="margin:16px 0 20px;">
      <h2 class="wallet-title">
        <img src="/xrbc-nft.png" alt="XRBC logo" width="22" height="22">
        <span>Connect wallet to the XRBC decentralized exchange</span>
      </h2>

      <div class="wallet-actions" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:10px 0 12px;">
        <div class="dl-wrap">
          <button id="btnDownloadXaman" class="btn glow glow-white" aria-expanded="false" type="button">
            Download Xaman
          </button>
          <div id="downloadPopover" class="qr-popover collapse" role="region"
               aria-label="Download Xaman QR" aria-hidden="true" hidden>
            <div class="qr">
              <img id="downloadQr" alt="Scan to download Xaman" width="180" height="180" decoding="async" loading="eager">
            </div>
            <div class="label">Scan to download Xaman Wallet</div>
          </div>
       </div>

        <button id="connectWalletBtn" class="btn glow glow-green" type="button">Connect Wallet</button>
        <button id="setTrustlineBtn" class="btn glow glow-yellow" type="button">Set XRBC Trustline</button>
        <button id="disconnectWalletBtn" class="btn glow glow-red" type="button" disabled>Disconnect</button>
      </div>

      <p id="walletStatus" class="status-text">Status: Not connected</p>
      <div id="trustlineMsg" class="status-text" style="margin-top:8px;"></div>
    </div>

    <!-- ===== Trading UI (exchange style) ===== -->
    <section class="trade-card" id="tradeCard" aria-label="XRBC Trading">

      <!-- Tiny pair badge -->
      <div class="trade-logo" style="gap:10px;">
        <span class="asset-chip asset-xrbc">
          <img src="/xrbc-nft.png" alt="XRBC"> XRBC
        </span>
        <span class="nowrap">/</span>
        <span class="asset-chip asset-xrp">
          <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP"> XRP
        </span>
      </div>

      <!-- BUY/SELL -->
      <div class="tabset" role="tablist" aria-label="Choose buy or sell">
        <button id="buyTab" class="tab buy active" type="button" role="tab" aria-selected="true">Buy XRBC</button>
        <button id="sellTab" class="tab sell" type="button" role="tab" aria-selected="false">Sell XRBC</button>
      </div>

      <!-- Side explanation -->
      <div class="side-explain" id="sideExplain" aria-live="polite">
        <div class="note buy active" data-side="buy">
          <span class="copy">
            <strong>Buying XRBC:</strong>
            You’re trading
            <span class="asset-chip asset-xrp">
              <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP
            </span>
            to receive
            <span class="asset-chip asset-xrbc">
              <img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC
            </span>.
          </span>
        </div>

        <div class="note sell" data-side="sell" hidden>
          <span class="copy">
            <strong>Selling XRBC:</strong>
            You’re trading
            <span class="asset-chip asset-xrbc">
              <img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC
            </span>
            to receive
            <span class="asset-chip asset-xrp">
              <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP
            </span>.
          </span>
        </div>
      </div>

      <!-- AMOUNT -->
      <div class="field">
        <label for="amount" id="amountLabel">Amount (XRBC)</label>
        <div class="amount-row">
          <img src="/xrbc-nft.png" alt="XRBC logo">
          <input id="amount" type="number" step="0.000001" inputmode="decimal" placeholder="0.000000">
        </div>

        <div class="quick-amounts" role="group" aria-label="Quick amount">
          <button class="qa" data-q="25" type="button">25%</button>
          <button class="qa" data-q="50" type="button">50%</button>
          <button class="qa" data-q="75" type="button">75%</button>
          <button class="qa" data-q="100" type="button">100%</button>
        </div>

        <div class="inline-hint" id="amountHint" style="margin-top:6px">
          How many XRBC you want to <span id="actionWord">buy</span>.
          <span class="nowrap">You’re trading
            <span class="asset-chip asset-xrp">
              <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP
            </span>
            to receive
            <span class="asset-chip asset-xrbc">
              <img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC
            </span>.
          </span>
        </div>
      </div>

      <!-- Best Price -->
      <div class="best-price-strip" style="margin-top:10px">
        <button class="btn best-price-btn" id="suggestPriceBtn" type="button">Best Price (AMM)</button>
        <div class="hint">Auto-updates every 10s after you enter an <strong>Amount</strong>.</div>
      </div>

      <!-- PRICE (Limit) -->
      <div class="field" id="priceField">
        <label for="price">Price (XRP per XRBC)</label>
        <input id="price" type="number" step="0.000001" inputmode="decimal" placeholder="e.g., 0.500000">
        <div class="inline-hint">Limit price. (Use Best Price to estimate from AMM.)</div>
      </div>

      <!-- TOTAL -->
      <div class="total-line" aria-live="polite">
        <span>Total</span>
        <strong id="totalXrp">0.000000 XRP</strong>
      </div>

      <!-- Submit -->
      <div class="button-row">
        <button id="placeOfferBtn" class="btn btn-primary" type="button">Place Limit Order</button>

        <div class="refresh-indicator" aria-hidden="true">
          <div class="clock"></div>
          <span class="refresh-text">Auto-refresh every 10s</span>
        </div>

        <!-- New market trade button (IOC) -->
      <button id="marketTradeBtn" class="btn btn-primary" type="button">Market Swap (AMM)</button>
      </div>

      <p id="tradeMsg" class="status-text">—</p>

      <select id="side" hidden>
        <option value="buy" selected>Buy</option>
        <option value="sell">Sell</option>
      </select>
      <input id="orderType" type="hidden" value="limit">
    </section>

    <!-- ===== XRBC DEX — Live Metrics (compact) ===== -->
    <section class="card compact-metrics" id="xrbcDexHero" aria-label="XRBC DEX — Live Metrics">
      <div class="metrics-header">
        <h2>
          <img src="/xrbc-nft.png" alt="XRBC" width="24" height="24" style="border-radius:6px;border:1px solid var(--line)">
          XRBC DEX — Live Metrics
        </h2>
      </div>

      <div class="metrics-grid">
        <div class="metrics-block">
          <h3>XRBC/XRP Order Book</h3>
          <div id="priceOutput" class="book-compact">—</div>
        </div>
        <div class="metrics-block">
          <h3>Ledger</h3>
          <pre id="ledgerOutput" class="ledger-compact">—</pre>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Config ===== -->
  <script type="application/json" id="app-config">
  {
    "xummApiKey": "2abde023-0df1-49a2-a4dc-86d776f6318d",
    "proxyUrl": "https://xrbitcoincash-github-io.onrender.com"
  }
  </script>

  <!-- Xaman SDK -->
  <script src="https://xaman.app/assets/cdn/xumm.min.js"></script>

  <!-- ===== Page Script ===== -->
  <script>
(function(){
  /* ===== Utilities / Config ===== */
  const cfgNode = document.getElementById("app-config");
  const cfg = cfgNode ? JSON.parse(cfgNode.textContent || "{}") : {};
  const PROXY_URL = cfg.proxyUrl || "";
  const XRP_TO_DROPS = 1_000_000;

  const XRBC = {
    currency: "5852626974636F696E6361736800000000000000",
    issuer:   "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw"
  };

  async function xrplRequest(payload){
    if (!PROXY_URL) throw new Error("Proxy URL missing");
    const res = await fetch(PROXY_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("Proxy HTTP " + res.status);
    const data = await res.json();
    if (data && data.error) throw new Error("XRPL: " + JSON.stringify(data.error));
    return data;
  }
  const toDrops = (xrp) => Math.round(Number(xrp) * XRP_TO_DROPS).toString();

  /* ===== Theme toggle ===== */
  (function themeInit(){
    const btn = document.getElementById('themeToggle');
    const saved = localStorage.getItem('xrbc-theme');
    if (saved === 'light') document.body.classList.add('light-mode');
    const sync = () => btn && btn.setAttribute('aria-pressed', document.body.classList.contains('light-mode') ? 'true' : 'false');
    sync();
    if (btn){
      btn.addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('xrbc-theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        sync();
      });
    }
  })();

  /* ===== Download Xaman popover ===== */
  (function initDownloadPopover(){
    const wrap = document.querySelector(".dl-wrap");
    if (!wrap) return;

    const DOWNLOAD_URL = "https://xaman.app/download";
    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

    const downloadBtn = document.getElementById("btnDownloadXaman");
    const pop = document.getElementById("downloadPopover");
    const qrImg = document.getElementById("downloadQr");

    if (!downloadBtn || !pop) return;

    if (qrImg && !qrImg.src){
      qrImg.src = "https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=" + encodeURIComponent(DOWNLOAD_URL);
    }

    function openPopover(){
      pop.hidden = false;
      pop.classList.add("open");
      pop.setAttribute("aria-hidden","false");
      downloadBtn.setAttribute("aria-expanded","true");
    }
    function closePopover(){
      pop.classList.remove("open");
      pop.setAttribute("aria-hidden","true");
      downloadBtn.setAttribute("aria-expanded","false");
      setTimeout(() => { if (!pop.classList.contains("open")) pop.hidden = true; }, 300);
    }

    downloadBtn.addEventListener("click", (e) => {
      if (isMobile) { window.location.href = DOWNLOAD_URL; return; }
      e.preventDefault();
      (pop.classList.contains("open") ? closePopover : openPopover)();
    });

    document.addEventListener("click", (e) => {
      if (pop.hidden) return;
      if (!wrap.contains(e.target)) closePopover();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !pop.hidden) closePopover();
    });
  })();

  /* ===== Xumm SDK: connect / disconnect / trustline ===== */
  let xumm = null;
  const walletStatus  = document.getElementById("walletStatus");
  const trustlineMsg  = document.getElementById("trustlineMsg");
  const connectBtn    = document.getElementById("connectWalletBtn");
  const disconnectBtn = document.getElementById("disconnectWalletBtn");
  const setTrustBtn   = document.getElementById("setTrustlineBtn");

  function setConnectedUI(acct){
    if (walletStatus) walletStatus.textContent = "Connected: " + acct;
    window.__xrbcWallet = acct;
    localStorage.setItem("xrbcWallet", acct);
    if (disconnectBtn) disconnectBtn.disabled = false;
    if (connectBtn) connectBtn.disabled = true;
  }
  function setDisconnectedUI(){
    if (walletStatus) walletStatus.textContent = "Status: Not connected";
    window.__xrbcWallet = null;
    localStorage.removeItem("xrbcWallet");
    if (disconnectBtn) disconnectBtn.disabled = true;
    if (connectBtn) connectBtn.disabled = false;
  }

  if (typeof Xumm !== 'undefined'){
    xumm = new Xumm(cfg.xummApiKey);

    const savedAcct = localStorage.getItem("xrbcWallet");
    if (savedAcct) setConnectedUI(savedAcct);

    xumm.on("ready", async () => {
      try{
        const acct = await xumm.user.account;
        if (acct) setConnectedUI(acct);
      } catch {}
    });

    window.addEventListener("visibilitychange", () => { if (!document.hidden) { xumm.user.account.then(a => a && setConnectedUI(a)).catch(()=>{}); } });
    window.addEventListener("focus", () => { xumm.user.account.then(a => a && setConnectedUI(a)).catch(()=>{}); });

    if (connectBtn) connectBtn.addEventListener("click", async () => {
      try {
        if (walletStatus) walletStatus.textContent = "Waiting for Xaman… (scan QR if shown)";
        await xumm.authorize();
        const acct = await xumm.user.account;
        if (acct) setConnectedUI(acct);
        else if (walletStatus) walletStatus.textContent = "Still waiting for Xaman…";
      } catch {
        if (walletStatus) walletStatus.textContent = "Failed to connect wallet";
      }
    });

    if (disconnectBtn) disconnectBtn.addEventListener("click", () => {
      setDisconnectedUI();
      try { xumm.logout(); } catch {}
    });

    if (setTrustBtn) setTrustBtn.addEventListener("click", async () => {
      try {
        const acct = window.__xrbcWallet || (xumm && await xumm.user.account);
        if (!acct) {
          if (trustlineMsg) trustlineMsg.textContent = "Please connect your wallet first, then try again.";
          if (connectBtn) connectBtn.focus();
          return;
        }
        if (trustlineMsg) trustlineMsg.textContent = "Preparing trustline request…";
        setTrustBtn.disabled = true;

        const txjson = {
          TransactionType: "TrustSet",
          Account: acct,
          LimitAmount: { currency: XRBC.currency, issuer: XRBC.issuer, value: "21000000" }
        };

        const { resolved } = await xumm.payload.createAndSubscribe({ txjson }, (ev) => {
          if (ev?.opened && trustlineMsg) trustlineMsg.textContent = "Open Xaman (or scan QR) to review…";
          if (ev?.signed === false && trustlineMsg) trustlineMsg.textContent = "Trustline rejected. You can try again.";
        });

        const result = await resolved;
        if (!result?.signed) { if (trustlineMsg) trustlineMsg.textContent = "Trustline not signed."; return; }
        if (trustlineMsg) trustlineMsg.textContent = "✅ Trustline set successfully!";
      } catch (err) {
        if (trustlineMsg) trustlineMsg.textContent = "Error: " + (err?.message || err);
      } finally {
        setTrustBtn.disabled = false;
      }
    });
  } else {
    console.warn("Xumm SDK not loaded — wallet actions disabled.");
    if (connectBtn) connectBtn.disabled = true;
    if (setTrustBtn) setTrustBtn.disabled = true;
    if (trustlineMsg) trustlineMsg.textContent = "Wallet features unavailable: Xaman SDK not loaded.";
  }

  /* ===== Trading UI ===== */
  const sideEl        = document.getElementById("side");
  const tradeCard     = document.getElementById("tradeCard");
  const buyTab        = document.getElementById("buyTab");
  const sellTab       = document.getElementById("sellTab");
  const amountEl      = document.getElementById("amount");
  const priceEl       = document.getElementById("price");
  const priceField    = document.getElementById("priceField");
  const totalXrpEl    = document.getElementById("totalXrp");
  const suggestBtn    = document.getElementById("suggestPriceBtn");
  const placeOfferBtn = document.getElementById("placeOfferBtn");
  const marketBtn     = document.getElementById("marketTradeBtn");
  const tradeMsg      = document.getElementById("tradeMsg");

  function updateExplainer(side){
    const wrap = document.getElementById("sideExplain");
    if (!wrap) return;
    const buyNote  = wrap.querySelector('.note.buy');
    const sellNote = wrap.querySelector('.note.sell');
    const showBuy = (side === 'buy');
    if (buyNote){
      buyNote.hidden = !showBuy;
      buyNote.classList.toggle('active', showBuy);
      buyNote.setAttribute('aria-hidden', (!showBuy).toString());
    }
    if (sellNote){
      sellNote.hidden = showBuy;
      sellNote.classList.toggle('active', !showBuy);
      sellNote.setAttribute('aria-hidden', (showBuy).toString());
    }
    const hint = document.getElementById('amountHint');
    const label = document.getElementById('amountLabel');
    if (label) label.textContent = 'Amount (XRBC)';
    if (hint){
      hint.innerHTML = (side === 'buy')
        ? `How many XRBC you want to <span id="actionWord">buy</span>. <span class="nowrap">You’re trading <span class="asset-chip asset-xrp"><img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP</span> to receive <span class="asset-chip asset-xrbc"><img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC</span>.</span>`
        : `How many XRBC you want to <span id="actionWord">sell</span>. <span class="nowrap">You’re trading <span class="asset-chip asset-xrbc"><img src="/xrbc-nft.png" alt="XRBC" style="height:1.05em;width:auto;vertical-align:-.2em;border-radius:3px"> XRBC</span> to receive <span class="asset-chip asset-xrp"><img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" style="height:1.05em;width:auto;vertical-align:-.2em;background:#fff;border-radius:3px;padding:1px"> XRP</span>.</span>`;
    }
  }

  function setSide(side){
    if (sideEl) sideEl.value = side;
    if (buyTab)  { buyTab.classList.toggle("active", side==='buy');  buyTab.setAttribute('aria-selected', side==='buy' ? 'true':'false'); }
    if (sellTab) { sellTab.classList.toggle("active", side==='sell'); sellTab.setAttribute('aria-selected', side==='sell' ? 'true':'false'); }
    if (tradeCard){
      tradeCard.classList.toggle('buy', side==='buy');
      tradeCard.classList.toggle('sell', side==='sell');
    }
    updateExplainer(side);
    recalcTotals();
  }

  if (buyTab)  buyTab.addEventListener('click', () => setSide('buy'));
  if (sellTab) sellTab.addEventListener('click', () => setSide('sell'));
  setSide(sideEl?.value || 'buy');

  function recalcTotals(){
    if (!totalXrpEl) return;
    const amt = Number(amountEl?.value) || 0;
    const px  = Number(priceEl?.value)  || 0;
    const total = (px || 0) * amt;
    totalXrpEl.textContent = (isFinite(total) ? total : 0).toFixed(6) + " XRP";
  }
  if (amountEl) amountEl.addEventListener("input", recalcTotals);
  if (priceEl)  priceEl.addEventListener("input", recalcTotals);

  /* Wallet-aware balances for % chips */
  const BAL = { xrp: 0, xrbc: 0 };
  const RESERVE_BUFFER_XRP = 1.0;
  const normalizeHexCurrency = (s) => (s || '').toUpperCase().replace(/0+$/,'');
  const XRBC_HEX_NORM = normalizeHexCurrency(XRBC.currency);

  async function fetchBalances(){
    const acct = window.__xrbcWallet;
    if (!acct) { BAL.xrp = 0; BAL.xrbc = 0; return BAL; }

    try {
      const info = await xrplRequest({
        method: "account_info",
        params: [{ account: acct, ledger_index: "validated" }]
      });
      BAL.xrp = Number(info?.result?.account_data?.Balance || 0) / XRP_TO_DROPS;
    } catch { BAL.xrp = 0; }

    try {
      const lines = await xrplRequest({
        method: "account_lines",
        params: [{ account: acct, peer: XRBC.issuer, ledger_index: "validated" }]
      });
      const tl = (lines?.result?.lines || []).find(l =>
        normalizeHexCurrency(l.currency) === XRBC_HEX_NORM
      );
      BAL.xrbc = tl ? Math.max(0, Number(tl.balance || 0)) : 0;
    } catch { BAL.xrbc = 0; }

    return BAL;
  }

  (function initPercentChips(){
    const chips = document.querySelectorAll('.quick-amounts .qa');
    if (!chips.length) return;

    async function applyPercent(pct){
      const side = sideEl?.value || 'buy';
      await fetchBalances();

      if (side === 'sell'){
        const amt = Math.max(0, BAL.xrbc * (pct/100));
        if (amountEl){
          amountEl.value = amt.toFixed(6);
          amountEl.dispatchEvent(new Event('input'));
        }
        return;
      }

      let price = Number(priceEl?.value) || 0;
      if (!price) { await fillBestPrice(); price = Number(priceEl?.value) || 0; }
      if (!price || price <= 0) return;

      const spendable = Math.max(0, (BAL.xrp - RESERVE_BUFFER_XRP)) * (pct/100);
      const amt = spendable > 0 ? (spendable / price) : 0;

      if (amountEl){
        amountEl.value = amt.toFixed(6);
        amountEl.dispatchEvent(new Event('input'));
      }
    }

    chips.forEach(btn => btn.addEventListener('click', async () => {
      const pct = Number(btn.dataset.q || 0);
      if (!pct) return;
      btn.disabled = true;
      try { await applyPercent(pct); }
      finally { btn.disabled = false; }
    }));
  })();

  /* Pricing helpers */
  async function getTopOfBook(){
    const [askRes, bidRes] = await Promise.all([
      xrplRequest({ method:"book_offers", params:[{ taker_gets: XRBC,             taker_pays: { currency:"XRP" }, limit:1 }] }),
      xrplRequest({ method:"book_offers", params:[{ taker_gets: { currency:"XRP"}, taker_pays: XRBC,             limit:1 }] })
    ]);
    const priceFrom = (of) => {
      if (!of) return null;
      const gets = of.TakerGets?.value ? parseFloat(of.TakerGets.value) : parseFloat(of.TakerGets) / XRP_TO_DROPS;
      const pays = of.TakerPays?.value ? parseFloat(of.TakerPays.value) : parseFloat(of.TakerPays) / XRP_TO_DROPS;
      if (!isFinite(gets) || gets <= 0 || !isFinite(pays)) return null;
      return pays / gets; // XRP per XRBC
    };
    return {
      bestAsk: priceFrom(askRes?.result?.offers?.[0]) || null, // price you pay to buy XRBC
      bestBid: priceFrom(bidRes?.result?.offers?.[0]) || null  // price you receive when selling XRBC
    };
  }

  async function getMarketPrice(side){
    // Try AMM first
    try {
      const data = await xrplRequest({
        method: "amm_info",
        params: [{ asset:{currency:"XRP"}, asset2:{currency:XRBC.currency, issuer:XRBC.issuer} }]
      });
      const amm = data?.result?.amm;
      if (amm && amountEl){
        const amt = Number(amountEl.value);
        if (amt > 0){
          const reserveXrp  = parseFloat(amm.amount) / XRP_TO_DROPS;
          const reserveXrbc = parseFloat(amm.amount2.value);
          const feeRate     = amm.trading_fee / 1_000_000;
          const k = reserveXrp * reserveXrbc;
          if (side === "buy"){
            const newY = reserveXrbc - amt;
            if (newY > 0){
              const newX = k / newY;
              let xrpIn = newX - reserveXrp;
              xrpIn += xrpIn * feeRate;
              return xrpIn / amt;
            }
          } else {
            const newY = reserveXrbc + amt;
            const newX = k / newY;
            let xrpOut = reserveXrp - newX;
            xrpOut -= xrpOut * feeRate;
            return xrpOut / amt;
          }
        }
      }
    } catch {}

    // Fallback: top of book
    const { bestAsk, bestBid } = await getTopOfBook();
    return side === "buy" ? bestAsk : bestBid;
  }

  /* AMM-based price helper for the visible Price field */
  async function fillBestPrice() {
    if (!sideEl || !amountEl || !priceEl) return;
    const side = sideEl.value;
    const amount = Number(amountEl.value);
    if (!amount || amount <= 0) {
      if (tradeMsg){ tradeMsg.textContent = "Enter a valid XRBC amount."; tradeMsg.classList.remove("ok","err","connecting"); }
      return;
    }
    if (tradeMsg){ tradeMsg.textContent = "🔐 Connecting to XRPL for secure best price…"; tradeMsg.classList.remove("ok","err"); tradeMsg.classList.add("connecting"); }

    try {
      const px = await getMarketPrice(side);
      if (!px || px <= 0) throw new Error("No price available");
      priceEl.value = Number(px).toFixed(6);
      recalcTotals();
      if (tradeMsg){ tradeMsg.textContent = `Best price calculated from AMM/top-of-book (${side}).`; tradeMsg.classList.remove("connecting"); tradeMsg.classList.add("ok"); }
    } catch (err) {
      if (tradeMsg){ tradeMsg.textContent = "Price helper error: " + (err?.message || err); tradeMsg.classList.remove("connecting"); tradeMsg.classList.add("err"); }
    }
  }
  if (suggestBtn) suggestBtn.addEventListener("click", fillBestPrice);
  setInterval(() => {
    const amt = Number(amountEl?.value);
    if (amt > 0) fillBestPrice().catch(()=>{});
  }, 10000);

  /* Place Limit Order (existing) */
  if (placeOfferBtn) placeOfferBtn.addEventListener("click", async () => {
    try {
      if (!xumm) throw new Error("Wallet SDK not available.");
      const account = window.__xrbcWallet;
      if (!account) throw new Error("Connect your wallet first.");

      const side   = sideEl?.value;
      const amt    = Number(amountEl?.value);
      const priceV = Number(priceEl?.value);

      if (!amt || !priceV || amt <= 0 || priceV <= 0) throw new Error("Enter valid Amount & Price.");

      const xrpTotal = priceV * amt;
      const TF_SELL = 0x00080000;

      let txjson;
      if (side === "sell") {
        txjson = {
          TransactionType: "OfferCreate",
          Account: account,
          TakerGets: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amt) },
          TakerPays: toDrops(xrpTotal),
          Flags: TF_SELL
        };
      } else {
        txjson = {
          TransactionType: "OfferCreate",
          Account: account,
          TakerGets: toDrops(xrpTotal),
          TakerPays: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amt) },
          Flags: 0
        };
      }

      if (tradeMsg) { tradeMsg.textContent = "Open Xaman to review & sign…"; tradeMsg.classList.remove("err"); }
      const { resolved } = await xumm.payload.createAndSubscribe({ txjson }, (ev) => {
        if (ev?.opened && tradeMsg) tradeMsg.textContent = "Payload opened in Xaman…";
        if (ev?.signed === false && tradeMsg) tradeMsg.textContent = "Order rejected.";
      });

      const result = await resolved;
      if (!result.signed) { if (tradeMsg) tradeMsg.textContent = "Order not signed."; return; }

      if (tradeMsg) tradeMsg.textContent = "Order submitted. Refreshing order book…";
      await refreshOrderBook();
    } catch (err) {
      if (tradeMsg) tradeMsg.textContent = "Error: " + (err?.message || err);
    }
  });

  /* ===== Market Swap (AMM path Payment) ===== */
  if (marketBtn) marketBtn.addEventListener("click", async () => {
    const SLIPPAGE_PCT = 2; // protective cap
    try {
      if (!xumm) throw new Error("Wallet SDK not available.");
      const account = window.__xrbcWallet;
      if (!account) throw new Error("Connect your wallet first.");

      const side = sideEl?.value || "buy";
      const amt  = Number(amountEl?.value);
      if (!amt || amt <= 0) throw new Error("Enter valid Amount.");

      // Get a reference price to compute slippage bounds
      const basePx = await getMarketPrice(side);
      if (!basePx || basePx <= 0) throw new Error("No market price available.");
      const slip = SLIPPAGE_PCT / 100;

      // Helpers
      const TF_PARTIAL = 0x00020000; // tfPartialPayment
      const ceilDrops  = (xrp) => Math.ceil(Number(xrp) * XRP_TO_DROPS).toString();
      const floorDrops = (xrp) => Math.floor(Number(xrp) * XRP_TO_DROPS).toString();

      // === Path-find ===
      async function ripplePathFind(params){
        const r = await xrplRequest({ method: "ripple_path_find", params: [params] });
        const alts = r?.result?.alternatives || [];
        if (!alts.length) throw new Error("No AMM/paths available for this amount.");
        return alts;
      }
      function pickCheapestXrp(alts){
        // Choose alternative with lowest XRP cost
        let best = null, bestCostDrops = Infinity;
        for (const alt of alts){
          const sa = alt.source_amount;
          let costDrops = Infinity;
          if (typeof sa === "string"){
            costDrops = Number(sa); // XRP drops
          } else if (sa && sa.currency === "XRP"){
            costDrops = Number(ceilDrops(sa.value));
          }
          if (Number.isFinite(costDrops) && costDrops < bestCostDrops){
            best = alt; bestCostDrops = costDrops;
          }
        }
        if (!best) throw new Error("Could not price a path with XRP.");
        return { best, costDrops: bestCostDrops.toString() };
      }
      function pickCheapestIou(alts, iouCurrencyHex, iouIssuer){
        // Choose alternative with lowest IOU cost (for selling XRBC)
        let best = null, bestCost = Infinity;
        for (const alt of alts){
          const sa = alt.source_amount;
          if (sa && typeof sa === "object" && sa.currency && sa.issuer){
            const isXRBC = (sa.issuer === iouIssuer) &&
              (String(sa.currency).toUpperCase() === String(iouCurrencyHex).toUpperCase());
            if (isXRBC){
              const v = Number(sa.value);
              if (Number.isFinite(v) && v < bestCost){ best = alt; bestCost = v; }
            }
          }
        }
        if (!best) throw new Error("Could not price a path with XRBC as source.");
        return { best, cost: bestCost };
      }

      let txjson;

      if (side === "buy"){
        // Buy XRBC using XRP → set Amount in XRBC, cap SendMax in XRP, allow partial with DeliverMin
        const destAmt = { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amt) };
        const alts = await ripplePathFind({
          source_account: account,
          destination_account: account,
          destination_amount: destAmt,
          source_currencies: [{ currency: "XRP" }]
        });
        const { best, costDrops } = pickCheapestXrp(alts);
        const maxSpendDrops = Math.ceil(Number(costDrops) * (1 + slip)).toString();

        txjson = {
          TransactionType: "Payment",
          Account: account,
          Destination: account,
          Amount: destAmt,
          SendMax: maxSpendDrops, // XRP in drops
          Flags: TF_PARTIAL,
          DeliverMin: { currency: XRBC.currency, issuer: XRBC.issuer, value: (amt * (1 - slip)).toFixed(6) },
          Paths: best.paths_computed || best.paths_canonical || []
        };
      } else {
        // Sell XRBC to receive XRP → set Amount in XRP, cap SendMax in XRBC, require DeliverMin
        const estXrp = amt * basePx;
        const minXrpDrops = floorDrops(estXrp * (1 - slip));

        // Guard against 0-drop rounding
        let _min = Number(minXrpDrops);
        if (_min < 1) throw new Error("Amount too small after slippage. Increase amount.");
        const minDrops = String(_min);

        const alts = await ripplePathFind({
          source_account: account,
          destination_account: account,
          destination_amount: minDrops, // XRP drops as target
          source_currencies: [{ currency: XRBC.currency, issuer: XRBC.issuer }]
        });
        const { best, cost } = pickCheapestIou(alts, XRBC.currency, XRBC.issuer);
        if (cost > amt) throw new Error("Amount too small for slippage cap. Increase amount or relax slippage.");

        txjson = {
          TransactionType: "Payment",
          Account: account,
          Destination: account,
          Amount: minDrops, // XRP in drops
          SendMax: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amt) },
          Flags: TF_PARTIAL,
          DeliverMin: minDrops,
          Paths: best.paths_computed || best.paths_canonical || []
        };
      }

      if (tradeMsg){ tradeMsg.textContent = "Open Xaman to review & sign AMM swap…"; tradeMsg.classList.remove("err"); }
      const { resolved } = await xumm.payload.createAndSubscribe({ txjson }, (ev) => {
        if (ev?.opened && tradeMsg) tradeMsg.textContent = "Payload opened in Xaman…";
        if (ev?.signed === false && tradeMsg) tradeMsg.textContent = "Swap rejected.";
      });

      const result = await resolved;
      if (!result.signed) { if (tradeMsg) tradeMsg.textContent = "Swap not signed."; return; }

      if (tradeMsg) tradeMsg.textContent = "Swap submitted. Refreshing…";
      await refreshOrderBook();
    } catch (err) {
      if (tradeMsg) tradeMsg.textContent = "Error: " + (err?.message || err);
    }
  });

  /* ===== Live Metrics: Ledger + Order Book ===== */
  const ledgerOut = document.getElementById("ledgerOutput");
  const bookOut   = document.getElementById("priceOutput");

  async function getLedgerSummary(){
    const res = await xrplRequest({ method: "ledger", params: [{ ledger_index: "validated" }] });
    const r = res?.result || {};
    const idx   = r.ledger_index || r.validated_ledger_index || r.ledger?.ledger_index;
    const hash  = r.ledger_hash  || r.ledger?.ledger_hash;
    const close = r.ledger?.close_time_human || r.closed?.close_time_human;
    return {
      ledger_index: idx ?? "(unknown)",
      ledger_hash : hash ?? "(unknown)",
      close_time  : close || "(not expanded)",
      validated   : r.validated === undefined ? true : !!r.validated
    };
  }

  async function getOrderBookHtml(){
    async function side(taker_gets, taker_pays, label){
      const rows = [];
      try{
        const r = await xrplRequest({ method:"book_offers", params:[{ taker_gets, taker_pays, limit:5 }] });
        const offers = r?.result?.offers || [];
        if (!offers.length){
          rows.push(`<tr><td>${label}</td><td>No offers</td><td>-</td></tr>`);
        } else {
          for (const ofr of offers){
            const gets = ofr.TakerGets?.value ? parseFloat(ofr.TakerGets.value)
                                              : parseFloat(ofr.TakerGets) / XRP_TO_DROPS;
            const pays = ofr.TakerPays?.value ? parseFloat(ofr.TakerPays.value)
                                              : parseFloat(ofr.TakerPays) / XRP_TO_DROPS;
            const price = (isFinite(gets) && gets > 0) ? (pays / gets) : NaN;
            rows.push(`<tr><td>${label}</td><td>${isFinite(price)?price.toFixed(6):"—"}</td><td>${isFinite(gets)?gets.toFixed(2):"—"}</td></tr>`);
          }
        }
      } catch (e){
        rows.push(`<tr><td>${label}</td><td>Error</td><td>${(e && e.message) || e}</td></tr>`);
      }
      return rows.join("");
    }
    const asks = await side(XRBC, { currency: "XRP" }, "Ask");
    const bids = await side({ currency: "XRP" }, XRBC, "Bid");
    return `
      <div style="overflow:auto">
        <table class="table">
          <thead><tr><th>Side</th><th>Price (XRP/XRBC)</th><th>Amount</th></tr></thead>
          <tbody>${asks}${bids}</tbody>
        </table>
      </div>
    `;
  }

  async function refreshLedger(){
    try {
      const sum = await getLedgerSummary();
      if (ledgerOut) ledgerOut.textContent = JSON.stringify(sum, null, 2);
    } catch (e) {
      if (ledgerOut) ledgerOut.textContent = "Error fetching ledger: " + (e?.message || e);
    }
  }
  async function refreshOrderBook(){
    try {
      const html = await getOrderBookHtml();
      if (bookOut) bookOut.innerHTML = html;
    } catch (e) {
      if (bookOut) bookOut.textContent = "Order book error: " + (e?.message || e);
    }
  }
  async function refreshAll(){
    await Promise.allSettled([ refreshOrderBook(), refreshLedger() ]);
  }

  // First paint + gentle auto-refresh
  refreshAll().catch(()=>{});
  document.addEventListener("visibilitychange", () => { if (!document.hidden) refreshAll().catch(()=>{}); });
  window.addEventListener("focus", () => refreshAll().catch(()=>{}));
  setInterval(() => { refreshAll().catch(()=>{}); }, 15000);
})();

  </script>

  <!-- ===== XRBC Footer ===== -->
  <footer class="site-footer" role="contentinfo" aria-label="XRBitcoinCash footer">
    <div class="wrap">
      <div class="cols" style="display:grid;gap:18px;grid-template-columns:1fr;max-width:var(--wrap-wide);margin:0 auto;">
        <section>
          <h3>About this page</h3>
          <p class="small">
            A minimal, security-first trading &amp; ledger portal for
            <strong>XRBitcoinCash (XRBC)</strong> on the <span class="nowrap">XRP Ledger</span>.
            Signing is handled in <strong>Xaman</strong> on mobile for safer review and execution.
          </p>
          <dl class="factlist" aria-label="XRBC details" style="display:grid;gap:6px;margin:0">
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Symbol</strong><span class="mono">XRBC</span></div>
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Issuer</strong><span class="mono">rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw</span></div>
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Currency Code</strong><span class="mono">5852626974636F696E6361736800000000000000</span></div>
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Total Supply</strong><span class="mono">21,000,000</span></div>
          </dl>
        </section>

        <section>
          <h3>Security measures</h3>
          <ul class="small" style="list-style:disc;margin-left:18px;display:grid;gap:6px">
            <li><strong>Mobile & desktop signing</strong> via Xaman; desktop shows a QR automatically in the Xaman flow.</li>
            <li>No keys ever requested or stored; only the public account address may be cached (localStorage).</li>
            <li>XRPL calls validated; errors handled; no <span class="mono">eval</span> or dynamic script injection.</li>
            <li>XRBC issuer &amp; currency code are constants; XRP↔drops conversion is precise.</li>
            <li>AMM helper estimates effective price incl. fee.</li>
          </ul>
        </section>

        <section style="display:grid;gap:10px;justify-items:center;">
          <h3>Whitepaper &amp; credits</h3>
          <a class="eco-link" href="/whitepaper.html" aria-label="Open the XRBitcoinCash Whitepaper" style="min-width:200px;">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"></path>
              <path fill="#ffffff" d="M13 2v5h5"></path>
            </svg>
            Whitepaper
          </a>
          <a class="eco-link" href="https://chat.openai.com/" target="_blank" rel="noopener noreferrer" aria-label="Talk to ChatGPT" style="min-width:200px;">
            <img src="/assets/chatgpt-mark.svg" alt="" onerror="this.remove()">
            <span>Built with ChatGPT</span>
          </a>
          <p class="small" style="margin-top:4px;opacity:.9">
            Verify the URL starts with <span class="mono">https://xrbitcoincash.com</span>.
          </p>
        </section>
      </div>

      <div class="legal small" style="border-top:1px dashed #1f2a37;padding-top:10px;display:flex;flex-wrap:wrap;gap:6px;justify-content:space-between;align-items:center">
        <span>XRBC · XRBC/XRP Trading &amp; Ledger Portal</span>
        <span class="mono">Issuer: rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw</span>
      </div>
    </div>
  </footer>
</body>
</html>
```
