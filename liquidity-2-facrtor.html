<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>XRBC · 2FA Test Harness · Xaman + Google/YouTube</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Canonical & Icons -->
  <link rel="canonical" href="https://xrbitcoincash.com/ai/2fa-test.html" />
  <link rel="icon" href="/xrbc-nft.png" sizes="any">
  <link rel="apple-touch-icon" href="/xrbc-nft.png">
  <meta name="theme-color" content="#0b0f14" />

  <!-- SEO -->
  <meta name="description" content="Dual‑factor auth for XRBC apps: Google/YouTube ownership + optional Xaman wallet proof. No secrets in client; server routes supply IDs." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />

  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="XRBC · 2FA Test Harness" />
  <meta property="og:description" content="Google/YouTube + Xaman dual‑factor auth. Single‑file page. No client secrets." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://xrbitcoincash.com/ai/2fa-test.html" />
  <meta property="og:image" content="https://xrbitcoincash.com/xrbc-nft.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="XRBC · 2FA Test Harness" />
  <meta name="twitter:description" content="Google/YouTube + Xaman dual‑factor auth for XRBC apps." />
  <meta name="twitter:image" content="https://xrbitcoincash.com/xrbc-nft.png" />

  <link rel="license" href="#license-proprietary">

  <style>
    /* ===== XRBC Design System (inline, single-file) ===== */
    :root{
      --wrap:1100px; --bg:#0b0f14; --panel:#0e1520; --panel-2:#0c131c; --ink:#e7edf5; --muted:#9fb0c5; --line:#2b3a4b;
      --ok:#22c55e; --err:#ef4444; --blue:#2563eb; --yellow:#f59e0b; --ink-2:#cfe0f7;
      --glow: 0 0 0px rgba(37,99,235,0), 0 0 24px rgba(37,99,235,.12), 0 0 64px rgba(37,99,235,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%;max-width:100%;overflow-x:hidden}
    body{background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0}

    /* Header */
    header{position:sticky;top:0;background:rgba(11,15,20,.90);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--line);z-index:10;box-shadow:var(--glow)}
    .brand{display:grid;place-items:center;padding:12px 0}
    .brand img{width:48px;height:48px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.35)}
    .brand h1{margin:6px 0 0 0;font-size:18px;font-weight:650;letter-spacing:.2px}
    .home{display:block;margin:8px auto 10px auto;text-align:center}
    .home a{color:var(--muted);text-decoration:none;border:1px solid var(--line);padding:6px 12px;border-radius:999px}

    /* Layout */
    .wrap{max-width:var(--wrap);margin:16px auto;padding:0 max(16px, env(safe-area-inset-left))}
    .grid-12{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-12{grid-column:span 12}
    @media(min-width:860px){.col-6{grid-column:span 6}}

    /* Cards & text */
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.20)}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px}
    .kbd{font-variant-ligatures:none;border:1px solid var(--line);border-radius:6px;padding:0 6px;margin:0 2px}

    /* Buttons */
    .row{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    button{appearance:none;background:var(--panel);color:var(--ink);border:1px solid var(--line);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .05s ease, box-shadow .2s ease}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    button.primary{background:var(--blue);border-color:rgba(255,255,255,.08);color:white;box-shadow:0 6px 18px rgba(37,99,235,.25)}
    button.success{background:var(--ok);color:#02140a;border-color:transparent}
    button.warning{background:var(--yellow);color:#0d0b02;border-color:transparent}
    button.ghost{background:transparent;color:var(--ink-2)}
    button:disabled{opacity:.55;cursor:not-allowed}

    /* Status & logs */
    .status{font-size:14px;margin-top:8px}
    .status .ok{color:var(--ok)}
    .status .err{color:var(--err)}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
    .qr{display:grid;place-items:center;margin:10px 0}
    .qr img{width:220px;height:220px;border-radius:12px;border:1px solid var(--line);background:#000}
    .log{white-space:pre-wrap;background:#0a0f16;border:1px solid var(--line);border-radius:12px;padding:12px;max-height:260px;overflow:auto}

    /* Accessibility */
    [aria-live]{min-height:1.2em}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Helper layout blocks */
    .stack{display:flex;flex-direction:column;gap:10px}
    .flex{display:flex;gap:8px;align-items:center}
  </style>

  <!-- JSON-LD (informational) -->
  <script type="application/ld+json">{
    "@context":"https://schema.org","@type":"WebApplication","name":"XRBC 2FA Test Harness",
    "url":"https://xrbitcoincash.com/ai/2fa-test.html","applicationCategory":"SecurityApplication",
    "operatingSystem":"Web","author":{"@type":"Organization","name":"XRBitcoinCash"}
  }</script>
</head>
<body>
  <header>
    <div class="brand">
      <img src="/xrbc-nft.png" alt="XRBC logo" />
      <h1>XRBitcoinCash · 2FA Test Harness</h1>
    </div>
    <div class="home"><a href="https://xrbitcoincash.com/">Home</a></div>
  </header>

  <main class="wrap">
    <div class="grid-12">
      <section class="card col-12">
        <div class="flex" style="justify-content:space-between">
          <h2>Overview</h2>
          <span id="auth2faStatus" class="pill" data-state="need" aria-live="polite">2FA: sign in required</span>
        </div>
        <p class="muted">No client placeholders. The server supplies Google Client ID and Xaman payload via routes. Desktop = QR only; Mobile = deep‑link. Buttons marked <span class="mono">data-need-2fa</span> remain disabled until verified.</p>
        <ul class="muted">
          <li><strong>Google/YouTube proof</strong> → OAuth PKCE; server exchanges code; verifies <span class="mono">channels?mine=true</span>.</li>
          <li><strong>Xaman SignIn</strong> (optional second factor) → QR/deep‑link; websocket/poll for signed.</li>
          <li>Bind/verify bundles let your backend enroll or gate sessions.</li>
        </ul>
      </section>

      <!-- Step 1: Xaman wallet proof -->
      <section class="card col-12 col-6" id="xamanCard">
        <h2>Step 1 · Xaman wallet proof</h2>
        <p class="muted">Server route: <span class="mono">POST /xaman/create</span> → returns <span class="mono">deepLink</span>, <span class="mono">qrPng</span>, <span class="mono">wsUrl</span>.</p>
        <div class="row">
          <button id="btnXamanDesktop" class="primary">Desktop: Show QR</button>
          <button id="btnXamanMobile">Mobile: Open Xaman</button>
          <button id="btnXamanReset" class="warning" disabled>Reset</button>
        </div>
        <div class="qr" id="xamanQr" hidden></div>
        <div class="status" id="xamanStatus" aria-live="polite">State: <span class="mono">idle</span></div>
        <div class="log mono" id="xamanLog" aria-live="polite"></div>
      </section>

      <!-- Step 2: Google/YouTube proof -->
      <section class="card col-12 col-6" id="googleCard">
        <h2>Step 2 · Google/YouTube ownership</h2>
        <p class="muted">Routes: <span class="mono">GET /auth/google/client-id</span> and <span class="mono">POST /oauth/google/exchange</span>.</p>
        <div class="row">
          <button id="btnGoogle" class="primary">Sign in with Google</button>
          <button id="btnGoogleReset" class="warning" disabled>Reset</button>
        </div>
        <div class="status" id="googleStatus" aria-live="polite">State: <span class="mono">idle</span></div>
        <div class="log mono" id="googleLog" aria-live="polite"></div>
      </section>

      <!-- Bind/Verify bundles (for backend) -->
      <section class="card col-12" id="bindCard">
        <h2>Bind / Verify</h2>
        <p class="muted">Both factors present → build <em>enroll</em> bundle. Google‑only is sufficient for a session <em>verify</em> bundle if desired.</p>
        <div class="row">
          <button id="btnShowBundle" disabled>Show enrollment bundle (wallet+google)</button>
          <button id="btnShowVerify" disabled>Show verify bundle (google)</button>
        </div>
        <div class="log mono" id="bundleOut"></div>
      </section>

      <!-- Example action area (how other apps will integrate) -->
      <section class="card col-12">
        <h2>Action Gate Demo</h2>
        <p class="muted">Any privileged action in your apps can add <span class="mono">data-need-2fa</span>. The handler will auto‑start Google if not verified, then unlock the button.</p>
        <div class="row">
          <button id="btnPrivilegedA" data-need-2fa class="success">Run Sentinel (demo)</button>
          <button id="btnPrivilegedB" data-need-2fa>Cancel Offers (demo)</button>
        </div>
        <div class="status muted">Security tip: never enter secrets on this page. The app uses OAuth and Xaman deep‑links only.</div>
      </section>

      <section class="card col-12">
        <h2>Diagnostics</h2>
        <div class="row">
          <button id="btnClear" class="warning">Clear logs</button>
          <button id="btnReload">Hard reload</button>
          <button id="btnShowCfg" class="ghost">Show config</button>
        </div>
        <div class="footer">If something appears stuck, refresh. Ensure the proxy exposes the three routes and environment variables are set in Render.</div>
      </section>
    </div>

    <footer class="footer" style="margin-top:18px">
      <a id="license-proprietary"></a>
      Proprietary. No redistribution. No secrets are stored in this file.
    </footer>
  </main>

  <!-- ===== Config: keep BEFORE main script ===== -->
  <script id="app-config" type="application/json">{
    "proxyUrl": "https://xrbitcoincash-github-io.onrender.com"
  }</script>

  <!-- ===== Main script: single inline block (no externals) ===== -->
  <script>
  (function(){
    /*** Utilities / Config ***/
    const $ = (s)=>document.querySelector(s);
    const log = (el, ...args)=>{ el.textContent += (args.map(a => typeof a==='string'? a: JSON.stringify(a,null,2)).join(' ') + "
"); el.scrollTop = el.scrollHeight; };
    const setStatus=(el, s, cls)=>{ el.innerHTML = `State: <span class="mono ${cls||''}">${s}</span>` };
    const isMobile=()=>/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    const cfgNode = document.getElementById('app-config');
    const cfg = (()=>{ try{ return JSON.parse(cfgNode?.textContent||'{}'); }catch(_){ return {}; } })();
    const SERVER = cfg.proxyUrl || '';
    if(!SERVER){ console.warn('proxyUrl missing in #app-config. API calls will fail.'); }

    // Parse query params
    const params = new URLSearchParams(location.search);
    const q = (k)=> params.get(k);

    // UI elements
    const x = { card: $('#xamanCard'), qr: $('#xamanQr'), st: $('#xamanStatus'), log: $('#xamanLog'), btnDesktop: $('#btnXamanDesktop'), btnMobile: $('#btnXamanMobile'), btnReset: $('#btnXamanReset') };
    const g = { card: $('#googleCard'), st: $('#googleStatus'), log: $('#googleLog'), btn: $('#btnGoogle'), btnReset: $('#btnGoogleReset') };
    const bind = { btnBundle: $('#btnShowBundle'), btnVerify: $('#btnShowVerify'), out: $('#bundleOut') };
    const pill = $('#auth2faStatus');

    const state = {
      xaman:{started:false,signed:false,txid:null,payloadId:null},
      google:{started:false,haveCode:false,code:null,verifier:null,tokens:null,channelId:null,clientId:null,redirectUri:null}
    };

    function setPill(ok){ if(!pill) return; pill.textContent = ok ? '2FA: verified ✓' : '2FA: sign in required'; pill.dataset.state = ok ? 'ok' : 'need'; }

    function refreshBindButtons(){
      const hasGoogle = Boolean(state.google.tokens || state.google.haveCode);
      const hasBoth = Boolean(state.xaman.signed && hasGoogle);
      bind.btnVerify.disabled = !hasGoogle;   // allow verify bundle with Google only
      bind.btnBundle.disabled = !hasBoth;     // enrollment needs both
      // Enable/disable demo actions
      document.querySelectorAll('[data-need-2fa]').forEach(btn => btn.disabled = !Boolean(state.google.tokens));
      setPill(Boolean(state.google.tokens));
    }

    /*** Xaman (optional second factor) ***/
    async function startXaman(mode){
      setStatus(x.st,'starting…'); x.log.textContent=''; x.btnReset.disabled = false;
      try{
        const res = await fetch(`${SERVER}/xaman/create`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ type:'SignIn', return_url: location.href }) });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        state.xaman.payloadId = data.payloadId || null;
        const deepLink = data.deepLink || data.deeplink || '';
        const qrPng = data.qrPng || data.qr || '';
        const wsUrl = data.wsUrl || data.websocket || data.websocket_status || '';
        if(mode==='desktop'){
          if(qrPng){ x.qr.innerHTML = `<img alt="Xaman QR" src="${qrPng}">`; x.qr.hidden=false; }
          else if(deepLink){ x.qr.innerHTML = `<div class="muted">Copy link:</div><div class="mono log">${deepLink}</div>`; x.qr.hidden=false; }
        } else {
          if(deepLink) location.href = deepLink; else log(x.log,'No deepLink provided');
        }
        setStatus(x.st,'waiting for sign…'); state.xaman.started=true;
        if(wsUrl){
          const ws = new WebSocket(wsUrl);
          ws.onmessage = (e)=>{ try{ const m = JSON.parse(e.data); if(m?.signed){ onXamanSigned(m.txid||m.txHash||null); ws.close(); } }catch(err){ log(x.log, String(err)); } };
          ws.onerror = () => log(x.log,'ws error');
        } else {
          log(x.log,'No websocket from server; implement GET /xaman/status/:uuid for polling if needed.');
        }
      }catch(err){ setStatus(x.st,'error creating payload','err'); log(x.log,String(err)); }
    }
    function onXamanSigned(txid){ state.xaman.signed=true; state.xaman.txid=txid||null; setStatus(x.st,'signed ✓','ok'); refreshBindButtons(); }

    /*** Google OAuth (PKCE) ***/
    async function fetchGoogleClient(){
      try{
        const r = await fetch(`${SERVER}/auth/google/client-id`);
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        state.google.clientId = j.clientId; state.google.redirectUri = j.redirectUri || location.href.split('#')[0];
        return true;
      }catch(err){ setStatus(g.st,'/auth/google/client-id missing','err'); log(g.log,'Server must expose Google client id. ', String(err)); return false; }
    }

    const b64url = (bytes)=>{ if(!(bytes instanceof Uint8Array)) bytes = new TextEncoder().encode(String(bytes||'')); let s=''; bytes.forEach(b=>s+=String.fromCharCode(b)); return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); };

    async function startGoogle(){
      g.log.textContent=''; setStatus(g.st,'starting…'); g.btnReset.disabled = false;
      if(!(await fetchGoogleClient())) return;
      const verifier = b64url(crypto.getRandomValues(new Uint8Array(64)));
      const chalBuf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
      const challenge = b64url(new Uint8Array(chalBuf));
      sessionStorage.setItem('g_verifier', verifier);
      const st = b64url(crypto.getRandomValues(new Uint8Array(24))); sessionStorage.setItem('g_state', st);
      const nonce = b64url(crypto.getRandomValues(new Uint8Array(24))); sessionStorage.setItem('g_nonce', nonce);
      const scopes = encodeURIComponent('openid profile https://www.googleapis.com/auth/youtube.readonly');
      const url = `https://accounts.google.com/o/oauth2/v2/auth?response_type=code&client_id=${encodeURIComponent(state.google.clientId)}&redirect_uri=${encodeURIComponent(state.google.redirectUri)}&scope=${scopes}&state=${encodeURIComponent(st)}&code_challenge=${encodeURIComponent(challenge)}&code_challenge_method=S256&nonce=${encodeURIComponent(nonce)}&access_type=offline&prompt=consent`;
      location.assign(url);
    }

    async function handleGoogleCallback(){
      const code = q('code'); if(!code) return; const st = q('state');
      const stSaved = sessionStorage.getItem('g_state'); if(!stSaved || st!==stSaved){ setStatus(g.st,'state mismatch','err'); return; }
      const verifier = sessionStorage.getItem('g_verifier');
      state.google.started=true; state.google.haveCode=true; state.google.code=code; state.google.verifier=verifier; setStatus(g.st,'authorization code captured ✓','ok'); log(g.log,{code});
      try{
        if(!(await fetchGoogleClient())) return;
        setStatus(g.st,'exchanging code at server…');
        const body = { code, code_verifier: verifier, redirect_uri: state.google.redirectUri };
        const r = await fetch(`${SERVER}/oauth/google/exchange`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
        const tokens = await r.json(); if(!r.ok) throw new Error(JSON.stringify(tokens));
        state.google.tokens = tokens; state.google.channelId = tokens.channelId || null;
        setStatus(g.st, tokens.channelId? 'channel verified ✓' : 'tokens received ✓', 'ok'); log(g.log, { channelId: state.google.channelId });
        refreshBindButtons();
      }catch(err){ setStatus(g.st,'server exchange failed','err'); log(g.log,String(err)); }
      history.replaceState({}, document.title, location.pathname);
    }

    /*** Bundles for backend ***/
    function buildEnrollmentBundle(){ return { type:'enroll', walletProof:{ signed:state.xaman.signed, txid:state.xaman.txid, payloadId:state.xaman.payloadId }, google:{ tokens:state.google.tokens||undefined, channelId:state.google.channelId||undefined } }; }
    function buildVerifyBundle(){ return { type:'verify', walletProof:{ signed:state.xaman.signed, txid:state.xaman.txid, payloadId:state.xaman.payloadId }, google:{ tokens:state.google.tokens||undefined } }; }

    /*** Wire up ***/
    x.btnDesktop.addEventListener('click', ()=> startXaman('desktop'));
    x.btnMobile.addEventListener('click', ()=> startXaman('mobile'));
    x.btnReset.addEventListener('click', ()=>{ state.xaman={started:false,signed:false,txid:null,payloadId:null}; x.qr.hidden=true; x.qr.innerHTML=''; x.log.textContent=''; setStatus(x.st,'idle'); x.btnReset.disabled = true; refreshBindButtons(); });

    g.btn.addEventListener('click', ()=> startGoogle());
    g.btnReset.addEventListener('click', ()=>{ state.google={started:false,haveCode:false,code:null,verifier:null,tokens:null,channelId:null,clientId:null,redirectUri:null}; g.log.textContent=''; setStatus(g.st,'idle'); g.btnReset.disabled = true; refreshBindButtons(); });

    bind.btnBundle.addEventListener('click', ()=>{ bind.out.textContent = JSON.stringify(buildEnrollmentBundle(), null, 2); });
    bind.btnVerify.addEventListener('click', ()=>{ bind.out.textContent = JSON.stringify(buildVerifyBundle(), null, 2); });

    $('#btnPrivilegedA').addEventListener('click', (e)=>{ if(!state.google.tokens){ e.preventDefault(); e.stopPropagation(); startGoogle(); } });
    $('#btnPrivilegedB').addEventListener('click', (e)=>{ if(!state.google.tokens){ e.preventDefault(); e.stopPropagation(); startGoogle(); } });

    $('#btnClear').addEventListener('click', ()=>{ x.log.textContent=''; g.log.textContent=''; bind.out.textContent=''; });
    $('#btnReload').addEventListener('click', ()=> location.reload());
    $('#btnShowCfg').addEventListener('click', ()=> alert(JSON.stringify(cfg,null,2)) );

    // Init on load
    handleGoogleCallback();
    setStatus(x.st,'idle'); setStatus(g.st,'idle'); refreshBindButtons();
  })();
  </script>
</body>
</html>
