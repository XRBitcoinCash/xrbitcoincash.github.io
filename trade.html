<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <!-- === META & THEME === --><!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <!-- === META & THEME === -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XRBitcoinCash · Wallet Connect</title>
  <meta name="description" content="Connect Xaman/Xumm wallet to XRBitcoinCash for XRPL trading and liquidity." />
  <meta name="robots" content="index, follow" />
  <meta property="og:title" content="XRBitcoinCash · Wallet Connect" />
  <meta property="og:description" content="Connect your wallet to trade XRBC on XRPL." />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#0b1118" />

  <style>
    :root {
      --bg: #0b1118;
      --panel: #0f1722;
      --text: #e7eef8;
      --brand: #a7ff83;
    }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial;
      color: var(--text);
      background: var(--bg);
    }
    header.appbar {
      padding: 14px 18px;
      background: linear-gradient(180deg, rgba(11,17,24,0.92), rgba(11,17,24,0.6));
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(167,255,131,0.15);
    }
    .btn {
      border: 1px solid rgba(167,255,131,0.25);
      background: linear-gradient(180deg, var(--panel), #121c2a);
      color: var(--text);
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
    }
    .btn:hover {
      border-color: var(--brand);
    }
    #walletAddress {
      margin-left: 1rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }
 @keyframes glowPulse {
  from { box-shadow: 0 0 4px var(--accent); }
  to { box-shadow: 0 0 14px var(--accent); }
}

  </style>
</head>
<body>

<header class="appbar">
  <div class="brand">
    <strong>XRBitcoinCash</strong> · Wallet Connect
  </div>
  <div class="actions">
    <button id="connectWalletButton" type="button" class="btn">Connect Wallet</button>
    <span id="walletAddress">Status: Not connected</span>
  </div>
</header>
<header style="display: flex; align-items: center; padding: 12px 18px;">
  <a href="/index.html" style="display: flex; align-items: center; text-decoration: none;">
    <img src="/xrbc-nft.png" alt="XRBC Home" style="width: 44px; height: 44px; border-radius: 8px; animation: glowPulse 2.5s infinite alternate;" />
    <span style="margin-left: 12px; font-weight: 600; color: var(--ink);">Home</span>
  </a>
</header>

  <!-- === TEXT === -->
<main style="padding:20px;">
  <div id="xrbc-dex-root"></div>
</main>


<!-- === CONFIG PLACEHOLDER === -->
<script type="application/json" id="app-config">
{
  "xummApiKey": "2abde023-0df1-49a2-a4dc-86d776f6318d",
  "rpcEndpoint": "wss://s1.ripple.com"
}
</script>

<!-- === EXTERNAL LIBS === -->
<script src="https://xaman.app/assets/cdn/xumm.min.js"></script>

<!-- === APP SCRIPT === -->
<script>
(function(){
  'use strict';

  const cfg = JSON.parse(document.getElementById('app-config').textContent);
  const btn = document.getElementById('connectWalletButton');
  const statusEl = document.getElementById('walletAddress');

  // Init Xumm SDK
  const xumm = new Xumm(cfg.xummApiKey);

  xumm.on('ready', () => {
    console.log('Xumm SDK ready');
    btn.disabled = false;
  });
 //added disconnect button now visable
async function disconnectWallet() {
  try {
    // End the Xumm session and clear auth
    await xumm.logout();

    // Update UI to show a safe disconnect
    statusEl.textContent = '✅ Your wallet has disconnected safely.';
    btn.textContent = 'Connect Wallet';

    // If you want, trigger any follow‑up UI like a ledger receipt here
    // showLedgerReceipt();
  } catch (err) {
    console.error('Error disconnecting wallet:', err);
    statusEl.textContent = '⚠ Could not disconnect — see console for details.';
  }
}
//added disconnect button now visable

//button function correct
  btn.addEventListener('click', async () => { if (btn.textContent.trim() === 'Disconnect') { return disconnectWallet(); }
  statusEl.textContent = 'Not connected';
//button funtion correct
    statusEl.textContent = 'Connecting...';
    try {
      const auth = await xumm.authorize(); // triggers app/QR
      const account = await xumm.user.account;
      statusEl.textContent = 'Connected: ' + account;
 //button disconect    
      btn.textContent = 'Disconnect';
 //button disconect
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Status: Not connected';
    }
  });
})();
</script>
<!-- PART 1 — XRBC DEX Module: HTML + CSS -->
<style id="xrbc-dex-styles">
  :root {
    --xrbc-bg: #0f1722;
    --xrbc-panel: #121827;
    --xrbc-text: #e7eef8;
    --xrbc-accent: #7ef09a;
    --xrbc-danger: #ff6b6b;
    --xrbc-muted: #98a2b3;
  }
  #xrbc-dex-container {
    max-width:900px;
    margin:28px auto;
    padding:18px;
    background: linear-gradient(180deg,var(--xrbc-panel), #0b1320);
    border-radius:14px;
    color:var(--xrbc-text);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    box-shadow: 0 8px 30px rgba(3,8,14,0.6);
    border: 1px solid rgba(126,240,154,0.06);
  }
  #xrbc-dex-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  #xrbc-dex-header h2 { margin:0; color:var(--xrbc-accent); font-size:1.05rem; }
  #xrbc-dex-grid { display:grid; grid-template-columns: 1fr 320px; gap:18px; margin-top:14px; }
  #xrbc-orderbook-card, #xrbc-metrics-card { background: linear-gradient(180deg,#0b1220, #0f1726); border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.03); }
  #xrbc-orderbook { height:320px; overflow:auto; font-size:0.92rem; color:var(--xrbc-text); }
  .xrbc-row { display:flex; justify-content:space-between; padding:6px 8px; align-items:center; border-bottom:1px dashed rgba(255,255,255,0.01); }
  .xrbc-bid { color:#2ecc71; }
  .xrbc-ask { color:#ff6b6b; }
  #xrbc-order-form { background:transparent; display:flex; flex-direction:column; gap:10px; }
  #xrbc-order-form input, #xrbc-order-form select { padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--xrbc-text); }
  .xrbc-btn { padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
  .xrbc-btn-primary { background:linear-gradient(180deg,#2b7fff,#1f4fd6); color:white; }
  .xrbc-btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--xrbc-text); }
  #xrbc-status { font-size:0.92rem; color:var(--xrbc-muted); }
  .xrbc-small { font-size:0.86rem; color:var(--xrbc-muted); }
  @media (max-width:880px) { #xrbc-dex-grid { grid-template-columns: 1fr; } }
</style>

<div id="xrbc-dex-container" aria-live="polite" role="region" aria-label="XRBC DEX module">
  <div id="xrbc-dex-header">
    <h2>XRBC DEX — Live orderbook & metrics</h2>
    <div id="xrbc-header-actions" class="xrbc-small">
      <span id="xrbc-wallet-view">Wallet: <em id="xrbc-wallet-addr">Not connected</em></span>
      <button id="xrbc-refresh-btn" class="xrbc-btn xrbc-btn-ghost" title="Refresh market data">Refresh</button>
    </div>
  </div>

  <div id="xrbc-dex-grid">
    <!-- LEFT: Orderbook + metrics -->
    <div>
      <div id="xrbc-orderbook-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div>
            <label for="xrbc-pair-select" class="xrbc-small">Pair</label>
            <select id="xrbc-pair-select" style="margin-left:8px;padding:6px;border-radius:8px;">
              <option value="XRBC/XRP">XRBC / XRP</option>
            </select>
          </div>
          <div class="xrbc-small">Top 20 levels</div>
        </div>

        <div id="xrbc-orderbook" aria-live="polite">
          <div class="xrbc-row"><strong>Type</strong><strong>Price</strong><strong>Amount</strong></div>
          <div class="xrbc-row"><em class="xrbc-small">Load an orderbook to view levels</em></div>
        </div>
      </div>

      <div id="xrbc-metrics-card" style="margin-top:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>Quick metrics</strong>
          <span class="xrbc-small">Snapshot</span>
        </div>

        <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap;">
          <div><div class="xrbc-small">Spread</div><div id="xrbc-metric-spread">—</div></div>
          <div><div class="xrbc-small">Best Bid</div><div id="xrbc-metric-bestbid">—</div></div>
          <div><div class="xrbc-small">Best Ask</div><div id="xrbc-metric-bestask">—</div></div>
          <div><div class="xrbc-small">Top Depth (bid/ask)</div><div id="xrbc-metric-depth">—</div></div>
          <div style="width:100%;margin-top:8px;">
            <label class="xrbc-small">Simulate slippage for amount (XRBC)</label>
            <input id="xrbc-sim-amount" type="number" step="0.000001" min="0" placeholder="e.g., 10" style="width:160px;">
            <div class="xrbc-small" style="margin-top:6px;">Estimated slippage: <strong id="xrbc-sim-result">—</strong></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Order form -->
    <aside>
      <div id="xrbc-order-form-card">
        <div id="xrbc-order-form" >
          <div><label class="xrbc-small" for="xrbc-order-side">Side</label><select id="xrbc-order-side"><option value="buy">Buy XRBC (spend XRP)</option><option value="sell">Sell XRBC (receive XRP)</option></select></div>
          <div><label class="xrbc-small" for="xrbc-order-amount">Amount (XRBC)</label><input id="xrbc-order-amount" type="number" step="0.000001" min="0"></div>
          <div><label class="xrbc-small" for="xrbc-order-price">Price (XRP per XRBC)</label><input id="xrbc-order-price" type="number" step="0.000001" min="0" placeholder="market or custom"></div>
          <div style="display:flex;gap:8px;">
            <button id="xrbc-submit-order" class="xrbc-btn xrbc-btn-primary">Create Offer (Xumm)</button>
            <button id="xrbc-simulate-btn" class="xrbc-btn xrbc-btn-ghost">Simulate</button>
          </div>
          <div id="xrbc-order-feedback" class="xrbc-small" style="margin-top:8px;color:var(--xrbc-muted);">Status: idle</div>
          <div id="xrbc-status" class="xrbc-small" style="margin-top:10px;">Node: <span id="xrbc-node-status">disconnected</span></div>
        </div>
      </div>
    </aside>
  </div>
</div>
<!-- End PART 1 -->
<!-- PART 2 — XRBC DEX Module: Main JS -->
<!-- === XRBC DEX SCRIPT (UPGRADED) === -->
<script defer>
(function(){
  'use strict';
  const XRBC_ISSUER = "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw";
  const XRBC_CODE = "XRbitcoincash";
  const DEFAULT_WSS = "wss://s1.ripple.com";
  const MAX_LEVELS = 20;

  const siteCfg = JSON.parse(document.getElementById('app-config').textContent);
  let xrplClient = null;

  async function initClients(){
    xrplClient = new xrpl.Client(siteCfg.rpcEndpoint || DEFAULT_WSS);
    await xrplClient.connect();
    document.getElementById('xrbc-node-status').textContent = 'connected';
    console.log("XRPL connected:", siteCfg.rpcEndpoint || DEFAULT_WSS);
  }

  async function loadOrderbook(){
    const orderbookEl = document.getElementById('xrbc-orderbook');
    orderbookEl.textContent = "Loading orderbook…";
    if (!xrplClient || !xrplClient.isConnected()) {
      orderbookEl.textContent = "❌ XRPL node not connected.";
      return;
    }
    try {
      const res = await xrplClient.request({
        command: "book_offers",
        taker_gets: { currency: XRBC_CODE, issuer: XRBC_ISSUER },
        taker_pays: { currency: "XRP" },
        limit: MAX_LEVELS
      });
      const offers = res.result.offers || [];
      let html = "<table><tr><th>Price (XRP)</th><th>Amount (XRBC)</th></tr>";
      offers.forEach(o => {
        const price = (parseFloat(o.TakerPays)/1e6) / parseFloat(o.TakerGets.value);
        html += `<tr><td>${price.toFixed(6)}</td><td>${o.TakerGets.value}</td></tr>`;
      });
      html += "</table>";
      orderbookEl.innerHTML = html;
    } catch (err) {
      console.error('book_offers error', err);
      orderbookEl.textContent = "❌ Orderbook error: " + err.message;
    }
  }

  async function placeMarketOrder(amount, side, xumm){
    // Fetch best offer
    const res = await xrplClient.request({
      command: "book_offers",
      taker_gets: { currency: XRBC_CODE, issuer: XRBC_ISSUER },
      taker_pays: { currency: "XRP" },
      limit: 1
    });
    const bestOffer = res.result.offers?.[0];
    if (!bestOffer) throw new Error("No liquidity in orderbook");

    let tx;
    if (side === "buy") {
      const price = (parseFloat(bestOffer.TakerPays)/1e6) / parseFloat(bestOffer.TakerGets.value);
      const costXRP = amount * price;
      tx = {
        TransactionType: "OfferCreate",
        TakerGets: xrpl.xrpToDrops(costXRP),
        TakerPays: { currency: XRBC_CODE, issuer: XRBC_ISSUER, value: String(amount) }
      };
    } else {
      const price = (parseFloat(bestOffer.TakerPays)/1e6) / parseFloat(bestOffer.TakerGets.value);
      const payoutXRP = amount * price;
      tx = {
        TransactionType: "OfferCreate",
        TakerGets: { currency: XRBC_CODE, issuer: XRBC_ISSUER, value: String(amount) },
        TakerPays: xrpl.xrpToDrops(payoutXRP)
      };
    }
    const payload = await xumm.payload.createAndSubscribe(tx, e => {
      if (e.signed === true) console.log("✅ Signed and submitted");
      if (e.signed === false) console.log("❌ Rejected");
    });
    console.log("Payload URL:", payload.created.next.always);
    window.open(payload.created.next.always, "_blank");
  }

  async function placeLimitOrder(amount, price, side, xumm){
    let tx;
    if (side === "buy") {
      const costXRP = amount * price;
      tx = {
        TransactionType: "OfferCreate",
        TakerGets: xrpl.xrpToDrops(costXRP),
        TakerPays: { currency: XRBC_CODE, issuer: XRBC_ISSUER, value: String(amount) }
      };
    } else {
      const payoutXRP = amount * price;
      tx = {
        TransactionType: "OfferCreate",
        TakerGets: { currency: XRBC_CODE, issuer: XRBC_ISSUER, value: String(amount) },
        TakerPays: xrpl.xrpToDrops(payoutXRP)
      };
    }
    const payload = await xumm.payload.createAndSubscribe(tx, e => {
      if (e.signed === true) console.log("✅ Limit order signed");
      if (e.signed === false) console.log("❌ Rejected");
    });
    console.log("Limit order URL:", payload.created.next.always);
    window.open(payload.created.next.always, "_blank");
  }

  initClients().then(loadOrderbook);

  // Make functions globally available for UI
  window.XRBCdex = { placeMarketOrder, placeLimitOrder, reload: loadOrderbook };
})();
</script>

<div id="xrbc-dex-container">
  <h2>XRBC DEX — Orderbook</h2>
  <div id="xrbc-node-status">disconnected</div>
  <div id="xrbc-orderbook"></div>

  <h3>Trade</h3>
  <button onclick="XRBCdex.placeMarketOrder(10,'buy',xumm)">Buy 10 XRBC @ Market</button>
  <button onclick="XRBCdex.placeMarketOrder(10,'sell',xumm)">Sell 10 XRBC @ Market</button>
  <br><br>
  <button onclick="XRBCdex.placeLimitOrder(5,0.5,'buy',xumm)">Limit Buy 5 XRBC @ 0.5 XRP</button>
  <button onclick="XRBCdex.placeLimitOrder(5,0.5,'sell',xumm)">Limit Sell 5 XRBC @ 0.5 XRP</button>
</div>


})();
</script>
<!-- End PART 2 -->
<!-- PART 3 — Extras: helper + short README (optional) -->
<script defer>
/*
  XRBC DEX quick notes (visible in console)
  - If xrpl.js or Xumm aren't loaded, the widget will still render but network and signing won't work.
  - To change node endpoint, edit the <script id="app-config"> JSON in your page:
    {
      "xummApiKey": "YOUR_KEY_IF_ANY",
      "rpcEndpoint": "wss://your-xrpl-node"
    }
  - Debug:
      window.__xrbcDex.loadOrderbook();
      window.__xrbcDex.simulateSlippage('buy', 10);
*/
console.info('XRBC DEX module loaded — use window.__xrbcDex for debug.');
</script>
<!-- End PART 3 -->

</body>
</html>
