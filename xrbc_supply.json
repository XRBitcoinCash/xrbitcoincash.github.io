import requests
import json

# -------------------------
# CONFIG
# -------------------------
# Your proxy URL that forwards requests to the XRPL node
PROXY_URL = "https://your-proxy.example.com/xrpl"

# Issuer account for XRBC
ISSUER_ACCOUNT = "rYourIssuerWalletAddress"

# XRBC currency code
CURRENCY_CODE = "XRBC"

# Total issued supply
TOTAL_SUPPLY = 1000000000  # replace with your issued amount

# Output JSON file name
OUTPUT_FILE = "xrbc_supply.json"

# -------------------------
# FETCH TRUST LINES FROM XRPL
# -------------------------
def fetch_trust_lines(issuer):
    """
    Calls the XRPL proxy to get all trust lines from the issuer account.
    Returns a list of trust lines containing XRBC balances.
    """
    payload = {
        "method": "account_lines",
        "params": [
            {
                "account": issuer,
                "ledger_index": "validated"
            }
        ]
    }

    try:
        response = requests.post(PROXY_URL, json=payload)
        response.raise_for_status()
        data = response.json()
        return data.get("result", {}).get("lines", [])
    except Exception as e:
        print(f"Error fetching trust lines: {e}")
        return []

# -------------------------
# CALCULATE CIRCULATING SUPPLY
# -------------------------
def calculate_circulating(lines):
    """
    Sum balances for XRBC across all holders.
    """
    circulating = 0
    for line in lines:
        if line.get("currency") == CURRENCY_CODE:
            circulating += float(line.get("balance", 0))
    return circulating

# -------------------------
# MAIN
# -------------------------
def main():
    trust_lines = fetch_trust_lines(ISSUER_ACCOUNT)
    circulating_supply = calculate_circulating(trust_lines)

    # Prepare JSON output
    supply_data = {
        "total_supply": TOTAL_SUPPLY,
        "circulating_supply": circulating_supply
    }

    # Write JSON to file
    with open(OUTPUT_FILE, "w") as f:
        json.dump(supply_data, f, indent=2)

    print(f"Circulating supply: {circulating_supply}")
    print(f"JSON file saved: {OUTPUT_FILE}")

if __name__ == "__main__":
    main()
