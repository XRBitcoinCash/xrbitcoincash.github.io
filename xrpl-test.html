<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Safely trade XRBC ¬∑ XRBitcoinCash</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Canonical -->
  <link rel="canonical" href="https://xrbitcoincash.com/trade.html" />
  <link rel="alternate" hreflang="en" href="https://xrbitcoincash.com/trade.html" />

  <!-- Primary SEO -->
  <meta name="description" content="Safely trade XRBC on the XRP Ledger. Connect your Xaman (Xumm) wallet to place XRBC/XRP limit or market orders, read the order book, and view AMM pool info." />
  <meta name="keywords" content="XRBitcoinCash, XRBC, XRP Ledger, XRPL, Xaman, Xumm, DEX, AMM, crypto trading, trustline" />
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="theme-color" content="#0b0f14" />

  <!-- Favicons -->
  <link rel="icon" href="/xrbc-nft.png" type="image/png">
  <link rel="shortcut icon" href="/xrbc-nft.png" type="image/png">
  <link rel="apple-touch-icon" href="/xrbc-nft.png">
  <meta name="msapplication-TileImage" content="/xrbc-nft.png">
  <link rel="icon" href="/favicon.ico?v=1" sizes="any">
  <link rel="icon" type="image/png" href="/favicons/favicon-32.png?v=1" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicons/favicon-16.png?v=1" sizes="16x16">
  <link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png?v=1" sizes="180x180">
  <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg?v=1" color="#0b0f14">
  <meta name="msapplication-TileColor" content="#0b0f14">
  <link rel="manifest" href="/site.webmanifest?v=1">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="XRBitcoinCash">
  <meta property="og:title" content="Safely trade XRBC ¬∑ XRBitcoinCash">
  <meta property="og:description" content="Decentralized XRBC/XRP trading on the XRP Ledger with live order book and AMM price helper.">
  <meta property="og:url" content="https://xrbitcoincash.com/trade.html">
  <meta property="og:image" content="https://xrbitcoincash.com/xrbc-nft.png">
  <meta property="og:image:secure_url" content="https://xrbitcoincash.com/xrbc-nft.png">
  <meta property="og:image:alt" content="XRBitcoinCash ‚Äî XRBC/XRP trading page">

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Safely trade XRBC ¬∑ XRBitcoinCash">
  <meta name="twitter:description" content="Trade XRBC on XRPL. Connect your wallet, place orders, and view AMM pool info.">
  <meta name="twitter:image" content="https://xrbitcoincash.com/xrbc-nft.png">
  <meta name="twitter:image:alt" content="XRBitcoinCash ‚Äî XRBC/XRP trading page">

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Safely trade XRBC ¬∑ XRBitcoinCash",
    "url": "https://xrbitcoincash.com/trade.html",
    "description": "Safely trade XRBC on the XRP Ledger. Connect your Xaman (Xumm) wallet to place XRBC/XRP limit or market orders, read the order book, and view AMM pool info.",
    "isPartOf": {
      "@type": "WebSite",
      "name": "XRBitcoinCash",
      "url": "https://xrbitcoincash.com/"
    },
    "primaryImageOfPage": {
      "@type": "ImageObject",
      "url": "https://xrbitcoincash.com/xrbc-nft.png"
    },
    "about": {
      "@type": "Cryptocurrency",
      "name": "XRBitcoinCash (XRBC)",
      "alternateName": "XRBC",
      "additionalProperty": [
        { "@type": "PropertyValue", "name": "issuer", "value": "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw" },
        { "@type": "PropertyValue", "name": "currency_hex", "value": "5852626974636F696E6361736800000000000000" },
        { "@type": "PropertyValue", "name": "network", "value": "XRP Ledger (XRPL)" }
      ]
    },
    "potentialAction": [{ "@type": "BuyAction", "target": "https://xrbitcoincash.com/trade.html" }]
  }
  </script>

  <meta name="ai-readable" content="This page exposes structured data (JSON-LD) describing the XRBC trading interface on XRPL, including issuer and currency hex.">

  <!-- =========================
       XRBC ‚Äî Uniform Site CSS (v2, exchange-style DEX)
       ========================= -->
  <style>
/* (styles unchanged from your last version; omitted here only for brevity in this comment) */
/* =========================================
   XRBC ‚Äî Uniform Site CSS (v2, exchange-style DEX)
   ========================================= */

:root{
  --wrap:980px; --wrap-wide:1080px;
  --bg:#0b0f14; --panel:#0e1520; --panel-2:#0c131c;
  --ink:#e7edf5; --muted:#9fb0c5;
  --accent:#60a5fa; --accent-2:#22d3ee; --ok:#22c55e; --err:#ef4444;
  --line:#2b3a4b; --ring:#00e5ff; --shadow:0 10px 30px rgba(0,0,0,.35);
  --gap:14px; --gap-lg:24px;
  --hdr-blue-a: rgba(0,182,255,.22); --hdr-blue-b: rgba(0,182,255,.16);
}
*,*::before,*::after{ box-sizing:border-box; }
html{ scroll-behavior:smooth; }
html,body{ height:100%; max-width:100%; overflow-x:hidden; }
body{ background:var(--bg); color:var(--ink); font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; position:relative; }
img{ max-width:100%; height:auto; display:block; }
.mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; overflow-wrap:anywhere; }
.nowrap{ white-space:nowrap; }

/* Header, nav, buttons, cards, trade UI, tables, footer, light mode, mobile, reduced motion ... */
/* (keep your existing CSS exactly as before) */

/* --- Minimal modal styling (both modals share this) --- */
.modal{display:none;position:fixed;inset:0;z-index:1000}
.modal.open{display:block}
.modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.65)}
.modal .dialog{position:relative;max-width:560px;margin:8vh auto;background:#0b0f14;border-radius:16px;padding:20px;border:1px solid #1f2a37}
.modal h3{margin:0 0 10px}
.qr-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
.fine{font-size:.95rem;opacity:.9}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
code.url{user-select:all;word-break:break-word;display:block;margin-top:6px;background:#0f172a;border:1px solid #1e293b;border-radius:8px;padding:6px 10px}
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <header class="site-header">
    <div class="header-wrap">
      <div class="brand">
        <img src="/xrbc-nft.png" alt="XRBitcoinCash (XRBC) logo">
        <h1>XRBitcoinCash</h1>
      </div>

      <nav class="header-center" role="navigation" aria-label="Primary">
        <div class="header-nav">
          <a class="nav-pill pill-ecosys" href="/xrbc-ecosystem.html" title="XRBC Ecosystem ¬∑ DEX/AMM">XRBC Ecosystem ¬∑ DEX/AMM</a>
          <a class="nav-pill pill-whitepaper" href="/whitepaper.html" title="XRBC White Paper">White Paper</a>
        </div>
      </nav>

      <div class="header-right">
        <button id="themeToggle" type="button" aria-pressed="false" aria-label="Toggle light/dark">Light/Dark</button>
      </div>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="container" style="max-width:800px;text-align:center;">

    <h1 style="margin:12px 0 8px; line-height:1.1; letter-spacing:.2px;">
      XRBC ¬∑ Decentralized Trading (XRPL via Xaman)
    </h1>

    <!-- DEX / xApp quick entries (unchanged) -->
    <div style="margin-top:12px">
      <div style="display:flex;align-items:center;gap:8px;
                  padding:8px 12px;border:1px solid #064e3b;border-left:4px solid #10b981;
                  border-radius:10px;background:linear-gradient(180deg,#052b1f,#073425);
                  color:#d1fae5;font-size:14px;font-weight:700;letter-spacing:.2px;margin-bottom:10px;justify-content:center">
        <span>Open in Xaman ‚Äî DEX & Swaps (mobile opens app ‚Ä¢ desktop shows QR)</span>
      </div>

      <a href="https://xumm.app/detect/xapp:xumm.dex" rel="noopener noreferrer"
         class="btn" style="width:100%;max-width:520px;margin:0 auto 10px;border-left:4px solid #10b981;">
        <img src="/xrbc-nft.png" alt="XRBC" width="20" height="20" style="display:inline-block;border-radius:4px" />
        <span>Open in Xaman ‚Äî Trade XRBC ‚Üî XRP (DEX)</span>
        <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" width="20" height="20" style="display:inline-block" />
      </a>

      <a href="https://xumm.app/detect/xapp:anodos.swap" rel="noopener noreferrer"
         class="btn" style="width:100%;max-width:520px;margin:0 auto 10px;border-left:4px solid #38bdf8;">
        <img src="/xrbc-nft.png" alt="XRBC" width="20" height="20" style="display:inline-block;border-radius:4px" />
        <span>Open in Xaman ‚Äî ANODOS Swap (XRBC ‚Üî XRP)</span>
        <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" width="20" height="20" style="display:inline-block" />
      </a>

      <a href="https://xumm.app/detect/xapp:magnetic.dex" rel="noopener noreferrer"
         class="btn" style="width:100%;max-width:520px;margin:0 auto 10px;border-left:4px solid #1e3a8a;">
        <img src="/xrbc-nft.png" alt="XRBC" width="20" height="20" style="display:inline-block;border-radius:4px" />
        <span>Open in Xaman ‚Äî Magnetic (XRBC ‚Üî XRP)</span>
        <img src="https://xrbitcoincash.github.io/assetsxrp.svg.svg" alt="XRP" width="20" height="20" style="display:inline-block" />
      </a>

      <div class="fine" style="margin-top:8px;color:#93a3af;font-size:12px;line-height:1.4;">
        Notes: Anodos and Magnetic open as xApps in Xaman. Pair deep-linking to XRBC/XRP isn‚Äôt publicly documented by providers; you may need to select the pair in-app.
        ‚ÄúXRP‚Äù and the XRP logo are trademarks of Ripple Labs, Inc. ‚ÄúXaman (Xumm)‚Äù is a product of XRPL Labs. No affiliation or endorsement implied.
      </div>
    </div>

    <!-- Wallet card -->
    <div class="card" style="margin:16px 0 20px;">
      <h2 style="margin:6px 0 10px;">Wallet</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:6px 0 12px;">
        <button id="connectWalletBtn" class="btn">Connect Wallet</button>
        <button id="setTrustlineBtn" class="btn">Set XRBC Trustline</button>
        <button id="disconnectWalletBtn" class="btn" disabled>Disconnect</button>
        <!-- NEW: Download Xaman button -->
        <button id="downloadXamanBtn" class="btn" style="border-left:4px solid #2563eb;">Download Xaman</button>
      </div>
      <p id="walletStatus" class="status-text">Status: Not connected</p>
      <div id="trustlineMsg" class="status-text" style="margin-top:8px;"></div>
      <p id="walletHelp" class="status-text" style="margin-top:6px">
        Don‚Äôt have a wallet yet?
        <a href="https://xaman.app/" target="_blank" rel="noopener">Create your wallet in Xaman</a>.
      </p>
    </div>

    <!-- ===== Trading UI (exchange style) ===== -->
    <section class="trade-card" id="tradeCard" aria-label="XRBC Trading">
      <!-- (unchanged trading UI from your last version) -->
      <div class="trade-logo">
        <img src="/xrbc-nft.png" alt="XRBC logo">
        <span class="pair">XRBC / XRP</span>
      </div>

      <div class="otype-tabs" role="tablist" aria-label="Order type">
        <button class="otype active" data-type="limit"  role="tab" aria-selected="true">Limit</button>
        <button class="otype"        data-type="market" role="tab" aria-selected="false">Market</button>
        <button class="otype"        data-type="stop"   role="tab" aria-selected="false">Stop</button>
      </div>

      <div class="tabset" role="tablist" aria-label="Choose buy or sell">
        <button id="buyTab" class="tab buy active" type="button" role="tab" aria-selected="true">Buy XRBC</button>
        <button id="sellTab" class="tab sell" type="button" role="tab" aria-selected="false">Sell XRBC</button>
      </div>

      <div class="best-price-strip">
        <span class="hint">Get AMM-based best price estimate.</span>
        <button class="btn" id="suggestPriceBtn" type="button">Best Price</button>
      </div>

      <div class="field">
        <label for="amount">Amount (XRBC)</label>
        <div class="amount-row">
          <img src="/xrbc-nft.png" alt="XRBC logo">
          <input id="amount" type="number" step="0.000001" inputmode="decimal" placeholder="0.000000">
        </div>
        <div class="quick-amounts" role="group" aria-label="Quick amount">
          <button class="qa" data-q="25">25%</button>
          <button class="qa" data-q="50">50%</button>
          <button class="qa" data-q="75">75%</button>
          <button class="qa" data-q="100">100%</button>
        </div>
        <div class="inline-hint">How many XRBC you want to <span id="actionWord">buy</span>.</div>
      </div>

      <div class="field" id="priceField">
        <label for="price">Price (XRP per XRBC)</label>
        <input id="price" type="number" step="0.000001" inputmode="decimal" placeholder="e.g., 0.500000">
        <div class="inline-hint">Limit price. (Use Market to execute immediately.)</div>
      </div>

      <div class="field" id="stopField" hidden>
        <label for="stop">Stop price (XRP)</label>
        <input id="stop" type="number" step="0.000001" inputmode="decimal" placeholder="e.g., 0.450000">
        <div class="inline-hint">Stop orders are not yet submitted programmatically on XRPL here (UI preview only).</div>
      </div>

      <div class="total-line" aria-live="polite">
        <span>Total</span>
        <strong id="totalXrp">0.000000 XRP</strong>
      </div>

      <div class="button-row">
        <button id="placeOfferBtn" class="btn btn-primary" type="button">Place Order</button>
        <div class="refresh-indicator" aria-hidden="true">
          <div class="clock"></div>
          <span class="refresh-text">Auto-refresh every 10s</span>
        </div>
      </div>

      <p id="tradeMsg" class="status-text">‚Äî</p>

      <select id="side" hidden>
        <option value="buy" selected>Buy</option>
        <option value="sell">Sell</option>
      </select>
      <input id="orderType" type="hidden" value="limit">
    </section>

    <div class="card" style="margin:20px 0 14px;">
      <h2 style="margin-top:0;">XRBC/XRP AMM Pool</h2>
      <div id="ammPoolOutput">Loading pool info‚Ä¶</div>
    </div>

    <div class="card" style="margin:0 0 14px;">
      <h2 style="margin-top:0;">Ledger Info</h2>
      <button id="fetchLedgerBtn" class="btn" style="margin-bottom:12px;">Fetch Ledger Info</button>
      <pre id="ledgerOutput" style="text-align:left;max-height:320px;overflow:auto;">‚Äî</pre>
    </div>

    <div class="card" style="margin:0 0 24px;">
      <h2 style="margin-top:0;">XRBC/XRP Order Book</h2>
      <button id="fetchPriceBtn" class="btn" style="margin-bottom:12px;">Get Order Book</button>
      <div id="priceOutput" style="max-height:360px; overflow:auto;">‚Äî</div>
    </div>

  </main>

  <!-- ===== Modal (desktop only for trading/trustline) ===== -->
  <div id="mobileModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Open on mobile">
    <div class="backdrop"></div>
    <div class="dialog">
      <h3 id="modalTitle">Open on Mobile to Trade Safely</h3>
      <p id="modalIntro" class="fine">XRBC transactions are signed in <strong>Xaman</strong> on mobile. Scan this QR to open the
        <strong>verified XRBitcoinCash trading page</strong> on your phone and continue safely.</p>
      <div class="qr-wrap">
        <div id="pageQr" aria-label="QR for https://xrbitcoincash.com/"></div>
        <code id="pageUrlCopy" class="url">https://xrbitcoincash.com/</code>
      </div>
      <p id="modalFoot" class="fine" style="margin-top:12px;">
        <strong>Always check the URL:</strong> it must start with <code>https://xrbitcoincash.com</code>.
      </p>
      <div class="actions">
        <button id="closeModalBtn" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- ===== NEW: Download Xaman modal (desktop only) ===== -->
  <div id="downloadModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Download Xaman Wallet">
    <div class="backdrop"></div>
    <div class="dialog">
      <h3 id="dlModalTitle">Get Xaman Wallet</h3>
      <p class="fine" id="dlModalIntro">
        Scan this QR to open the official <strong>Xaman download</strong> page on your phone.
      </p>
      <div class="qr-wrap">
        <div id="xamanQr" aria-label="QR to download Xaman"></div>
        <code id="downloadUrlCopy" class="url">https://xaman.app/download</code>
      </div>
      <p class="fine" id="dlModalFoot" style="margin-top:12px;">
        Or open the store directly: <a id="dlIosLink" href="#" target="_blank" rel="noopener">App Store</a> ¬∑
        <a id="dlAndroidLink" href="#" target="_blank" rel="noopener">Google Play</a>
      </p>
      <div class="actions">
        <button id="closeDownloadModalBtn" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Config -->
  <script type="application/json" id="app-config">
  {
    "xummApiKey": "2abde023-0df1-49a2-a4dc-86d776f6318d",
    "proxyUrl": "https://xrbitcoincash-github-io.onrender.com"
  }
  </script>

  <!-- Xaman SDK -->
  <script src="https://xaman.app/assets/cdn/xumm.min.js"></script>

  <!-- Minimal QR helper (uses hosted PNG for site QR) + NEW download QR generator -->
  <script>
    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    const MOBILE_TARGET_URL = 'https://xrbitcoincash.com/';

    // Store links (official)
    const XAMAN_DOWNLOAD_URL = 'https://xaman.app/download';
    const XAMAN_IOS_URL = 'https://apps.apple.com/us/app/xaman-wallet/id1492302343';
    const XAMAN_ANDROID_URL = 'https://play.google.com/store/apps/details?id=com.xrpllabs.xumm';

    function renderQr() {
      const pageQr = document.getElementById('pageQr');
      const pageUrlCopy = document.getElementById('pageUrlCopy');
      if (!pageQr) return;
      pageQr.innerHTML = '';
      const img = new Image();
      img.alt = 'QR to open https://xrbitcoincash.com/';
      img.style.maxWidth = '240px';
      img.style.height = 'auto';
      img.decoding = 'async';
      img.loading = 'eager';
      img.src = `https://xrbitcoincash.github.io/qrcode_xrbitcoincash.com.png?v=1`;
      img.onerror = () => { pageQr.textContent = 'QR failed to load'; };
      pageQr.appendChild(img);
      if (pageUrlCopy) pageUrlCopy.textContent = MOBILE_TARGET_URL;
    }

    // NEW: render QR that encodes the official Xaman download URL
    function renderDownloadQr() {
      const el = document.getElementById('xamanQr');
      const urlOut = document.getElementById('downloadUrlCopy');
      if (!el) return;
      el.innerHTML = '';
      const qr = new Image();
      qr.alt = 'Scan to download Xaman';
      qr.style.maxWidth = '240px';
      qr.style.height = 'auto';
      qr.decoding = 'async';
      qr.loading = 'eager';
      // Using a simple QR service for testing: encodes https://xaman.app/download
      qr.src = 'https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=' + encodeURIComponent(XAMAN_DOWNLOAD_URL);
      qr.onerror = () => { el.textContent = 'QR failed to load'; };
      el.appendChild(qr);
      if (urlOut) urlOut.textContent = XAMAN_DOWNLOAD_URL;
    }

    // Modal helpers (both modals)
    function openMobileModal(mode){
      const modal = document.getElementById('mobileModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalIntro = document.getElementById('modalIntro');
      if (!modal) return;
      if (mode === 'trustline') {
        modalTitle.textContent = 'Set XRBC Trustline on Mobile';
        modalIntro.innerHTML = 'Trustline setup can only be completed in <strong>Xaman</strong> on your phone. Scan this QR to open the <strong>verified XRBitcoinCash trading page</strong> on mobile, then tap <em>Connect Wallet</em> there to set the trustline.';
      } else if (mode === 'trade') {
        modalTitle.textContent = 'Place Orders in Xaman (Mobile Only)';
        modalIntro.innerHTML = 'For security, order signing happens in <strong>Xaman</strong> on your phone. Scan this QR to open the <strong>verified XRBitcoinCash trading page</strong> on mobile and place your order.';
      } else {
        modalTitle.textContent = 'Open on Mobile to Trade Safely';
        modalIntro.innerHTML = 'XRBC transactions are signed in <strong>Xaman</strong> on mobile. Scan this QR to open the <strong>verified XRBitcoinCash trading page</strong> on your phone and continue safely.';
      }
      renderQr();
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeMobileModal(){
      const modal = document.getElementById('mobileModal');
      if (!modal) return;
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    }

    // NEW: Download modal open/close
    function openDownloadModal(){
      const modal = document.getElementById('downloadModal');
      const iosLink = document.getElementById('dlIosLink');
      const androidLink = document.getElementById('dlAndroidLink');
      if (!modal) return;
      // set store links
      if (iosLink) iosLink.href = XAMAN_IOS_URL;
      if (androidLink) androidLink.href = XAMAN_ANDROID_URL;
      renderDownloadQr();
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeDownloadModal(){
      const modal = document.getElementById('downloadModal');
      if (!modal) return;
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    }

    addEventListener('DOMContentLoaded', () => {
      const closeModalBtn = document.getElementById('closeModalBtn');
      const modal = document.getElementById('mobileModal');
      if (closeModalBtn) closeModalBtn.addEventListener('click', closeMobileModal);
      if (modal) modal.querySelector('.backdrop').addEventListener('click', closeMobileModal);

      // download modal close/backdrop
      const closeDownloadModalBtn = document.getElementById('closeDownloadModalBtn');
      const dlModal = document.getElementById('downloadModal');
      if (closeDownloadModalBtn) closeDownloadModalBtn.addEventListener('click', closeDownloadModal);
      if (dlModal) dlModal.querySelector('.backdrop').addEventListener('click', closeDownloadModal);
    });
  </script>

  <!-- XRPL proxy + trading logic (wallet logic unchanged, plus new Download button handler) -->
  <script>
  (async function () {
    const cfg = JSON.parse(document.getElementById("app-config").textContent);
    const PROXY_URL = cfg.proxyUrl;
    const XRP_TO_DROPS = 1_000_000;

    const XRBC = {
      currency: "5852626974636F696E6361736800000000000000",
      issuer: "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw"
    };

    async function xrplRequest(payload) {
      const res = await fetch(PROXY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Proxy error: " + res.status);
      const data = await res.json();
      if (data.error) throw new Error("XRPL error: " + JSON.stringify(data.error));
      return data;
    }
    const toDrops = (xrp) => Math.round(Number(xrp) * XRP_TO_DROPS).toString();

    async function getLedgerInfo() {
      return await xrplRequest({ method: "ledger", params: [{ ledger_index: "validated" }] });
    }

    async function getXrbcOrderBook() {
      async function fetchSide(taker_gets, taker_pays, sideName) {
        const rows = [];
        try {
          const data = await xrplRequest({
            method: "book_offers",
            params: [{ taker_gets, taker_pays, limit: 5 }]
          });
          if (data.result?.offers?.length) {
            for (const offer of data.result.offers) {
              const gets = offer.TakerGets.value
                ? parseFloat(offer.TakerGets.value)
                : parseFloat(offer.TakerGets) / XRP_TO_DROPS;
              const pays = offer.TakerPays.value
                ? parseFloat(offer.TakerPays.value)
                : parseFloat(offer.TakerPays) / XRP_TO_DROPS;
              const price = pays / gets;
              rows.push(`<tr><td>${sideName}</td><td>${price.toFixed(6)}</td><td>${gets.toFixed(2)}</td></tr>`);
            }
          } else {
            rows.push(`<tr><td>${sideName}</td><td>No offers</td><td>-</td></tr>`);
          }
        } catch (err) {
          rows.push(`<tr><td>${sideName}</td><td>Error</td><td>${err.message}</td></tr>`);
        }
        return rows;
      }
      const asks = await fetchSide(XRBC, { currency: "XRP" }, "Ask");
      const bids = await fetchSide({ currency: "XRP" }, XRBC, "Bid");
      return `
        <div style="max-height:340px;overflow:auto;">
          <table class="table">
            <thead><tr><th>Side</th><th>Price (XRP/XRBC)</th><th>Amount</th></tr></thead>
            <tbody>${asks.join("")}${bids.join("")}</tbody>
          </table>
        </div>
      `;
    }

    // Theme toggle (persisted)
    (function themeInit(){
      const btn = document.getElementById('themeToggle');
      const saved = localStorage.getItem('xrbc-theme');
      if (saved === 'light') document.body.classList.add('light-mode');
      if (btn) {
        const sync = () => btn.setAttribute('aria-pressed', document.body.classList.contains('light-mode') ? 'true' : 'false');
        sync();
        btn.addEventListener('click', () => {
          document.body.classList.toggle('light-mode');
          const mode = document.body.classList.contains('light-mode') ? 'light' : 'dark';
          localStorage.setItem('xrbc-theme', mode);
          sync();
        });
      }
    })();

    // Wallet connect (unchanged)
    const xumm = new Xumm(cfg.xummApiKey);
    const connectBtn = document.getElementById("connectWalletBtn");
    const disconnectBtn = document.getElementById("disconnectWalletBtn");
    const statusEl = document.getElementById("walletStatus");

    function setConnectedUI(acct) {
      statusEl.textContent = "Connected: " + acct;
      window.__xrbcWallet = acct;
      localStorage.setItem("xrbcWallet", acct);
      disconnectBtn.disabled = false;
      connectBtn.disabled = true;
    }
    function setDisconnectedUI() {
      statusEl.textContent = "Status: Not connected";
      window.__xrbcWallet = null;
      localStorage.removeItem("xrbcWallet");
      disconnectBtn.disabled = true;
      if (isMobile) connectBtn.disabled = false;
    }
    async function refreshWalletStatus() {
      try {
        const acct = await xumm.user.account;
        if (acct) setConnectedUI(acct);
      } catch {}
    }

    const savedAcct = isMobile ? localStorage.getItem("xrbcWallet") : null;
    if (savedAcct) setConnectedUI(savedAcct);
    xumm.on("ready", async () => {
      await refreshWalletStatus();
      if (isMobile && !window.__xrbcWallet) connectBtn.disabled = false;
    });
    window.addEventListener("visibilitychange", () => { if (!document.hidden) refreshWalletStatus(); });
    window.addEventListener("focus", refreshWalletStatus);
    [500, 2000, 4000, 8000].forEach(ms => setTimeout(refreshWalletStatus, ms));

    connectBtn.addEventListener("click", async () => {
      if (!isMobile) { openMobileModal('connect'); return; }
      try {
        await xumm.authorize();
        const acct = await xumm.user.account;
        if (acct) setConnectedUI(acct);
        else statusEl.textContent = "Still waiting for Xaman‚Ä¶";
      } catch {
        statusEl.textContent = "Failed to connect wallet";
      }
    });
    disconnectBtn.addEventListener("click", () => { setDisconnectedUI(); xumm.logout(); });

    // === NEW: Download Xaman button logic ===
    const downloadBtn = document.getElementById('downloadXamanBtn');
    function getOS(){
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      if (/android/i.test(ua)) return 'android';
      if (/iPad|iPhone|iPod/.test(ua)) return 'ios';
      return 'other';
    }
    if (downloadBtn){
      downloadBtn.addEventListener('click', () => {
        const os = getOS();
        if (os === 'android'){ window.location.href = 'https://play.google.com/store/apps/details?id=com.xrpllabs.xumm'; return; }
        if (os === 'ios'){ window.location.href = 'https://apps.apple.com/us/app/xaman-wallet/id1492302343'; return; }
        // Desktop: show QR to official download page
        openDownloadModal();
      });
    }

    // Ledger fetch
    document.getElementById("fetchLedgerBtn").addEventListener("click", async () => {
      const ledgerOut = document.getElementById("ledgerOutput");
      ledgerOut.textContent = "Initializing secure connection‚Ä¶";
      ledgerOut.style.color = "#9fb0c5";
      try {
        const info = await getLedgerInfo();
        ledgerOut.style.color = "#a3e4ff";
        ledgerOut.textContent = JSON.stringify(info, null, 2);
      } catch (err) {
        ledgerOut.style.color = "#ef4444";
        ledgerOut.textContent = "Error: " + err.message;
      }
    });

    // Order book
    document.getElementById("fetchPriceBtn").addEventListener("click", async () => {
      const priceOut = document.getElementById("priceOutput");
      priceOut.textContent = "Loading XRBC/XRP order book‚Ä¶";
      try {
        const html = await getXrbcOrderBook();
        priceOut.innerHTML = html;
      } catch (err) {
        priceOut.textContent = "Error: " + err.message;
      }
    });

    // === Trading UI (unchanged from your working version) ===
    const placeOfferBtn = document.getElementById("placeOfferBtn");
    const sideEl   = document.getElementById("side");
    const amountEl = document.getElementById("amount");
    const priceEl  = document.getElementById("price");
    const stopEl   = document.getElementById("stop");
    const tradeMsg = document.getElementById("tradeMsg");
    const buyTab   = document.getElementById("buyTab");
    const sellTab  = document.getElementById("sellTab");
    const totalXrpEl  = document.getElementById("totalXrp");
    const suggestBtn  = document.getElementById("suggestPriceBtn");
    const actionWordEl= document.getElementById("actionWord");
    const orderTypeEl = document.getElementById("orderType");
    const priceField  = document.getElementById("priceField");
    const stopField   = document.getElementById("stopField");
    const tradeCard   = document.getElementById("tradeCard");

    function setSide(side) {
      sideEl.value = side;
      buyTab.classList.toggle("active", side === "buy");
      sellTab.classList.toggle("active", side === "sell");
      buyTab.setAttribute('aria-selected', side === 'buy' ? 'true' : 'false');
      sellTab.setAttribute('aria-selected', side === 'sell' ? 'true' : 'false');
      if (actionWordEl) actionWordEl.textContent = side === 'buy' ? 'buy' : 'sell';
      tradeCard.classList.toggle('buy', side === 'buy');
      tradeCard.classList.toggle('sell', side === 'sell');
      recalcTotals();
    }
    function recalcTotals() {
      const amt = Number(amountEl.value) || 0;
      const px  = priceField.hidden ? (Number(priceEl.value) || 0) : (Number(priceEl.value) || 0);
      const total = (px || 0) * amt;
      totalXrpEl.textContent = (isFinite(total) ? total : 0).toFixed(6) + " XRP";
    }
    [amountEl, priceEl].forEach(el => el.addEventListener("input", recalcTotals));

    (() => {
      const chips = document.querySelectorAll('.quick-amounts .qa');
      chips.forEach(btn => btn.addEventListener('click', () => {
        const pct = Number(btn.dataset.q);
        const current = Number(amountEl.value) || 0;
        const target = current > 0 ? current * (pct / 100) : pct;
        amountEl.value = target.toFixed(6);
        amountEl.dispatchEvent(new Event('input'));
      }));
    })();

    (() => {
      const typeTabs = document.querySelectorAll('.otype-tabs .otype');
      typeTabs.forEach(btn => btn.addEventListener('click', () => {
        typeTabs.forEach(b => { b.classList.toggle('active', b === btn); b.setAttribute('aria-selected', b===btn?'true':'false'); });
        const t = btn.dataset.type;
        orderTypeEl.value = t;
        if (t === 'limit') { priceField.hidden = false; stopField.hidden = true; placeOfferBtn.disabled = false; placeOfferBtn.textContent = 'Place Limit Order'; }
        if (t === 'market'){ priceField.hidden = true;  stopField.hidden = true; placeOfferBtn.disabled = false; placeOfferBtn.textContent = 'Place Market Order'; }
        if (t === 'stop')  { priceField.hidden = false; stopField.hidden = false; placeOfferBtn.disabled = true;  placeOfferBtn.textContent = 'Stop Orders (Preview)'; }
        recalcTotals();
      }));
    })();

    (() => {
      const apply = () => {
        tradeCard.classList.toggle('buy', buyTab.classList.contains('active'));
        tradeCard.classList.toggle('sell', sellTab.classList.contains('active'));
      };
      buyTab.addEventListener('click', () => { setSide('buy'); apply(); });
      sellTab.addEventListener('click', () => { setSide('sell'); apply(); });
      apply();
    })();

    async function fillBestPrice() {
      const side = sideEl.value;
      const amount = Number(amountEl.value);
      if (!amount || amount <= 0) {
        tradeMsg.textContent = "Enter a valid XRBC amount.";
        tradeMsg.classList.remove("ok", "err");
        return;
      }
      tradeMsg.textContent = "üîê Connecting to XRPL for secure best price‚Ä¶";
      tradeMsg.classList.remove("ok", "err");
      tradeMsg.classList.add("connecting");

      try {
        const data = await xrplRequest({
          method: "amm_info",
          params: [{ asset: { currency: "XRP" }, asset2: { currency: XRBC.currency, issuer: XRBC.issuer } }]
        });
        const amm = data.result?.amm;
        if (!amm) throw new Error("No AMM found for XRBC/XRP");

        const reserveXrp  = parseFloat(amm.amount) / XRP_TO_DROPS;
        const reserveXrbc = parseFloat(amm.amount2.value);
        const feeRate     = amm.trading_fee / 1_000_000;
        const k           = reserveXrp * reserveXrbc;

        let effectivePrice;
        if (side === "buy") {
          const newY = reserveXrbc - amount;
          const newX = k / newY;
          let xrpIn = newX - reserveXrp;
          xrpIn += xrpIn * feeRate;
          effectivePrice = xrpIn / amount;
        } else {
          const newY = reserveXrbc + amount;
          const newX = k / newY;
          let xrpOut = reserveXrp - newX;
          xrpOut -= xrpOut * feeRate;
          effectivePrice = xrpOut / amount;
        }

        priceEl.value = Number(effectivePrice).toFixed(6);
        recalcTotals();
        tradeMsg.textContent = `Best price calculated from AMM pool (${side}).`;
        tradeMsg.classList.remove("connecting");
        tradeMsg.classList.add("ok");

        const poolOut = document.getElementById("ammPoolOutput");
        if (poolOut) {
          poolOut.innerHTML = `
            <table class="table">
              <thead><tr><th>Reserve</th><th>Value</th></tr></thead>
              <tbody>
                <tr><td>XRP</td><td>${reserveXrp.toFixed(2)} XRP</td></tr>
                <tr><td>XRBC</td><td>${reserveXrbc.toFixed(2)} XRBC</td></tr>
                <tr><td>Trading Fee</td><td>${(feeRate*100).toFixed(3)}%</td></tr>
              </tbody>
            </table>
          `;
        }
      } catch {
        tradeMsg.textContent = "üîê Still connecting securely to XRPL‚Ä¶";
        tradeMsg.classList.add("connecting");
      }
    }

    if (suggestBtn) suggestBtn.addEventListener("click", fillBestPrice);
    setSide(sideEl.value || "buy");
    recalcTotals();
    setInterval(() => {
      const amt = Number(amountEl.value);
      if (amt > 0) fillBestPrice().catch(()=>{});
    }, 10000);

    placeOfferBtn.addEventListener("click", async () => {
      const orderType = orderTypeEl.value;
      if (orderType === 'stop') {
        tradeMsg.textContent = "Stop orders are UI-only for now.";
        return;
      }
      if (!isMobile) { openMobileModal('trade'); return; }

      try {
        const account = window.__xrbcWallet;
        if (!account) throw new Error("Connect your wallet first.");
        const side   = sideEl.value;
        const amt    = Number(amountEl.value);
        let priceVal = Number(priceEl.value);

        if (orderType === 'market') {
          if (!amt || amt <= 0) throw new Error("Enter valid Amount.");
          await fillBestPrice();
          priceVal = Number(priceEl.value);
          if (!priceVal || priceVal <= 0) throw new Error("Unable to fetch market estimate.");
        } else {
          if (!amt || !priceVal || amt <= 0 || priceVal <= 0) throw new Error("Enter valid Amount & Price.");
        }

        const xrpTotal = priceVal * amt;
        let txjson;

        const TF_SELL = 0x00080000;
        const TF_IOC  = 0x00020000; // ImmediateOrCancel

        if (side === "sell") {
          txjson = {
            TransactionType: "OfferCreate",
            Account: account,
            TakerGets: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amt) },
            TakerPays: toDrops(xrpTotal),
            Flags: (orderType === 'market') ? (TF_SELL | TF_IOC) : TF_SELL
          };
        } else {
          txjson = {
            TransactionType: "OfferCreate",
            Account: account,
            TakerGets: toDrops(xrpTotal),
            TakerPays: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amt) },
            Flags: (orderType === 'market') ? TF_IOC : 0
          };
        }

        tradeMsg.textContent = "Open Xaman to review & sign‚Ä¶";
        const { resolved } = await xumm.payload.createAndSubscribe({ txjson }, (ev) => {
          if (ev?.opened) tradeMsg.textContent = "Payload opened in Xaman‚Ä¶";
          if (ev?.signed === false) tradeMsg.textContent = "Order rejected.";
        });

        const result = await resolved;
        if (!result.signed) { tradeMsg.textContent = "Order not signed."; return; }

        tradeMsg.textContent = "Order submitted. Refreshing order book‚Ä¶";
        const html = await getXrbcOrderBook();
        document.getElementById("priceOutput").innerHTML = html;

      } catch (err) {
        tradeMsg.textContent = "Error: " + err.message;
      }
    });

    // Trustline
    document.getElementById("setTrustlineBtn").addEventListener("click", async () => {
      if (!isMobile) { openMobileModal('trustline'); return; }
      const trustlineMsg = document.getElementById("trustlineMsg");
      trustlineMsg.textContent = "Preparing trustline request‚Ä¶";
      try {
        const account = window.__xrbcWallet;
        if (!account) throw new Error("Connect your wallet first.");
        const txjson = {
          TransactionType: "TrustSet",
          Account: account,
          LimitAmount: { currency: XRBC.currency, issuer: XRBC.issuer, value: "1000000" }
        };
        const payload = await xumm.payload.createAndSubscribe({ txjson }, (ev) => {
          if (ev?.opened) trustlineMsg.textContent = "Payload opened in Xaman‚Ä¶";
          if (ev?.signed === false) trustlineMsg.textContent = "Trustline rejected.";
        });
        const result = await payload.resolved;
        if (!result.signed) { trustlineMsg.textContent = "Trustline not signed."; return; }
        trustlineMsg.textContent = "‚úÖ Trustline set successfully!";
      } catch (err) {
        trustlineMsg.textContent = "Connect your wallet in Xaman (mobile), then try again.";
      }
    });

    // AMM Pool updater
    async function updateAmmPool() {
      try {
        const data = await xrplRequest({
          method: "amm_info",
          params: [{ asset: { currency: "XRP" }, asset2: { currency: XRBC.currency, issuer: XRBC.issuer } }]
        });
        const amm = data.result?.amm;
        const out = document.getElementById("ammPoolOutput");
        if (!amm) { out.textContent = "No AMM pool exists yet."; return; }
        const reserveXrp  = (parseFloat(amm.amount) / XRP_TO_DROPS).toFixed(6);
        const reserveXrbc = parseFloat(amm.amount2.value).toFixed(6);
        const feeRate     = (amm.trading_fee / 10000).toFixed(2); // %
        out.innerHTML = `
          <table class="table">
            <thead><tr><th>Reserve XRP</th><th>Reserve XRBC</th><th>Trading Fee</th></tr></thead>
            <tbody><tr><td>${reserveXrp}</td><td>${reserveXrbc}</td><td>${feeRate}%</td></tr></tbody>
          </table>`;
      } catch (err) {
        document.getElementById("ammPoolOutput").textContent = "Error fetching AMM pool: " + err.message;
      }
    }
    updateAmmPool();
    setInterval(updateAmmPool, 15000);
  })();
  </script>

  <!-- ===== XRBC Footer ===== -->
  <footer class="site-footer" role="contentinfo" aria-label="XRBitcoinCash footer">
    <div class="wrap">
      <!-- (footer unchanged) -->
      <div class="cols" style="display:grid;gap:18px;grid-template-columns:1fr;max-width:var(--wrap-wide);margin:0 auto;">
        <section>
          <h3>About this page</h3>
          <p class="small">
            A minimal, security-first trading &amp; ledger portal for
            <strong>XRBitcoinCash (XRBC)</strong> on the <span class="nowrap">XRP Ledger</span>.
            Signing is handled in <strong>Xaman</strong> on mobile for safer review and execution.
          </p>
          <dl class="factlist" aria-label="XRBC details" style="display:grid;gap:6px;margin:0">
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Symbol</strong><span class="mono">XRBC</span></div>
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Issuer</strong><span class="mono">rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw</span></div>
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Currency Code</strong><span class="mono">5852626974636F696E6361736800000000000000</span></div>
            <div class="fact" style="display:flex;gap:8px"><strong style="min-width:142px;color:#cfe6ff">Total Supply</strong><span class="mono">21,000,000</span></div>
          </dl>
        </section>

        <section>
          <h3>Security measures</h3>
          <ul class="small" style="list-style:disc;margin-left:18px;display:grid;gap:6px">
            <li><strong>Mobile-only signing</strong> via Xaman; desktop shows a QR that opens this verified page on your phone.</li>
            <li>No keys ever requested or stored; only the public account address may be cached (localStorage).</li>
            <li>XRPL calls validated; errors handled; no <span class="mono">eval</span> or dynamic script injection.</li>
            <li>XRBC issuer &amp; currency code are constants; XRP‚Üîdrops conversion is precise.</li>
            <li>AMM helper estimates effective price incl. fee.</li>
          </ul>
        </section>

        <section style="display:grid;gap:10px;justify-items:center;">
          <h3>Whitepaper &amp; credits</h3>
          <a class="eco-link" href="/whitepaper.html" aria-label="Open the XRBitcoinCash Whitepaper" style="min-width:200px;">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"></path>
              <path fill="#ffffff" d="M13 2v5h5"></path>
            </svg>
            Whitepaper
          </a>
          <a class="eco-link" href="https://chat.openai.com/" target="_blank" rel="noopener noreferrer" aria-label="Talk to ChatGPT" style="min-width:200px;">
            <img src="/assets/chatgpt-mark.svg" alt="" onerror="this.remove()">
            <span>Built with ChatGPT</span>
          </a>
          <p class="small" style="margin-top:4px;opacity:.9">
            Verify the URL starts with <span class="mono">https://xrbitcoincash.com</span>.
          </p>
        </section>
      </div>

      <div class="legal small" style="border-top:1px dashed #1f2a37;padding-top:10px;display:flex;flex-wrap:wrap;gap:6px;justify-content:space-between;align-items:center">
        <span>XRBC ¬∑ XRBC/XRP Trading &amp; Ledger Portal</span>
        <span class="mono">Issuer: rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw</span>
      </div>
    </div>
  </footer>
</body>
</html>
