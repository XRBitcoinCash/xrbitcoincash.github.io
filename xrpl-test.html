<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XRBC Test DEX - Serialized</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #xrpl-status { margin-bottom: 10px; font-weight: bold; }
    #orderbook { margin-top: 20px; }
    button { padding: 8px 16px; margin-right: 10px; margin-top: 10px; }
    .row { display: flex; justify-content: space-between; margin-bottom: 4px; }
  </style>
</head>
<body>

<h2>XRBC Test DEX - Serialized</h2>

<div id="xrpl-status">XRPL Node: Connecting…</div>
<button id="connect-wallet" disabled>Connect Wallet (Manual)</button>
<button id="refresh-orderbook">Refresh Orderbook</button>

<div id="orderbook">
  <strong>Orderbook</strong>
  <div id="orderbook-rows">Not loaded</div>
</div>

<script type="module">
import xrpl from 'https://cdn.jsdelivr.net/npm/xrpl@3.2.0/dist/xrpl.mjs';

const XRBC_CODE  = 'XRbitcoincash';
const XRBC_ISSUER= 'rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw';
const MAX_LEVELS = 20;

const statusEl = document.getElementById('xrpl-status');
const connectWalletBtn = document.getElementById('connect-wallet');
const refreshOrderbookBtn = document.getElementById('refresh-orderbook');
const orderbookRows = document.getElementById('orderbook-rows');

let xrplClient = new xrpl.Client('wss://s1.ripple.com');
let lastOrderbook = [];

// Attach events for debugging
xrplClient.on('connected', () => console.log('XRPL WebSocket connected'));
xrplClient.on('disconnected', (code, reason) => console.warn('XRPL disconnected', code, reason));
xrplClient.on('error', (err) => console.error('XRPL error:', err));

// --- Connect XRPL Node ---
async function connectXRPL() {
  try {
    await xrplClient.connect();
    statusEl.textContent = 'XRPL Node: Connected ✅';
    console.log('XRPL node connected successfully');
    connectWalletBtn.disabled = false;
  } catch(err) {
    statusEl.textContent = 'XRPL Node: Connection failed ❌';
    console.error('XRPL connection failed:', err);
  }
}

// --- Load Orderbook ---
async function loadOrderbook() {
  if(!xrplClient.isConnected()) {
    alert('XRPL node not connected');
    return;
  }

  orderbookRows.innerHTML = 'Loading…';

  const req = {
    command: 'book_offers',
    taker_gets: { currency: XRBC_CODE, issuer: XRBC_ISSUER },
    taker_pays: { currency: 'XRP' },
    limit: MAX_LEVELS
  };

  try {
    const res = await xrplClient.request(req);
    const offers = res.result?.offers || [];
    lastOrderbook = offers;
    renderOrderbook(offers);
  } catch(err) {
    console.error('Orderbook request failed:', err);
    orderbookRows.innerHTML = `Error loading orderbook: ${err.message||err}`;
  }
}

// --- Render Orderbook ---
function renderOrderbook(offers) {
  if(!offers || offers.length===0) {
    orderbookRows.innerHTML = 'No offers found';
    return;
  }

  orderbookRows.innerHTML = '';
  offers.forEach(o => {
    let price = o.quality ? Number(o.quality).toFixed(6) : '—';
    let amount = o.TakerGets?.value ? parseFloat(o.TakerGets.value) : (o.TakerGets ? (o.TakerGets/1_000_000).toFixed(6) : '—');
    let side = (o.TakerGets?.currency === XRBC_CODE) ? 'Sell' : 'Buy';

    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `<div>${side}</div><div>${price}</div><div>${amount}</div>`;
    orderbookRows.appendChild(row);
  });
}

// --- Manual Wallet Connection ---
connectWalletBtn.addEventListener('click', async () => {
  alert('Wallet connection would initialize here manually');
});

// --- Manual Orderbook Refresh ---
refreshOrderbookBtn.addEventListener('click', loadOrderbook);

// --- Auto-connect XRPL Node on Page Load ---
window.addEventListener('DOMContentLoaded', async () => {
  await connectXRPL();
});
</script>

</body>
</html>
