<!-- Wallet Section -->
<div class="card glow" style="margin-bottom:24px;">
  <h2 style="margin-top:0;">Wallet</h2>
  <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:16px 0;">
    <button id="connectWalletBtn" class="btn btn-primary glow-btn">Connect Wallet</button>
    <button id="testConnectBtn" class="btn ghost glow-btn">Test Connect (Xaman)</button>
    <button id="disconnectWalletBtn" class="btn btn-secondary glow-btn" disabled>Disconnect</button>
  </div>
  <p id="walletStatus" class="status-text">Status: Not connected</p>
</div>

<script>
/* Test Connect (Xaman OAuth) — uses existing #app-config only */
(() => {
  const testBtn   = document.getElementById('testConnectBtn');
  const statusEl  = document.getElementById('walletStatus');

  function readAppConfig() {
    try {
      const el = document.getElementById('app-config');
      if (!el) return null;
      return JSON.parse(el.textContent || '{}');
    } catch (e) {
      return null;
    }
  }

  function findOAuth(cfg) {
    if (!cfg || typeof cfg !== 'object') return null;

    // Support a few common shapes without guessing/placeholder values
    const o =
      cfg.xaman?.oauth ||
      cfg.xumm?.oauth ||
      cfg.oauth ||
      cfg.xaman_oauth ||
      cfg.xumm_oauth ||
      null;

    if (o?.client_id && o?.redirect_uri) {
      return { clientId: o.client_id, redirectUri: o.redirect_uri };
    }

    // Flat keys (if your #app-config uses these)
    if (cfg.xamanClientId && cfg.xamanRedirectUri) {
      return { clientId: cfg.xamanClientId, redirectUri: cfg.xamanRedirectUri };
    }

    return null;
  }

  function makeAuthUrl({ clientId, redirectUri }) {
    const u = new URL('https://oauth2.xumm.app/auth');
    u.searchParams.set('client_id', clientId);
    u.searchParams.set('redirect_uri', redirectUri);
    u.searchParams.set('response_type', 'token'); // simple test flow
    return u.toString();
  }

  testBtn?.addEventListener('click', () => {
    const cfg   = readAppConfig();
    const creds = findOAuth(cfg);

    if (!creds) {
      statusEl && (statusEl.textContent =
        'Status: Test Connect unavailable — missing Xaman OAuth client_id/redirect_uri in #app-config');
      testBtn.setAttribute('disabled', 'disabled');
      return;
    }

    statusEl && (statusEl.textContent = 'Status: Opening Xaman (Test Connect)…');
    window.location.href = makeAuthUrl(creds); // Desktop: QR; Mobile: deep-links into Xaman
  });
})();
</script>
