<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>XRBitcoinCash · Proxy Wallet Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
   /* === XRBitcoinCash Wallet Connect · Enhanced Dark UI === */
:root {
  --bg: #0b0f14;
  --panel: #121821;
  --panel-2: #141b25;
  --text: #e7edf5;
  --muted: #9fb0c5;
  --accent: #60a5fa;
  --accent-2: #22d3ee;
  --warn: #f59e0b;
  --err: #ef4444;
  --ok: #22c55e;
  --border: #1f2937;
  --ring: #1d4ed8;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}
* { box-sizing: border-box; margin:0; padding:0; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  overflow-x: hidden;
}

/* Floating Orbs */
.orb {
  position: absolute;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, var(--accent-2), transparent 70%);
  opacity: 0.15;
  animation: float 20s linear infinite;
}
.orb:nth-child(1) { width:300px; height:300px; top:10%; left:5%; animation-duration: 28s; }
.orb:nth-child(2) { width:220px; height:220px; top:60%; left:20%; animation-duration: 25s; }
.orb:nth-child(3) { width:280px; height:280px; top:30%; right:10%; animation-duration: 32s; }
.orb:nth-child(4) { width:150px; height:150px; bottom:10%; right:25%; animation-duration: 20s; }
.orb:nth-child(5) { width:200px; height:200px; bottom:20%; left:5%; animation-duration: 22s; }
.orb:nth-child(6) { width:260px; height:260px; top:15%; left:50%; animation-duration: 30s; }

@keyframes float {
  0%   { transform: translateY(0) translateX(0) scale(1); }
  50%  { transform: translateY(-40px) translateX(20px) scale(1.05); }
  100% { transform: translateY(0) translateX(0) scale(1); }
}

/* Layout */
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px 16px;
  position: relative;
  z-index: 5;
}
.row-flex {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  align-items: flex-start;
}

/* Card */
.card {
  background: linear-gradient(180deg, var(--panel), var(--panel-2));
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 16px;
  box-shadow: var(--shadow);
  flex: 1;
  min-width: 260px;
}
.card.glow {
  border-color: var(--accent-2);
  box-shadow: 0 0 20px rgba(34,211,238,.3);
}

/* Buttons */
.btn {
  appearance: none;
  border: 1px solid var(--border);
  background: linear-gradient(180deg, #0e1520, #0c131c);
  color: var(--text);
  padding: 10px 14px;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: transform .06s ease, border-color .2s ease, box-shadow .2s ease;
  min-width: 120px;
  text-align: center;
}
.btn:hover { transform: translateY(-1px); border-color: #2a3a51; }
.btn:active { transform: translateY(0); }
.btn[disabled] { opacity: .6; cursor: not-allowed; }
.btn-primary {
  background: linear-gradient(180deg, rgba(37,99,235,.25), rgba(37,99,235,.15));
  border-color: rgba(37,99,235,.45);
}
.btn-secondary {
  background: linear-gradient(180deg, rgba(34,211,238,.22), rgba(34,211,238,.12));
  border-color: rgba(34,211,238,.45);
}

/* Status */
.status-text {
  font-size: 13px;
  color: var(--muted);
  margin-left: 12px;
}
.status-text.ok { color: var(--ok); }
.status-text.err { color: var(--err); }

/* Ledger info shrink */
pre {
  background: #0c131c;
  border: 1px solid #1c2736;
  border-radius: 10px;
  padding: 8px;
  max-height: 200px;
  overflow: auto;
  font-size: 12px;
  color: #a3e4ff;
}

/* Tables */
.table { width:100%; border-collapse:collapse; font-size:14px; }
.table th, .table td { padding: 8px 10px; border-bottom: 1px solid #1a2433; }
.table thead th { background:#0f1722; color:#cfe2ff; }

/* Responsive */
@media (max-width: 600px) {
  .row-flex { flex-direction: column; }
  .btn { width: 100%; }
}

  </style>
</head>
<body>
  <h1>XRBitcoinCash Wallet Connect (via Proxy)</h1>

  <!-- Wallet connect -->
  <button id="connectWalletBtn" class="btn btn-primary">Connect Wallet</button>
  <p id="walletStatus">Status: Not connected</p>

  <!-- Ledger info -->
  <button id="fetchLedgerBtn" class="btn">Fetch Ledger Info</button>
  <pre id="ledgerOutput">—</pre>

<hr class="div" />

<!-- XRBC ↔ XRP Trade -->
<div class="card" style="max-width:680px;padding:16px;margin:12px 0;">
  <h2 style="margin:0 0 10px;">Trade XRBC ↔ XRP</h2>
  <div class="row" style="gap:10px;margin-bottom:10px;">
    <select id="side" class="input" style="max-width:140px;">
      <option value="sell">Sell XRBC</option>
      <option value="buy">Buy XRBC</option>
    </select>
    <input id="amount" class="input" type="number" step="0.000001" placeholder="Amount (XRBC)" style="max-width:180px;">
    <input id="price" class="input" type="number" step="0.000001" placeholder="Price (XRP per XRBC)" style="max-width:220px;">
    <button id="placeOfferBtn" class="btn btn-primary">Place Offer</button>
  </div>
  <p id="tradeMsg" class="small muted">—</p>
</div>


  
  <!-- Order Book -->
  <button id="fetchPriceBtn" class="btn">Get XRBC/XRP Order Book</button>
  <p id="priceOutput">—</p>

  <!-- Config -->
  <script type="application/json" id="app-config">
  {
    "xummApiKey": "2abde023-0df1-49a2-a4dc-86d776f6318d",
    "proxyUrl": "https://xrbitcoincash-github-io.onrender.com"
  }
  </script>

  <!-- Libraries -->
  <script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
  <script>
  // === Config ===
  const cfg = JSON.parse(document.getElementById("app-config").textContent);
  const PROXY_URL = cfg.proxyUrl;

  // === XRBC constants ===
  const XRBC = {
    currency: "5852626974636F696E6361736800000000000000",
    issuer: "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw"
  };
  const XRP_TO_DROPS = 1_000_000;

  // === Proxy bridge ===
  async function xrplRequest(payload) {
    const res = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error("Proxy error: " + res.status);
    const data = await res.json();
    if (data.error) throw new Error("XRPL error: " + JSON.stringify(data.error));
    return data;
  }


// Drops utils

const toDrops = (xrp) => Math.round(Number(xrp) * XRP_TO_DROPS).toString();

// Guard: ensure wallet is connected
function requireWallet() {
  if (!window.__xrbcWallet) throw new Error("Connect your wallet first.");
  return window.__xrbcWallet;
}

    
  // === Helpers ===
  async function getLedgerInfo() {
    return await xrplRequest({ method: "ledger", params: [{ ledger_index: "validated" }] });
  }

  // === Order Book (dual-sided) ===
  async function getXrbcOrderBook() {
    async function fetchSide(taker_gets, taker_pays, sideName) {
      const rows = [];
      try {
        const data = await xrplRequest({
          method: "book_offers",
          params: [{ taker_gets, taker_pays, limit: 5 }]
        });
        if (data.result?.offers?.length) {
          for (const offer of data.result.offers) {
            const gets = offer.TakerGets.value
              ? parseFloat(offer.TakerGets.value)
              : parseFloat(offer.TakerGets) / XRP_TO_DROPS;
            const pays = offer.TakerPays.value
              ? parseFloat(offer.TakerPays.value)
              : parseFloat(offer.TakerPays) / XRP_TO_DROPS;
            const price = pays / gets;
            rows.push(`<tr><td>${sideName}</td><td>${price.toFixed(6)}</td><td>${gets.toFixed(2)}</td></tr>`);
          }
        } else {
          rows.push(`<tr><td>${sideName}</td><td>No offers</td><td>-</td></tr>`);
        }
      } catch (err) {
        rows.push(`<tr><td>${sideName}</td><td>Error</td><td>${err.message}</td></tr>`);
      }
      return rows;
    }
    const asks = await fetchSide(XRBC, { currency: "XRP" }, "Ask");
    const bids = await fetchSide({ currency: "XRP" }, XRBC, "Bid");
    return `
      <table class="table">
        <thead><tr><th>Side</th><th>Price (XRP/XRBC)</th><th>Amount</th></tr></thead>
        <tbody>${asks.join("")}${bids.join("")}</tbody>
      </table>
    `;
  }

  // === Main logic ===
  (async function(){
    // Wallet connect
    const xumm = new Xumm(cfg.xummApiKey);
    const btn = document.getElementById("connectWalletBtn");
    const statusEl = document.getElementById("walletStatus");
    xumm.on("ready", () => { btn.disabled = false; });
    btn.addEventListener("click", async () => {
      try {
        await xumm.authorize();
        const acct = await xumm.user.account;
        statusEl.textContent = "Connected: " + acct;
        window.__xrbcWallet = acct;
      } catch (err) {
        statusEl.textContent = "Failed to connect wallet";
      }
    });

    // Ledger fetch
    document.getElementById("fetchLedgerBtn").addEventListener("click", async () => {
      const ledgerOut = document.getElementById("ledgerOutput");
      ledgerOut.textContent = "Loading ledger…";
      try {
        const info = await getLedgerInfo();
        ledgerOut.textContent = JSON.stringify(info, null, 2);
      } catch (err) {
        ledgerOut.textContent = "Error: " + err.message;
      }
    });

    // Order book
    document.getElementById("fetchPriceBtn").addEventListener("click", async () => {
      const priceOut = document.getElementById("priceOutput");
      priceOut.textContent = "Loading XRBC/XRP order book…";
      try {
        const html = await getXrbcOrderBook();
        priceOut.innerHTML = html;
      } catch (err) {
        priceOut.textContent = "Error: " + err.message;
      }
    });
 
  // === Trading UI ===
const placeOfferBtn = document.getElementById("placeOfferBtn");
const sideEl   = document.getElementById("side");
const amountEl = document.getElementById("amount");
const priceEl  = document.getElementById("price");
const tradeMsg = document.getElementById("tradeMsg");

placeOfferBtn.addEventListener("click", async () => {
  try {
    const account = requireWallet();
    const side   = sideEl.value;
    const amt    = Number(amountEl.value);
    const price  = Number(priceEl.value);

    if (!amt || !price || amt <= 0 || price <= 0) {
      throw new Error("Enter valid Amount & Price.");
    }

    let txjson;
    if (side === "sell") {
      const xrpTotal = price * amt;
      txjson = {
        TransactionType: "OfferCreate",
        Account: account,
        TakerGets: { currency: "5852626974636F696E6361736800000000000000", issuer: "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw", value: String(amt) },
        TakerPays: toDrops(xrpTotal),
        Flags: 0x00080000 // tfSell
      };
    } else {
      const xrpTotal = price * amt;
      txjson = {
        TransactionType: "OfferCreate",
        Account: account,
        TakerGets: toDrops(xrpTotal),
        TakerPays: { currency: "5852626974636F696E6361736800000000000000", issuer: "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw", value: String(amt) }
      };
    }

    tradeMsg.textContent = "Open Xaman to review & sign…";

    const { resolved } = await xumm.payload.createAndSubscribe({ txjson }, (ev) => {
      if (ev?.opened) tradeMsg.textContent = "Payload opened in Xaman…";
      if (ev?.signed === false) tradeMsg.textContent = "Offer rejected.";
    });

    const result = await resolved;
    if (!result.signed) {
      tradeMsg.textContent = "Offer not signed.";
      return;
    }

    tradeMsg.textContent = "Offer submitted. Refreshing order book…";
    const html = await getXrbcOrderBook();
    document.getElementById("priceOutput").innerHTML = html;

  } catch (err) {
    tradeMsg.textContent = "Error: " + err.message;
  }
});

  
  
  })();
  </script>
</body>
</html>
