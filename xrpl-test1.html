<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>XRBC · Xaman Sign Test (Clean QR / Deeplink)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/xrbc-nft.png" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial; background:#0b0f14; color:#e6edf3; }
    .wrap { max-width: 860px; margin: 0 auto; padding: 24px 16px 56px; }
    h1 { font-size: 22px; margin: 6px 0 12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    .card { border:1px solid #1b2633; background:#0e141b; border-radius: 14px; padding:14px; }
    button { background:#1e90ff; border:0; color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
    button.secondary { background:#2a3646; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size: 13px; opacity: .85; }
    input, select { background:#0b1117; border:1px solid #1b2633; color:#e6edf3; padding:8px 10px; border-radius:10px; }
    .muted { opacity:.85; }
    .ok { color:#9ee493; }
    .err { color:#ff8a8a; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    #qr { max-width:320px; border-radius:12px; border:1px solid #1f2a36; }
    a { color:#9ecbff; }
    .small { font-size: 12px; opacity: .8; }
  </style>
  <!-- Xaman/XUMM browser SDK -->
  <script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>XRBC · Xaman Sign Test (clean QR / deeplink)</h1>
    <p class="muted">No iframes. No overlays. We create a payload, then show QR (desktop) or “Open in Xaman” (mobile).</p>

    <div class="grid">

      <div class="card">
        <h3>1) Wallet Session</h3>
        <div class="row" style="margin:8px 0 10px">
          <button id="connectBtn">Connect Xaman</button>
          <button id="disconnectBtn" class="secondary" disabled>Disconnect</button>
          <span id="walletStatus" class="muted">Status: Not connected</span>
        </div>
        <div class="small">Session persists in your browser (localStorage). You can reload the page.</div>
      </div>

      <div class="card">
        <h3>2) Build Transaction</h3>
        <div class="row">
          <label>Preset:</label>
          <select id="preset">
            <option value="trust">TrustSet (XRBC)</option>
            <option value="buy">OfferCreate · BUY XRBC</option>
            <option value="sell">OfferCreate · SELL XRBC</option>
          </select>
          <label>Amount (XRBC)</label>
          <input id="amount" type="number" step="0.000001" value="100" style="width:120px">
          <label>Price (XRP/XRBC)</label>
          <input id="price" type="number" step="0.000001" value="0.050000" style="width:140px">
          <button id="createBtn">Create Sign Payload</button>
        </div>
        <div id="buildMsg" class="muted" style="margin-top:8px">—</div>
      </div>

      <div class="card">
        <h3>3) Sign</h3>
        <div id="signArea">
          <div id="qrWrap" style="display:none; text-align:center; margin:12px 0;">
            <img id="qr" alt="Scan with Xaman" />
            <div class="small" style="margin-top:8px">Desktop: scan this QR in Xaman.</div>
          </div>
          <div id="openWrap" style="display:none; text-align:center; margin:12px 0;">
            <button id="openBtn">Open in Xaman</button>
            <div class="small" style="margin-top:8px">Mobile: tap to open the sign request.</div>
          </div>
          <pre id="signInfo" class="mono muted" style="white-space:pre-wrap; overflow:auto; max-height:240px;">—</pre>
          <div id="result" class="muted">—</div>
        </div>
      </div>

      <div class="card">
        <h3>Debug</h3>
        <div class="small">
          <div>Issuer: <span class="mono">rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw</span></div>
          <div>XRBC hex: <span class="mono">5852626974636F696E6361736800000000000000</span></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ---- Config ----
    const XUMM_API_KEY = "2abde023-0df1-49a2-a4dc-86d776f6318d"; // your public key (OK in browser)
    const XRBC = { currency: "5852626974636F696E6361736800000000000000", issuer: "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw" };
    const XRP_TO_DROPS = 1_000_000;

    // ---- UI elements ----
    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const walletStatus = document.getElementById("walletStatus");

    const presetEl = document.getElementById("preset");
    const amountEl = document.getElementById("amount");
    const priceEl  = document.getElementById("price");
    const createBtn= document.getElementById("createBtn");
    const buildMsg = document.getElementById("buildMsg");

    const qrWrap = document.getElementById("qrWrap");
    const qrImg  = document.getElementById("qr");
    const openWrap = document.getElementById("openWrap");
    const openBtn  = document.getElementById("openBtn");
    const signInfo = document.getElementById("signInfo");
    const resultEl = document.getElementById("result");

    // ---- Helpers ----
    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    const toDrops = (xrp) => Math.round(Number(xrp) * XRP_TO_DROPS).toString();

    function setStatus(txt, ok=false, err=false){
      walletStatus.textContent = txt;
      walletStatus.classList.remove("ok","err");
      if (ok) walletStatus.classList.add("ok");
      if (err) walletStatus.classList.add("err");
    }

    function requireAccount(){
      const acct = localStorage.getItem("xrbcWallet");
      if (!acct) throw new Error("Connect your wallet first.");
      return acct;
    }

    // ---- XUMM session ----
    const xumm = new Xumm(XUMM_API_KEY);
    let booted = false;

    xumm.on("ready", () => {
      booted = true;
      // restore saved
      const saved = localStorage.getItem("xrbcWallet");
      if (saved) {
        setStatus("Connected: " + saved, true);
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
      } else {
        setStatus("Status: Not connected");
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
      }
    });

    connectBtn.addEventListener("click", async () => {
      try {
        await xumm.authorize();
        const acct = await xumm.user.account;
        localStorage.setItem("xrbcWallet", acct);
        setStatus("Connected: " + acct, true);
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
      } catch (e) {
        setStatus("Failed to connect: " + e.message, false, true);
      }
    });

    disconnectBtn.addEventListener("click", async () => {
      try {
        localStorage.removeItem("xrbcWallet");
        await xumm.logout();
      } catch (e) {}
      setStatus("Status: Disconnected");
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
    });

    // ---- Build txjson from UI ----
    function buildTxjson(){
      const acct = requireAccount();
      const sel = presetEl.value;
      const amt = Number(amountEl.value);
      const px  = Number(priceEl.value);

      if (sel === "trust"){
        return {
          txjson: {
            TransactionType: "TrustSet",
            Account: acct,
            LimitAmount: { currency: XRBC.currency, issuer: XRBC.issuer, value: "1000000" }
          }
        };
      }

      if (!amt || amt <= 0 || !px || px <= 0){
        throw new Error("Enter valid Amount & Price.");
      }

      if (sel === "sell"){
        // SELL XRBC for XRP (tfSell + XRBC value vs XRP drops)
        const xrpTotal = px * amt;
        return {
          txjson: {
            TransactionType: "OfferCreate",
            Account: acct,
            TakerGets: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amt) },
            TakerPays: toDrops(xrpTotal),
            Flags: 0x00080000
          }
        };
      } else {
        // BUY XRBC for XRP
        const xrpTotal = px * amt;
        return {
          txjson: {
            TransactionType: "OfferCreate",
            Account: acct,
            TakerGets: toDrops(xrpTotal),
            TakerPays: { currency: XRBC.currency, issuer: XRBC.issuer, value: String(amt) }
          }
        };
      }
    }

    // ---- Create payload & present QR / Deeplink ----
    createBtn.addEventListener("click", async () => {
      try {
        buildMsg.textContent = "Creating payload…";
        resultEl.textContent = "—";
        qrWrap.style.display = "none";
        openWrap.style.display = "none";
        qrImg.removeAttribute("src");
        signInfo.textContent = "—";

        const payloadReq = buildTxjson();

        // IMPORTANT: we’re using the browser XUMM SDK *with the user session*,
        // so it is allowed to create payloads client-side (no secret here).
        const { created, resolved } = await xumm.payload.createAndSubscribe(
          payloadReq,
          (ev) => {
            if (ev?.opened) buildMsg.textContent = "Payload opened in Xaman…";
            if (ev?.signed === false) buildMsg.textContent = "Request rejected.";
          }
        );

        buildMsg.textContent = "Payload created.";
        // Show QR on desktop OR deeplink on mobile
        const signUrl = created?.next?.always || created?.refs?.deeplink;
        const qrPng   = created?.refs?.qr_png;

        if (isMobile) {
          openWrap.style.display = "";
          openBtn.onclick = () => { window.location.href = signUrl; };
        } else {
          if (qrPng) {
            qrWrap.style.display = "";
            qrImg.src = qrPng;
          }
        }

        signInfo.textContent = JSON.stringify({
          uuid: created?.uuid,
          sign_url: signUrl,
          deeplink: created?.refs?.deeplink
        }, null, 2);

        // Wait for result
        const res = await resolved;
        if (!res?.signed) {
          resultEl.classList.remove("ok"); resultEl.classList.add("muted");
          resultEl.textContent = "Not signed.";
          return;
        }
        resultEl.classList.add("ok");
        resultEl.textContent = "✅ Signed. TX submitted.";
      } catch (e) {
        buildMsg.textContent = "Error: " + e.message;
      }
    });
  </script>
</body>
</html>
