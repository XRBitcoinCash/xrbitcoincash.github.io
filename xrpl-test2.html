<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>XRBitcoinCash · Proxy Wallet Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* === XRBitcoinCash Wallet Connect · Minimal Dark UI === */
:root{
  --bg: #0b0f14;
  --panel: #121821;
  --panel-2: #141b25;
  --text: #e7edf5;
  --muted: #9fb0c5;
  --accent: #60a5fa;          /* primary */
  --accent-2: #22d3ee;        /* secondary */
  --warn: #f59e0b;
  --err: #ef4444;
  --ok: #22c55e;
  --border: #1f2937;
  --ring: #1d4ed8;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

* { box-sizing: border-box }
html, body {
  height: 100%;
  background: radial-gradient(1200px 600px at 80% -10%, rgba(34,197,94,.06), transparent 60%),
              radial-gradient(900px 500px at -10% 80%, rgba(96,165,250,.08), transparent 60%),
              var(--bg);
  color: var(--text);
  font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  margin: 0;
}

.container{
  max-width: 1100px;
  margin: 32px auto;
  padding: 0 16px;
}

.header{
  display: flex; align-items: center; justify-content: space-between;
  gap: 16px; margin-bottom: 18px;
}
.title{
  font-size: clamp(22px, 4vw, 30px);
  letter-spacing:.3px; margin: 0;
  background: linear-gradient(90deg, #fff, #bfe3ff 50%, #8be9ff);
  -webkit-background-clip: text; background-clip: text; color: transparent;
  text-shadow: 0 2px 20px rgba(99,102,241,.1);
}

.grid{
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 16px;
}
.col-4{ grid-column: span 4 }
.col-6{ grid-column: span 6 }
.col-8{ grid-column: span 8 }
.col-12{ grid-column: 1 / -1 }

@media (max-width: 900px){ .col-8, .col-6{ grid-column: 1 / -1 } }
@media (max-width: 680px){ .col-4{ grid-column: 1 / -1 } }

.card{
  background: linear-gradient(180deg, var(--panel), var(--panel-2));
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  box-shadow: var(--shadow);
}
.card h2{ margin: 0 0 10px; font-size: 18px; }
.card .sub{ color: var(--muted); font-size: 14px; margin-top: -6px; }

hr.div{
  border: none; height: 1px; background: linear-gradient(90deg, transparent, #243041, transparent);
  margin: 14px 0;
}

/* Buttons */
.btn{
  appearance: none; border: 1px solid var(--border);
  background: linear-gradient(180deg, #0e1520, #0c131c);
  color: var(--text);
  padding: 10px 14px; border-radius: 12px;
  font-weight: 600; letter-spacing:.2px;
  display: inline-flex; align-items: center; gap: 8px;
  cursor: pointer; box-shadow: var(--shadow);
  transition: transform .06s ease, border-color .2s ease, box-shadow .2s ease;
}
.btn:hover{ transform: translateY(-1px); border-color: #2a3a51; }
.btn:active{ transform: translateY(0); }
.btn[disabled]{ opacity:.6; cursor:not-allowed; }

.btn-primary{
  background: linear-gradient(180deg, rgba(37,99,235,.25), rgba(37,99,235,.15));
  border-color: rgba(37,99,235,.45);
  box-shadow: 0 10px 30px rgba(37,99,235,.15);
}
.btn-primary:hover{ border-color: rgba(37,99,235,.65) }

.btn-secondary{
  background: linear-gradient(180deg, rgba(34,211,238,.22), rgba(34,211,238,.12));
  border-color: rgba(34,211,238,.45);
  box-shadow: 0 10px 30px rgba(34,211,238,.12);
}

/* Status badge */
.badge{
  display:inline-flex; align-items:center; gap:8px;
  font-size: 13px; padding: 6px 10px; border-radius: 999px;
  border:1px solid var(--border); background: #0e1520;
}
.dot{ width:8px; height:8px; border-radius:50%; background: var(--muted); box-shadow: 0 0 10px currentColor }
.badge.ok   .dot{ background: var(--ok) }
.badge.warn .dot{ background: var(--warn) }
.badge.err  .dot{ background: var(--err) }

/* JSON / pre blocks */
pre, code{
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size: 13px;
}
pre{
  background: #0c131c; color: #cfe6ff;
  border: 1px solid #1c2736; border-radius: 12px;
  padding: 12px; overflow: auto; max-height: 420px;
}

/* Tables */
.table{
  width: 100%; border-collapse: collapse; font-size: 14px;
  border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
}
.table th, .table td{
  padding: 10px 12px; text-align: left; border-bottom: 1px solid #1a2433;
}
.table thead th{
  background: #0f1722; color: #cfe2ff; position: sticky; top: 0; z-index: 1;
}
.table tbody tr:hover{ background: rgba(96,165,250,.05) }

/* Inline helpers */
.muted{ color: var(--muted) }
.small{ font-size: 13px }
.right{ margin-left:auto }
.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }

/* Spinner */
@keyframes spin{ to{ transform: rotate(360deg) } }
.spinner{
  width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.15);
  border-top-color: var(--accent); border-radius: 50%;
  display:inline-block; animation: spin .8s linear infinite;
}

/* Inputs */
.input{
  width:100%; padding:10px 12px; color:var(--text);
  background:#0e1520; border:1px solid var(--border); border-radius:10px;
}
.input:focus{
  outline:none; border-color:#2a3a51; box-shadow: 0 0 0 3px rgba(37,99,235,.25)
}

/* Links */
a{ color: var(--accent) }
a:hover{ text-decoration: none; filter: brightness(1.1) }

/* Footer */
.footer{ color: var(--muted); font-size:12px; text-align:center; margin-top: 18px }
</style>

</head>
<body>
  <h1>XRBitcoinCash Wallet Connect (via Proxy)</h1>

<!-- Wallet connect -->
<button id="connectWalletBtn" class="btn btn-primary">Connect Wallet</button>
<p id="walletStatus">Status: Not connected</p>

<!-- Ledger info -->
<button id="fetchLedgerBtn" class="btn btn-secondary">Fetch Ledger Info</button>
<pre id="ledgerOutput">—</pre>

<!-- XRP Price -->
<button id="fetchPriceBtn" class="btn">Get XRP/USD Price</button>
<p id="priceOutput">—</p>

  <!-- Config -->
  <script type="application/json" id="app-config">
  {
    "xummApiKey": "2abde023-0df1-49a2-a4dc-86d776f6318d",
    "proxyUrl": "https://xrbitcoincash-github-io.onrender.com"
  }
  </script>

  <!-- Libraries -->
  <script src="https://xaman.app/assets/cdn/xumm.min.js"></script>

  <script>
  // === Load config ===
  const cfg = JSON.parse(document.getElementById("app-config").textContent);
  const PROXY_URL = cfg.proxyUrl;

  // === Proxy bridge: generic request ===
  async function xrplRequest(payload) {
    const res = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error("Proxy error: " + res.status);
    const data = await res.json();
    if (data.error) throw new Error("XRPL error: " + JSON.stringify(data.error));
    return data;
  }

  // === Helpers ===
  async function getLedgerInfo() {
    return await xrplRequest({ method: "ledger", params: [{ ledger_index: "validated" }] });
  }

  async function getAccountInfo(address) {
    return await xrplRequest({ method: "account_info", params: [{ account: address, ledger_index: "validated" }] });
  }

  async function getServerInfo() {
    return await xrplRequest({ method: "server_info" });
  }

// === Build XRBC/XRP order book ===
async function getXrbcOrderBook() {
  const XRBC = {
    currency: "5852626974636F696E6361736800000000000000", // HEX for XRbitcoincash
    issuer: "rEjwniYhYR5QDZzK1a1x2359j8j8N43Ypw"
  };

  const markets = [
    { code: "XRP" } // only XRBC/XRP for now
  ];

  const rows = [];

  for (const mkt of markets) {
    try {
      const payload = {
        method: "book_offers",
        params: [
          {
            taker_gets: XRBC, // sellers offering XRBC
            taker_pays: mkt.issuer
              ? { currency: mkt.code, issuer: mkt.issuer }
              : { currency: mkt.code },
            limit: 5 // show top 5 offers
          }
        ]
      };

      const data = await xrplRequest(payload);

      if (data.result && data.result.offers && data.result.offers.length > 0) {
        for (const offer of data.result.offers) {
          const gets = offer.TakerGets.value
            ? parseFloat(offer.TakerGets.value)
            : parseFloat(offer.TakerGets) / 1_000_000; // XRP in drops
          const pays = offer.TakerPays.value
            ? parseFloat(offer.TakerPays.value)
            : parseFloat(offer.TakerPays) / 1_000_000;

          const price = pays / gets;
          rows.push(
            `<tr><td>${mkt.code}</td><td>${price.toFixed(6)}</td><td>${gets.toFixed(2)} XRBC</td></tr>`
          );
        }
      } else {
        rows.push(`<tr><td>${mkt.code}</td><td>No offers</td><td>-</td></tr>`);
      }
    } catch (err) {
      rows.push(`<tr><td>${mkt.code}</td><td>Error</td><td>${err.message}</td></tr>`);
    }
  }

  return `
    <table class="table">
      <thead><tr><th>Market</th><th>Price (per XRBC)</th><th>Amount</th></tr></thead>
      <tbody>${rows.join("")}</tbody>
    </table>
  `;
}


  // === Main logic ===
  (async function(){
    // Wallet connect
    const xumm = new Xumm(cfg.xummApiKey);
    const btn = document.getElementById("connectWalletBtn");
    const statusEl = document.getElementById("walletStatus");

    xumm.on("ready", () => {
      console.log("Xumm SDK ready");
      btn.disabled = false;
    });

    btn.addEventListener("click", async () => {
      try {
        await xumm.authorize();
        const acct = await xumm.user.account;
        statusEl.textContent = "Connected: " + acct;
        window.__xrbcWallet = acct;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to connect wallet";
      }
    });

    // Ledger fetch
    const ledgerBtn = document.getElementById("fetchLedgerBtn");
    const ledgerOut = document.getElementById("ledgerOutput");

    ledgerBtn.addEventListener("click", async () => {
      ledgerOut.textContent = "Loading ledger…";
      try {
        const info = await getLedgerInfo();
        ledgerOut.textContent = JSON.stringify(info, null, 2);
      } catch (err) {
        ledgerOut.textContent = "Error: " + err.message;
      }
    });

   // Order book (XRBC vs multiple markets) — uses xrplRequest -> PROXY_URL
const priceBtn = document.getElementById("fetchPriceBtn");
const priceOut = document.getElementById("priceOutput");

priceBtn.addEventListener("click", async () => {
  // Show a quick loading state
  priceOut.textContent = "Loading XRBC order book…";

  try {
    // Assumes you added getXrbcOrderBook() in step 2
    const html = await getXrbcOrderBook();   // <- internally calls xrplRequest(PROXY_URL)
    priceOut.innerHTML = html;                // render the <table> markup
  } catch (err) {
    priceOut.textContent = "Error: " + err.message;
  }
});

  })();
  </script>
</body>
</html>
